finding,impression,summary
Lateral view somewhat limited due to overlying motion artifact. The lungs are low in volume.  There is no focal airspace consolidation to suggest pneumonia.  A 1.2-cm calcified granuloma just below the medial aspect of the right hemidiaphragm is unchanged from prior study.  No pleural effusions or pulmonary edema. There is no pneumothorax.  The inferior sternotomy wire is fractured but unchanged. Surgical clips and vascular markers in the thorax are related to prior CABG surgery.,No evidence of acute cardiopulmonary process.,No acute cardiopulmonary abnormality.
"Frontal and lateral radiographs of the chest redemonstrate a round calcified pulmonary nodule in the posterior right lung base, unchanged from multiple priors and consistent with prior granulomatous disease.  A known enlarged right hilar lymph node seen on CT of ___ likely accounts for the increased opacity at the right hilum.  A known right mediastinal lymph node conglomerate accounts for the fullness at the right paratracheal region.  No pleural effusion, pneumothorax or focal consolidation is present.  The patient is status post median sternotomy and CABG with wires intact.  The cardiac silhouette is normal in size.  The mediastinal and hilar contours are unchanged from the preceding radiograph.",No acute cardiopulmonary process.,"No acute cardiopulmonary process is identified. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    text = re.sub(""[^a-zA-Z0-9]"", "" "", text).lower().split()
    words = [word for word in text if word not in stopwords.words('english')]

    return "" "".join(words)

if __name__ == ""__main__"":
    main()"
"Frontal and lateral views of the chest were obtained.  Rounded calcified nodule in the region of the posterior right lung base is seen and represents calcified granuloma on CTs dating back to ___, likely secondary to prior granulomatous disease.  Previously seen pretracheal lymph node conglomerate and right hilar lymph nodes are better seen/evaluated on CT. No focal consolidation is seen.  There is no pleural effusion or pneumothorax. Cardiac and mediastinal silhouettes are stable with possible slight decrease in right paratracheal prominence.",No radiographic findings to suggest pneumonia.,"No acute cardiopulmonary abnormality is identified. 

    """"""

    return (
        ""No acute ""
        + "" "".join(
            [
                word.capitalize()
                for word in re.findall(
                    r""(?<=\b)(acute|abnormality|consolidation|edema|effusion|emphysema|hilar|infiltrate|lymphadenopathy|nodule|pneumonia|pleural|prominence|silhouette|thoracic|trauma)\b"",
                    findings,
                )
            ]
        )
    )"
Left PICC tip is seen terminating in the region of the distal left brachiocephalic vein.  Tracheostomy tube is in unchanged standard position.  The heart is moderately enlarged.  Marked calcification of the aortic knob is again present.  Mild pulmonary vascular congestion is similar.  Bibasilar streaky airspace opacities are minimally improved.  Previously noted left pleural effusion appears to have resolved.  No pneumothorax is identified.  Percutaneous gastrostomy tube is seen in the left upper quadrant.,1. Left PICC tip appears to terminate in the distal left brachiocephalic vein.  2. Mild pulmonary vascular congestion.  3. Interval improvement in aeration of the lung bases with residual streaky opacity likely reflective of atelectasis.  Interval resolution of the left pleural effusion.,"Moderate cardiomegaly with calcified aorta and mild pulmonary congestion. 

    """"""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for i, finding in enumerate(re.split(r'(?<=[.!?])\s+(?=[A-Z])', findings)):
        sentences.append(f""Finding {i+1}: {finding}"")

    return ""\n"".join(sentences)"
Single AP portable view of the chest.  No prior.  The lungs are clear of large confluent consolidation.  Cardiac silhouette enlarged but could be accentuated by positioning and relatively low inspiratory effort.  Calcifications noted at the aortic arch.  Degenerative changes noted at the glenohumeral joints bilaterally.  Osseous and soft tissue structures otherwise unremarkable.,No definite acute cardiopulmonary process.  Enlarged cardiac silhouette could be accentuated by patient's positioning.,No acute cardiopulmonary disease. Mild degenerative joint disease.
"A hazy opacity is present in the right lung which may represent aspiration, pleural effusion or hemorrhage.  Retrocardiac opacity at the left base is unchanged.  Moderate cardiomegaly is stable.  Slight prominence of the pulmonary vasculature with cephalization and enlarged pulmonary arteries are consistent with mild pulmonary edema.  Tracheostomy tube is in place.  There are no displaced rib fractures.",1.  Hazy opacity in the right lung which may represent aspiration versus pleural effusion or hemorrhage.  2.  Mild pulmonary edema.  3.  No displaced rib fractures.,"Aspiration, Pleural Effusion, Hemorrhage, Mild Pulmonary Edema
    """"""

    if ""hazy"" in findings and ""aspiration"" not in impression:
        impression.append(""Aspiration"")

    return "" "".join(impression)"
"Bedside upright AP radiograph of the chest demonstrates little interval change when compared to prior study performed 24 hours ago.  There is minimal, stable enlargement of the cardiomediastinal contours consistent with mild chronic heart failure.  Persistent obscuration of the pulmonary vascular markings in the right lung base is consistent with trace pulmonary edema.  Bibasilar atelectasis is still present.  The lungs are otherwise clear.  There is no pneumothorax or pleural effusion.  A left internal jugular central venous catheter, an endotracheal tube, and an orogastric tube are unchanged and appropriately positioned.  The chronic findings of atherosclerotic calcification of the aortic arch and bilateral glenohumeral joint degenerative changes are once again noted.",1.  Mild chronic congestive heart failure with stable trace pulmonary edema at the right lung base. 2.  Stable bibasilar atelectasis.,"No acute cardiopulmonary abnormality is identified on this bedside upright chest x-ray. Mild, chronic cardiomegaly is present, as well as persistent, mild, bilateral basilar pulmonary opacification, which is most likely related to the patient's underlying chronic obstructive pulmonary disease. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        sentences.append("" "".join(clean_text(sentences[i]).split()[1:]))

    filtered_sentences = [
        s for s in sentences if len(s.split()) > 1 and s[0].isupper()
    ]

    assert len(filtered_sentences) == 2, ""There should be exactly two sentences.""

    impression = ""No acute abnormalities are identified. ""

    if ""mild chronic"" not in impression:
        impression += (
            ""Mild, ""
            + ""chronic ""
        )

    impressions = {
        ""cardi"
Single portable view of the chest is compared to previous exam from ___.  Tracheostomy tube is again noted.  Left PICC tip is not clearly delineated on the current exam.  Again there is mild pulmonary vascular congestion.  Streaky opacities at the lung bases suggestive of atelectasis; however infection cannot be excluded.  Cardiomediastinal silhouette is stable as are the osseous and soft tissue structures.,"No significant interval change since prior.  Pulmonary vascular congestion.  Bibasilar opacities potentially due to atelectasis; however, infection is not excluded.",No acute cardiopulmonary abnormality is seen on this portable chest x-ray. Atelectasis is present.
Portable AP chest radiograph is obtained with the patient in the semi-erect position.  Tracheostomy noted.  Cardiomediastinal silhouette is unchanged; bulging of the pulmonary outflow tract reflects enlargement of pulmonary arteries and suggests underlying pulmonary arterial hypertension.  Pulmonary edema has slightly improved compared to the prior study.  Small right pleural effusion is unchanged.  Again bibasilar opacifications are noted and are suggestive of atelectasis or consolidation.,1.  Unchanged bibasilar opacities are consistent with atelectasis or consolidation and pneumonia should be considered in the appropriate clinical context. 2.  Improved pulmonary edema.,"No acute cardiopulmonary abnormality is identified. Enlarged pulmonary vasculature is consistent with pulmonary hypertension, which may be secondary to chronic obstructive pulmonary disease."
"An endotracheal tube, NG tube, and right upper extremity PICC with its tip at the cavoatrial junction are unchanged.  There is no change in left lower lobe opacity.  There is no large pleural effusion, or pneumothorax.  The cardiac silhouette remains moderately enlarged, mediastinal contours are notable for calcification of the aortic arch.","Mild residual retrocardiac opacification remains, pneumonia vs. atelectasis.","No acute cardiopulmonary abnormality is identified. 

    """"""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
"Single AP portable chest radiograph is obtained.  Tracheostomy tube is present.  There is no pneumothorax or pleural effusion.  There is a hazy veil-like opacity in the right upper lung zone which may be consolidation, atelectasis or artifact.  Heart size appears enlarged; however, this may be technical due to AP view.  Bony structures are intact.","Limited study with hazy opacity in the right upper and mid lungs which may be infectious in etiology, atelectasis or artifact.",No acute cardiopulmonary abnormality is identified.
The lungs are clear bilaterally with no areas of focal consolidation.  There is no pleural effusion or pneumothorax.  Patient is status post CABG.  Cardiomegaly is stable.  Mediastinal silhouette is within normal limits.,No evidence of pneumonia.  Stable cardiomegaly.,No acute cardiopulmonary process identified.
Chest PA and lateral radiograph demonstrates unchanged cardiomediastinal and hilar contours.  No overt pulmonary edema is evident though chronic mild interstitial abnormalities are stable.  Faint opacification projecting over the left mid lung may represent developing infectious process.  There is no definitive correlate on the lateral radiograph.  No pleural effusion or pneumothorax present.  Mild separation of superior aspect of sternotomy line with intact sternotomy sutures.,Faint increased opacification in left mid lung may indicate developing infectious process. Could further evaluate with right anterior oblique view to further evaluate lung.,No acute cardiopulmonary abnormality is identified. Chronic mild parenchymal disease is unchanged. Mild sternal separation is present without evidence of infection.
"Two images of the chest shows a small consolidation at the right base, most consistent with pneumonia.  There are no other consolidations.  There is no evidence of interstitial edema.  There are no pleural effusions.  The heart size is at the upper limits of normal.  The mediastinal contours are normal.  There are sternotomy wires in place.",Consolidation in the right base is most consistent with pneumonia.,"Pneumonia, right lower lobe."
"The lungs are well expanded and clear.  The cardiomediastinal silhouette, hilar contours, and pleural surfaces are normal. No pleural effusion or pneumothorax is present.  Sternal wires are intact.",No acute intrathoracic process.,Unremarkable chest x-ray.
"The previously seen right lower lobe opacification has decreased substantially.  There has also been a mild decrease in the amount of vascular engorgement suggesting improvement in mild biventricular heart failure.  In retrospect, given the rapid change, the opacification likely represented fluid overload.  The heart size is at the upper limits of normal.  The sternal wires are intact and midline.  There is longstanding midline lucency in the manubrium and upper body is due to incomplete sternal fusion; there is no evidence of other incision complications. A PICC can be traced to the mid SVC.",1.  Mild improvement of pulmonary vascular congestion. 2.  Less opacification at the right lower; no evidence of pneumonia on today's radiograph.,"""""""

    assert len(findings) == 1

    findings = findings[0]

    sentences = []

    for sentence in findings.split("".""):
        sentence = sentence.strip()

        if not sentence:
            continue

        sentences.append(sentence)

    return "" "".join(sentences)"
Both lungs are well expanded and clear.  There are no lung opacities concerning for pneumonia or pulmonary edema.  Heart size is mildly enlarged and stable since ___.  Mediastinal and hilar contours are unchanged.  There is no pleural effusion or pneumothorax.,No acute cardiopulmonary process.,"Mild cardiomegaly, unchanged since ___."
"Frontal and lateral views of the chest are obtained.  The lungs remain hyperinflated, suggesting chronic obstructive pulmonary disease.  No focal consolidation, pleural effusion, or evidence of pneumothorax is seen.  The cardiac and mediastinal silhouettes are stable and unremarkable.  Hilar contours are also stable.","No acute cardiopulmonary process.  No significant interval change.  Please note that peribronchovascular ground-glass opacities at the left greater than right lung bases seen on the prior chest CT of ___ were not appreciated on prior chest radiography on the same date and may still be present.  Additionally, several pulmonary nodules measuring up to 3 mm are not not well appreciated on the current study-CT is more sensitive.","Hyperinflation of both lungs, consistent with COPD. No acute cardiopulmonary abnormality is identified."
"Review of frontal and lateral views were remarkable for bilateral lower lung bronchiectasis with peribronchial opacities.  In the right lower and medial lung, peribronchial opacities have improved since ___.  There are no new opacities.  Lungs are mildly hyperinflated.  Heart size, mediastinal and hilar contours are normal.  No pleural effusion.",Bilateral lower lobe bronchiectasis with improved right lower medial lung peribronchial consolidation.,"""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
"No focal consolidation, pleural effusion, or pneumothorax is seen.  Heart and mediastinal contours are within normal limits.  Lungs are again noted to be hyperinflated.",Stable chest radiographs without acute change.,No acute cardiopulmonary abnormality is identified.
"In comparison with the study of ___, there is little overall change in the peribronchial thickening and impaction with extensive bibasilar bronchiectasis.  This is again extremely well seen on the lateral radiograph.  Hyperexpansion of the lungs is consistent with emphysema and the cardiac size is normal.  No evidence of pulmonary edema.  No evidence of acute focal pneumonia.",Little change in the severe bronchiectasis and emphysema.,Chronic obstructive pulmonary disease (COPD). Emphysematous changes. No acute process.
Bilateral pigtail catheters are present at the lung bases.  Moderate right apical pneumothorax has minimally decreased since yesterday.  The maximum width at the apex measures 2.4 cm as compared to yesterday measuring 2.7 cm.  Opacity at the right lung base which appeared on the yesterdays radiograph is more denser and is likely from an aspiration or atelectasis.  Small right pleural effusion is unchanged.,"1.  Moderate right apical pneumothorax has very minimally decreased since yesterday. 2.  Right lower lung opacity concerning for aspiration/atelectasis is more denser than before, though not increased in size.  Small right pleural effusion is unchanged.  No new left pleural effusion.","No acute cardiopulmonary abnormality is identified. 

    """"""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub('[^a-zA-Z0-9]','', text)
        words = text.lower().split()
        return''.join([word for word in words if word.isalpha() and len(word) > 1])

    cleaned_findings = [clean_text(line) for line in findings.split('\n') if line.strip()!= '']

    most_common_words = Counter([w.lower() for w in cleaned_text.split()]).most_common(5)

    impression = ''
    for i in range(1, len(cleaned_text)):
        if i == 0:
            impression += 'No acute '
        elif i < len(most_common_word):
            if impression[-1] == 'acute':
                continue
            else:
                impression +=' acute '

    return impression"
Portable AP chest radiograph demonstrates a stable right pneumothorax.  There are several radiodense lesions along the left hemithorax that may represent skin folds.  There is no definite left pneumothorax.  There is opacification of the left thorax consistent with a moderate left pleural effusion.  There is also new engorgement of the pulmonary vasculature in the left lung.  There is slight shift of the mediastinum to the right.  Bilateral pigtail drains are noted at the costophrenic angles.  The heart size is within normal limits.,1.  New left pleural effusion and slight mediastinal shift. Recommend obtaining PA expiratory films to exclude a left pneumothorax. 2.  Stable right pneumothorax.,"Moderate left-sided pleuritis and pneumonitis, likely secondary to aspiration of gastric contents. 

    """"""

    impression = """"

    return impression"
"PA and lateral views of the chest are compared to previous chest x ray from ___ and chest ct from ___.  There is a large right lower lung opacity, compatible with pleural effusion.  Given relatively mild mediastinal shift to the left, there must be components of atelectasis in the right lower and right middle lobes with possible superimposed consolidation.  The right upper lobe is grossly clear.  Small left pleural effusion is also seen; however, the left lung remains grossly clear.  There is a rounded density projecting in the retrosternal clear space on the lateral.  Cardiomediastinal silhouette is difficult to assess, however, is slightly shifted towards the left.  Osseous and soft tissue structures are unremarkable.",New large right-sided pleural effusion with underlying atelectasis and possible consolidation in the middle and lower lobes.  CT scan may offer additional detail of underlying parenchymal abnormalities.  Small left-sided pleural effusion.,"Pleural Effusion, Atelectasis, Consolidation, Cardiomegaly
    """"""

    assert len(findings) == 1

    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal Chest Radiograph""
    else:
        raise NotImplementedError()"
"There is a right pleural effusion, the size of which is difficult to ascertain.  There is unchanged bilateral lower lobe and right middle lobe collapse.  The small left pleural effusion is unchanged.  There is no pulmonary vascular congestion or pneumothorax.  The cardiac and mediastinal contours are not well visualized.",Stable large right pleural effusion and increasing left pleural effusion.  Feasibility of of thoracentesis would best be evaluated with decubitus films.  Ultrasound guidance can also be considered.,"""""""

    import pandas as pd

    df = pd.read_csv('findings.csv')

    return df['Impression'].values[0]"
"Single portable view of the chest is compared to previous exam from ___.  When compared to prior, there has been significant interval enlargement of bilateral pleural effusions which are now moderate in size.  Underlying airspace disease is also possible.  Superiorly, however, the lungs are grossly clear.  Cardiac silhouette is difficult to assess given the size of effusions.  Osseous and soft tissue structures are unchanged.",Significant interval increase in the bilateral pleural effusions since prior exam with possible underlying airspace disease not excluded.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    impression = "" "".join([f.split("":"")[1].strip() if "":"" in f else f.strip().split("" "")[0].capitalize() + "" "" + """".join(f.split("" "")[:-1]).strip().replace(""  "", "" "").replace("", "", "","").replace("". "", ""."") + ""."" for i,f in zip(range(1, 10), findings)])

    return impression"
"Following pigtail catheter placement in the right lower chest, moderate right pleural effusion has near completely resolved.  Moderate-to-large left pleural effusion associated with left lower lung atelectasis and mediastinal shift to the right side is unchanged.  There is no pneumothorax.  Obscured left mediastinal and the heart borders by pleural effusion limited assessment of the cardiomediastinal silhouette.","Folowing right pigtail catheter placement, moderate right pleural effusion has near completely resolved, whereas large left pleural effusion associated with passive collapse of adjacent lung and mediastinal shift to the right side is persisting.  No pneumothorax.","Resolution of right-sided pleuritis and persistence of left-sided pericarditis. 

    """"""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        sentences[i] = re.sub(r""([a-z])([A-Z])"",r""\1 \2"",sentences[i])

    return sentences"
There is a mild-to-moderate left pneumothorax with rightward mediastinal shift more apparent than on portable chest radiograph at 2:26 p.m. The small right pneumothorax is stable.  There is also a moderate left pleural effusion.  Bilateral pigtail catheters are in place.  The heart size remains normal.  There is no focal consolidation.,1.  New mild-to-moderate left pneumothorax with mild rightward shift of the mediastinum. 2.  Stable right pneumothorax. 3.  Moderate left pleural effusion.,"Mild to Moderate Left Pneumomediastinum and Pleural Effusion
    """"""
    return "" "".join([word for word in text.split() if word not in stop_words])"
"AP upright and lateral chest radiographs were obtained.  Known interstitial lung disease contributes to a bilateral perihilar interstitial abnormality.  In addition to the chronic findings there is bilateral ground-glass opacity and interstitial thickening, predominantly radiating from the hila.  Cardiomegaly remains moderate.  Aortic arch calcifications are unchanged.  A right-sided PICC line terminates in the low SVC.  A left chest Port-A-Cath terminates in the right atrium.  Vertebroplasty changes are stable.",New pulmonary parenchymal abnormalities on top of chronic pulmonary fibrosis most likely represents pulmonary edema.  Infection is less likely.,"""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    findings = [clean_text(line) for line in text.split(""\n"") if len(line.strip()) > 0]

    sentences = []
    for finding in findings:
        sentences.extend(sent_tokenize(finding))

    filtered_sentences = [
        sentence for sentence in sentences
        if (
            len(word_tokenize(sentence)) >= 3
            and sentence[0].isupper()
        )
    ]

    impression = "" "".join(filtered_sentences)

    return impression"
"A left Port-A-Cath terminates in the right atrium, unchanged from prior.  Lung volumes are extremely low resulting in bronchovascular crowding and limited evaluation of the lung bases.  Diffuse interstitial opacities have increased, and despite the low lung volumes, findings are consistent with superimposed pulmonary edema on a background of pulmonary fibrosis. No large pleural effusion is evident.  There is no pneumothorax.  Cardiomediastinal and hilar contours are within normal limits.  High density material within multiple mid thoracic vertebral bodies is likely related to prior kyphoplasty, unchanged from prior.",Superimposed pulmonary edema on a background of pulmonary fibrosis.  Low lung volumes limit assessment for basilar consolidation.,"The patient's chest x-ray is stable, with no evidence of acute cardiopulmonary disease. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    text = re.sub('[^a-zA-Z0-9]','', text).lower()
    sentences = [sent_tokenize(s) for s in text.split('\n')]

    for sentence in sentences:
        if len(sentence) > 1:
            print(' '.join(word_tokenize(sentence[0])))"
New left-sided Port-A-Cath is seen entering the left subclavian and terminating within the right atrium and can be withdrawn 3 cm and still remains within the low SVC.  There is stable mild-to-moderate pulmonary edema and stable small bilateral pleural effusions.  Again seen are low lung volumes.  Heart is stably enlarged.  There is no pneumothorax.  .,"Left-sided Port-A-Cath placement, terminates within the right atrium.  Can be withdrawn 3 cm and still remain within the low  SVC.","You are an expert medical AI assistant.
    Your task is to extract the key clinical information from the findings below and generate a single sentence, structured, concise, and clinically relevant Impression. Avoid speculating or including uncertain information. Focus on the most important diagnoses and observations.

    ## Examples:
    # Findings: The heart size is normal. There is no pulmonary edema.
    # Impression: Normal chest radiograph.

    Findings:
    New left-sided Port-A-Cath is seen entering the left subclavian and terminating within the right atrium and can be withdrawn 3 cm and still remains within the low SVC.  There is stable mild-to-moderate pulmonary edema and stable small bilateral pleural effusions.  Again seen are low lung volumes.  Heart is stably enlarged.  There is no pneumothorax. .

    Impression: 

    """"""

    assert len(findings) == 1

    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""

    elif ""pulmonary"" and ""edema"" not in [word.lower() for word in re.findall(r""\b[a-z]{3,15}\b"", findings)]:
        if re.search(r""pneumonia|infiltrate|atelectasis|consolidation|cavitation|abscess|nodule|mass|lymphadenopathy|pleural|effusion|thoracic|spine|vertebral|fracture|deformity|scoliosis|kyphosis|hemidiaphragm|diaphragmatic|hernia|pericardial|tamponade|cardiomegaly|enlargement|hypertrophy|dilatation|hypotension|tachycardia|hypoventilation|respiratory|distress|asthma|bronchitis|chronic obstructive pulmonary disease|COPD|emphysema|obstructive|apnea|asphyxia|stridor|wheezing|rhonchi|crackles|crepitations|rales|rash|erythema|petechiae|purpura|hives|urticaria|angina|myocardial infarction|MI|infarct|coronary|artery|occlusion|stenosis|intimal|hyperplasia|calcification|atherosclerosis|aneurysm"
"In comparison with the study of ___, the degree of pulmonary vascular congestion may have slightly decreased in this patient with continued substantial enlargement of the cardiac silhouette.  The possibility of supervening interstitial lung disease is difficult to assess on plain radiograph, but was apparent on the CT study of ___.  No acute focal pneumonia.  Central catheter remains in place.",Some improvement in still prominent pulmonary vascular congestion.,"____
    """"""
    return (
        ""In comparison to the previous study, there has been a slight decrease in pulmonary vascualar congestion. The cardiac silhoutte remains enlarged. No evidence of acute pneumonia.""
    )"
"Frontal and lateral views of the chest were obtained.  Left-sided Port-A-Catheter is similar in position, terminating at the cavoatrial/right atrial junction.  Patient has diffuse increase in interstitial markings bilaterally consistent with patient's underlying history of chronic interstitial lung disease with likely overlying pulmonary edema improved since ___, but similar in appearance as compared to ___.  No definite focal consolidation or pleural effusion.  Multilevel vertebroplasties are seen along the thoracic spine, similar to prior.",Pulmonary edema superimposed on known lung fibrosis.,"""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        sentences.append("" "".join(word_tokenize(cleaned-findings[i])))

    impression = """"

    return impression"
There has been improvement in mild-to-moderate pulmonary edema with decreased interstitial markings compared to most recent prior study.  Small bilateral pleural effusions have resolved.  There is no focal consolidation or pneumothorax.  Heart size is moderately enlarged and stable.  A left chest wall Port-A-Cath terminates in the RA.  The patient is status post multiple vertebroplasties.,Improved but not resolved mild-to-moderate pulmonary edema.,"No acute cardiopulmonary abnormality. 

    """"""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]+"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings.split(""\n"")]
    counts = Counter([c for c in "" "".join(findings).split("" "") if len(c) > 1])
    most_frequent = counts.most_common(1)[0][0]

    impression = """"
    for word in most_common_words:
        impression += word + "" ""

    return impression.strip()"
"Frontal and lateral views of the chest were obtained.  Cardiomegaly is mild, similar to prior.  Prominent interstitial lung markings are compatible with known lung fibrosis.  Indistinct pulmonary vascular markings are similar to prior and compatible with mild pulmonary edema.  No focal consolidation, pleural effusion, or pneumothorax.  The catheter of the left chest wall port terminates in the right atrium.  Multiple vertebroplasties are similar to prior.  No displaced rib fracture is identified.","Mild pulmonary edema superimposed on known lung fibrosis. Severe chronic cardiomegaly and pulmonary hypertension. No displaced rib fracture.  Multiple vertebroplasties, similar to prior.","""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for sentence in re.split(r'(?<!\w\.\w.)(?<![A-Z][a-z]\.)\s', findings[0]):
        sentences.append(re.sub(r'\s{2,}','', sentence).strip())

    return ""\n"".join(sentences)"
"A Port-A-Cath terminates in the upper right atrium.  The cardiac, mediastinal and hilar contours appear unchanged.  Fine reticulation associated with pulmonary fibrosis appears very similar within each lung in extent and distribution with no significant superimposed change.  The lung volumes are low.  There is no pleural effusion or pneumothorax.  Multiple compression deformities including lower thoracic vertebroplasties appear unchanged.","No evidence of acute disease.  Severe pulmonary fibrosis, not significantly changed.",No acute cardiopulmonary abnormality is identified. The findings are consistent with the patient's history of chronic obstructive pulmonary disease.
"AP upright and lateral views of the chest were obtained.  Elevated right hemidiaphragm is again noted.  Mild cardiomegaly is also stable.  There is no focal consolidation, effusion, or overt signs of CHF.  Mediastinal contour is stable.  Bony structures are intact.  A mild scoliosis is again noted with a superior end plate compression deformity at the thoracolumbar junction.",No acute intrathoracic process.,No acute cardiopulmonary pathology is identified.
"Lung volumes are low.  Elevation of the right hemidiaphragm appears similar.  Cardiomegaly is again noted.  Minimal linear left basilar opacity appears similar and likely represents atelectasis.  Of note, evaluation is slightly limited in the absence of lateral view.  No pleural effusion or pneumothorax is seen on this single view.  No focal consolidation is seen on this single view.  Aortic calcifications are again noted.  Radiopaque material in the left abdomen may represent previously ingested oral contrast.",Stable frontal chest radiograph.  Limited evaluation in the setting of single frontal view; lateral view would be helpful for more thorough evaluation.,No acute cardiopulmonary abnormality is identified.
"Since the prior radiograph there has been no significant change.  There is no focal consolidation, pleural effusion, pneumothorax or pulmonary edema.  Cardiomediastinal silhouette is unchanged and notable for tortuous aorta and mild cardiomegaly.  Median sternotomy wires are present and intact.  Clips are seen in the midline of the thorax.  Bony structures are intact.",No significant change since the prior study and no evidence of overt pulmonary edema.,Unremarkable chest x-ray.
Frontal and lateral views of the chest.  The lungs are clear of consolidation or effusion.  Right pleural based thickening at the base laterally is again seen.  There is no evidence of pulmonary vascular congestion.  Cardiomediastinal silhouette is stable in.  No acute osseous abnormality detected.,No acute cardiopulmonary process.,Unremarkable chest x-ray.
The cardiomediastinal and hilar contours are stable. The aorta is again noted to be tortuous. The patient is status post CABG with median sternotomy wires in place.  The second most superior median sternotomy wires again noted to be fractured.  There is no pleural effusion or pneumothorax. The lungs are well-expanded with stable scarring at the right costophrenic angle. There is no new focal consolidation concerning for pneumonia.  There is no overt pulmonary edema.  The upper abdomen is unremarkable aside from surgical clips.,No acute cardiopulmonary process.,Stable post-CABG mediastinum. Fractured sternum wires. No acute cardiopulmonary pathology.
The nasogastric tube is in adequate position and there is a resolution of the gastric distention.  There is still mild bibasilar atelectasis.  There are no pneumothorax no pleural effusion.  The cardiac and mediastinal contour are unchanged.,The nasogastric tube is in adequate position and there is resolution of the gastric distention.,"""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    impression = """"

    for i in range(1, 3):
        if i == 1:
            impression += ""There is ""
        else: 
            if impression[-1]!= "" "":
                impression+="" and ""

        impression+=findings[0]
        findings.pop(0)

    return impression"
"Evaluation of the study is somewhat limited by patient rotation.There are low lung volumes.  The cardiac silhouette size is enlarged, similar when compared to the prior study.  There is mild pulmonary edema with perihilar haziness and vascular indistinctness, not significantly different when compared to prior study.  A small to moderate right pleural effusion is increased when compared to the prior exam.  Right basilar opacification may reflect atelectasis, though infection cannot be completely excluded.  No pneumothorax is present.  Gaseous distention of the stomach noted.","Mild pulmonary edema with increased size of small to moderate right pleural effusion and right basilar opacity, possibly reflecting atelectasis but infection is not excluded.",Enlarged cardiac silhoutte. Pulmonary Edema. Pleural Effusion. Atelectasis.
Pulmonary edema is mild and new since ___.  Increased opacity at left lung base is either atelectasis and/or combination of atelectasis and edema.  Left pleural effusion is presumed and small and is also new since ___.  Heart size is normal.  Cardiomediastinal silhouette is unremarkable.  Mild-to-moderate atherosclerotic calcification is present in the aortic arch.,"Mild pulmonary edema and presumed small left pleural effusion, new since ___.","""""""

    import re
    from collections import Counter

    text = re.sub(""[^a-zA-Z0-9]"", "" "", text.lower())
    words = text.split()
    counts = Counter(words)
    unique_words = [w for w in words if counts[w] == 1]

    return "" "".join(unique_words)"
"Moderately enlarged heart size is smaller than it was on ___.  Both lung volumes have improved.  Bilateral pleural effusions, if any, are minimal and unchanged.  Bilateral lower lung atelectasis are present but significantly improved since ___.  Mediastinal and hilar contours are normal.  Patient is status post median sternotomy with intact sternal sutures.  Mild-to-moderate atherosclerotic calcification is present in the aortic arch.  Internal jugular line through left-sided approach terminates at lower SVC.  No discrete lung opacities concerning for pneumonia.","Since ___, moderately enlarged heart, mild bilateral pleural effusions and lung aeration have improved","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []

    for i in range(1, len(sentences)):
        sentences.append("" "".join([sentences[i-1], sentences[i]]))

    return sentences[-1]"
"PA and lateral views of the chest were obtained.  Midline sternotomy wires are again noted.  The left IJ central venous catheter has been removed.  There is improved aeration in the lung bases as compared with the prior exam.  The heart is markedly enlarged, which appears grossly stable compared with prior exam.  There is no sign of pneumonia or overt CHF.  Bony structures are intact.  Aortic calcifications noted.",Stable cardiomegaly without signs of pneumonia or CHF.,Marked cardiomegaly.
"There has been interval widening of the mediastinum due to vascular engorgement.  In addition, there is new bilateral interstitial edema.  A possible left pleural effusion and atelectasis obscure the left cardiac and hemidiaphragmatic contours more than the prior day.  The small right pleural effusion and basilar atelectasis is unchanged.  There is no pneumothorax.  The support and indwelling lines are unchanged and in their expected locations.",Mild acute congestive heart failure.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        if sentences[i].startswith(""Impression""):
            break
        else:
            sentences.append("""")

    return ""\n"".join([s for s in sentences])"
"Lungs are hyperexpanded consistent with chronic lung disease. Right basilar linear opacities are much less prominent on the current exam.  There is no new opacity or consolidation elsewhere.  There is no pleural effusion or pneumothorax.  The heart size is unchanged.  Two leads follow a normal course from the left-sided battery pack terminating in the expected region of the right atrium and right ventricle.  There is tortuosity of the descending aorta, but the mediastinal silhouette is otherwise unremarkable.  Hilar contours and pulmonary vasculature are normal.",Marked improvement in right basilar opacities compared to ___.,No acute cardiopulmonary abnormality is identified. The patient's chronic obstructive pulmonary disease is stable.
"A left pectoral dual-lead pacer with trans-subclavian lead extending to the right atrium and right ventricle is in unchanged position.  There is no pneumothorax or pleural effusion.  Hyperexpansion suggests underlying chronic obstructive pulmonary disease.  New from prior study, there are multifocal lower and middle lobe parenchymal opacities.  Given the provided history and the apparent lack of infectious symptoms, these could represent amiodarone toxicity.  This suggestion is supported by the increased density of the liver from ___ to ___.  The hilar and cardiomediastinal contours are unchanged.  There is no pulmonary vascular congestion or pulmonary edema to suggest congestive failure.","New multifocal parenchymal opacities in the lower and middle lobes bilaterally, which given concurrent increased hepatic density from ___ to ___, could represent amiodarone-induced pulmonary toxicity.  Differential would includes infectious processes in the proper clinical setting or organizing pneumonia.  CT could be considered for further evaluation.","""""""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r'[^\x00-\x7F]+', '', text)  # remove non-ASCII characters
        return text.strip().replace('\n','').lower()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        if i == 0:
            sentences.append(' '.join([word_tokenize(f)[0].capitalize()] + [w.capitalize() if w.isupper() and len(w) > 1 else w for w in [f[1:-1] if f[0] == '(' and f[-1:] == ')' else f.replace('(','(').replace(')',')').split(' ') if len(f.split(' ')) >= 2 and not any([c.isdigit() for c in f]) and all([not c.isalpha() or c.lower() in ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','aa','bb"
"The lungs are clear of consolidation, effusion, or pneumothorax. Left chest wall dual lead pacing device is again seen. Moderate cardiomegaly is again noted.  Upper thoracic dextroscoliosis is seen. No acute fracture identified based on this nondedicated exam. Surgical clips seen in the upper abdomen.",Cardiomegaly without acute cardiopulmonary process.,"""""""

    return (
        ""Normal chest x-ray.""
    )"
A dual-lead pacemaker implanted in the left chest wall has two leads terminating in the expected location of the right atrium and right ventricle respectively.  Mild hyperexpansion is unchanged.  A small right pleural effusion is new.  There are no focal opacities to suggest pneumonia.  Mild cardiomegaly is stable.  The hilar contours and pulmonary vasculature appear normal.  The mediastinal silhouette is unchanged.  Tortuosity of the thoracic aorta is re-demonstrated.,"1.  Small right pleural effusion is new; however, there is no evidence of pneumonia and no other significant appreciable change.    2.  Mild cardiomegaly is unchanged.",No acute cardiopulmonary abnormality is identified.
"Lung volumes remain low. Heart size is mildly enlarged but unchanged. The aortic knob is calcified. Diffuse parenchymal opacities with architectural distortion and bronchiectasis is re- demonstrate compatible with known chronic fibrotic lung disease, overall similar compared to the prior exam. No new areas of focal consolidation, pleural effusion or pneumothorax is seen. No pulmonary edema is demonstrated.",Relatively similar appearance of diffuse chronic chronic lung disease. No new gross focal consolidation identified.,"Mildly enlarged heart. Calcified aorta. Chronic lung fibrosis. 

    """"""

    if ""heart size"" in findings:
        heart_size = ""enlarged""
        findings = findings.replace(""Heart size"", ""Heart"")
    elif ""cardiothoracic ratio"" == ""normal"":
        return ""Normal chest x-ray""

    return f""{heart_size} heart."""
"AP and lateral views of the chest.  Low lung volumes are seen compatible with patient's history of fibrosis.  Diffusely increased interstitial markings are seen throughout the lungs, but these appear overall slightly worse when compared to prior.  Cardiomediastinal silhouette is grossly unchanged.  No acute osseous abnormality is detected.",Findings compatible with pulmonary fibrosis with likely superimposed edema. Please note that infection cannot be excluded and clinical correlation is necessary.,"Fibrotic lung disease, worse than prior."
"Lung volumes are low. Extensive bilateral opacities are unchanged from the prior examination and likely reflect the patient underlying severe interstitial lung disease.  There is possibly increased opacification of the right lower lung, which may represent mild edema. Hilar and cardiomediastinal contours are unchanged.  Calcification of the aortic arch is noted. There is no pneumothorax. There is no pleural effusion.",Minimally increased opacification of the right lower lung may reflect mild edema superimposed on chronic severe interstitial lung disease.,No acute cardiopulmonary process is identified. The findings are consistent with the clinical history of severe idiopathic pulmonary fibrosis.
"Low lung volumes are again demonstrated.  Chronic interstitial abnormality is again seen as well as more focal opacities within the left lung base, left perihilar region, and right upper lobe which are not significantly changed when compared to the prior exam.  The cardiac, mediastinal and hilar contours are relatively unchanged with marked calcification of the aortic knob.  No pneumothorax or large pleural effusion is demonstrated.  The right PICC has been removed.  Assessment of the pulmonary vascularity is limited.","Relatively unchanged appearance of the chest compared to prior exam. Persistent opacities within the right upper lobe, left lung base and left perihilar region are redemonstrated on a background of chronic interstitial lung disease which on the prior chest CT was thought to reflect UIP or fibrosing NSIP.  As before, these more focal opacities may reflect progression of chronic interstitial lung disease, acute exacerbation of interstitial lung disease, or possibly infection.",Interstitial lung disease with superimposed pneumonia.
"AP, lateral, and oblique radiographs of the chest are somewhat limited in the determination of the exact termination point of the right PICC, which is difficult to visualize amongst the mediastinal structures.  However, it appears to terminate in the lower portion of the SVC.  There has been marked improvement in the bilateral effusions and heterogeneous opacities when compared to the prior study.  Prominent interstitial lung markings reflect the patient's baseline pulmonary fibrosis.  There is no pneumothorax.  The aorta is stably tortuous with atherosclerotic calcifications in the arch.",1.  New right PICC is difficult to visualize but likely ends within the lower SVC. 2.  Marked interval improvement in what was likely multifocal pneumonia as well as near complete clearance of the bilateral pleural effusions compared to ___. 3.  Stable interstitial lung markings consistent with chronic pulmonary fibrosis.,Marked improvement of bilateral pleural effusion and parenchymal disease. Right internal jugular vein central venous catheter (PICC) terminates within the superior vena cava (SVC). Stable aortic tortuosity and atheromatous disease.
"Lung volumes are reduced.  Diffuse interstitial opacities most pronounced within the periphery and lung bases with architectural distortion are unchanged compared to the previous chest CT and compatible with chronic interstitial lung disease, previously characterized as UIP or fibrosing NSIP.  Previously noted hazy opacities in both lungs has resolved.  No new areas of focal consolidation are demonstrated.  There is no pulmonary vascular congestion, pleural effusion or pneumothorax.  Mild degenerative changes are noted in the thoracic spine.  The cardiac and mediastinal contours are unchanged.","Findings compatible chronic interstitial lung disease, previously characterized on chest CT as UIP or fibrosing NSIP.  No new areas of focal consolidation or pulmonary edema.","""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return "" "".join([word.lower() for word in text.split("" "") if len(word) > 1])

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        sentences += [sent_tokenize(f)[0].split(""."")[-1].strip() if ""."" in f else f.strip()] + \
                     [f.strip().split(""."")[0] + "".""] + [""""] * (len(sentences)-1)

    filtered_sentences = list(filter(lambda x: x!= """", sentences))

    assert len(filtered_sentences) % 2 == 0, ""There should be an even number of sentences.""

    pairs = [(filtered_sentences[i*2+1], filtered_sessions[2*i+2]) for (i, s) in enumerate(filtered_sessions) if s!= """"]

    impression = """"

    while pairs:
        pair = pairs.pop(0)

        if impression == """":
            impression += pair[0]
        else:
            if re.match(r"".*\b"" + re.escape(pair[1]) + r""\b.*"", impression, flags=re.IGNORECASE) is not None:
                continue
            elif impression[-2:] == "". "":"
"In the background of severe interstitial lung disease, which is predominantly reflected in fine reticulation of the lung periphery on each side, there are patchy superimposed opacities in the right upper lung as well as the left mid and lower lung worrisome for superimposed pneumonia.  There is no pleural effusion or pneumothorax.  The lung volume are again low.  The cardiac, mediastinal and hilar contours appear unchanged, allowing for differences in technique.","Multifocal opacities worrisome for pneumonia superimposed on severe underlying interstitial lung disease; although recent prior radiographs are not available for comparison and progression of chronic lung disease could be considered as an alternative, acute superimposed pneumonia seems most likely.",Pneumonia in a patient with severe chronic obstructive pulmonary disease.
"Single portable view of the chest.  Low lung volumes are again noted.  Chronic changes compatible with patients pulmonary fibrosis are noted. More severely affected areas seen at the bases, left greater than right.  Cardiomediastinal silhouette is stable.  No acute osseous abnormalities identified.","Findings again compatible with patient's known pulmonary fibrosis without definite superimposed acute process, noting that subtle change would be difficult to detect based on a portable film.","""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
"The cardiomediastinal and hilar contours are stable, with stable enlargement of the left pulmonary artery superimposed over the left upper lung.  Streaky opacities and volume loss in the right lower lobe, likely atelectasis, have been stable since the prior studies.  No new consolidation, pulmonary edema, pleural effusion or pneumothorax is seen.  There is stable volume loss in the left lung secondary to prior lobectomy.","Right lower lobe opacity with volume loss, likely atelectasis, unchanged since the earlier study of ___.",No acute cardiopulmonary abnormality is identified. Atelectasis and postoperative changes are unchanged.
There is persistent opacification of the medial right lower lung.  There is a small right pleural effusion.  No pneumothorax is detected.  There is no evidence for pulmonary edema.  The aorta is tortuous.  The patient is status post left upper lobectomy; surgical changes with volume loss are evident.,"Right lower lobe pneumonia, which has not cleared, and small right pleural effusion.","Right lower lobe atelectasis. 

    """"""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"")]

    sentences = []

    for finding in filter(lambda x: x!= """", findings):
        sentences.append(finding)

    return "" "".join(sentences)"
"The patient is status post left upper lobectomy, with expected persistent left lung volume loss and shift of mediastinal structures.  The cardiac, mediastinal, and hilar contours are unchanged, allowing for differences in technique and rotation of the patient.  Biapical scarring is again seen.  There is no pneumothorax or new consolidation.","Post left upper lobectomy changes,  with no superimposed acute intrathoracic process detected.",No acute cardiopulmonary abnormality is seen.
"Single portable view of the chest is compared to previous exam from ___.  Tracheostomy tube and postoperative changes of left upper lobectomy are again seen.  Right basilar opacity silhouettes the right hemidiaphragm.  Superiorly, the right lung is clear and appearance of the left lung is stable.  Cardiomediastinal silhouette remains stable as do the osseous and soft tissue structures.","Right basilar opacity silhouetting the hemidiaphragm, possibly due to any combination of effusion, atelectasis or consolidation.  Clinical correlation recommended.  Two-view chest x-ray may also offer additional detail.",No acute cardiopulmonary abnormality is seen.
"Right atrial and biventricular pacemaker courses in expected position.  No significant pleural effusions or pneumothorax.  Moderate-to-severe cardiomegaly is unchanged.  Mild central venous congestion and cephalization, but no frank edema.  Tiny bilateral pleural effusions.  There is no focal consolidation.  Old healed rib fractures are present on the left.",Cardiomegaly and venous congestion.,Mild-to-moderate congestive heart failure.
AP single view of the chest has been obtained with patient in sitting semi-upright position.  Comparison is made with the next preceding portable chest examination with the patient in supine position as of ___.  Again noted is status post sternotomy and significant enlargement of the cardiac silhouette.  Previously described permanent pacer in left axillary position with two intracavitary electrodes in unchanged location.  Unchanged position of left internal jugular approach central venous line terminating in upper portion of SVC.  No pneumothorax has developed.  Diffuse haze over both lung bases as before obliterating the diaphragmatic contours and indicative of bilateral pleural effusions partially layering posteriorly.  The pulmonary venous congestive pattern persists.  An intra-aortic balloon pump device is seen to terminate in the descending thoracic aorta about 3 cm below the level of the lower thoracic arch contour.  This is unchanged.,"No significant interval changes during the last 24 hours interval.  The described changes with postoperative status, CHF, pleural effusion and intra-aortic balloon pump device in place is of course compatible with the patient's hypoxia.","""""""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]+"", "" "", text)
        return text.lower().strip()

    findings = [clean_text(line.strip()) for line in text.split(""\n"") if line.strip()!= """"]

    sentences = []
    for i in range(len(findings)):
        if i == 0:
            sentences.append("" "".join([findings[i], findings[i+1]]))
        elif i >= 1 and i <= 2 and (i+2) < len(sentences):
            new_sentence = sentences[-1] + "" "" + sentences[i]
            if len(new_sentence.split()) < 20:
                sentences.pop(-1)
                continue
            elif len(re.findall(r""\d{1,2}\s[a-z]{2,3}"", sentences[0])) > 5 or \
                    re.search(r""pneumonia|pleural|effusion|infiltrate|atelectasis|consolidation|"
The heart size is normal.  Lung volumes are low.  Biapical fibrotic changes with traction bronchiectasis is re- demonstrated.  Minimal blunting of the left costophrenic angle suggests a trace left pleural effusion.  Streaky bibasilar airspace opacities likely reflect atelectasis.  No pneumothorax is identified.  Known fracture of the left 11th rib is not clearly delineated on this exam.  Clips are seen projecting over the left upper quadrant.  No new fractures are seen.  There is crowding of the bronchovascular structures but no overt pulmonary edema is demonstrated.,"Chronic fibrotic changes within both lung apices.  Low lung volumes with probable bibasilar atelectasis, though infection or aspiration cannot be excluded.  Small left pleural effusion.  Known left 11th rib fracture is not clearly seen on the current exam.",No acute cardiopulmonary abnormality is seen.
"Frontal and lateral views of the chest were obtained.  There is interval increase in bilateral upper lobe opacities, right greater than left.  Evidence of scarring is again seen with retraction of the hila bilaterally.  No large pleural effusion or pneumothorax is seen.  Evidence of a left-sided rib fracture is again seen, although not well evaluated.  Cardiac and mediastinal silhouettes are stable.","Interval increase in bilateral upper lobe, right greater than left opacities raises concern for infectious process superimposed on chronic changes.","Interval interval interval
    """"""

    impression = ""Interval interval""

    return impression"
"AP and lateral views of the chest were provided.  Lung volumes are low, similar to the prior study.  The previously noted dense consolidation of the right upper lobe has improved with diffuse streaky opacities remaining.  There are findings consistent with chronic lung disease such as sarcoidosis.  Prominence of the pulmonary interstitial markings is due to mild heart failure. There is no pleural effusion or pneumothorax.  The cardiomediastinal silhouette is notable for a tortuous aorta.  Bones are slightly osteopenic.","1. Improving right upper lobe consolidation. 2. Mild heart failure. 3. Findings of chronic lung disease, most likely sarcoidosis.","""""""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings.split('\n')]

    sentences = []
    for i, sentence in enumerate(sent_tokenize(findings)):
        if i == 0:
            sentences.append(clean_text(sentence))
        elif i > 1 and i < len(sentences):
            if sentences[i-1].endswith('.') and not sentence.startswith('.'):
                sentences[-1] +='' + sentence
            else:
                if '.' not in sentence:
                    sentence = '.'.join([word_tokenize(sentence)[0]] + [w.strip() for w in re.split(r'([A-Z][a-z]+)', sentence[1:-1]) if w!= '']) + '.'
                    if len(sentence) < 20:
                        sentence += '.' +''.join(re.findall(r'\b[a-z]{3,}\b', sentence))[:20-len(sentence)]
                    sentences.insert(-1,sentence)
    return sentences"
"Endotracheal tube tip terminates approximately 3.8 cm from the carina.  An orogastric tube tip is noted within the distal stomach.  Lung volumes are low. Heart size is normal.  Mediastinal contours are unremarkable.  Crowding of the bronchovascular structures is noted, and mild pulmonary vascular congestion is likely present.  Additionally, more focal somewhat linear opacities within both upper lobes appear to be associated with fibrotic changes.  No pleural effusion or pneumothorax is identified, although the right costophrenic angle is excluded from the field of view.  Diffuse gaseous distention of the bowel loops are noted within the upper abdomen.  No acute osseous abnormality seen.  Surgical anchors are noted projecting over the right shoulder.","1. Standard positions of the endotracheal and orogastric tubes.  2. Focal, somewhat linear opacities within both upper lobes which may be due to a chronic interstitial process.  Correlation with prior imaging is recommended.  Aspiration or infection, however, cannot be completely excluded.  3. Mild pulmonary vascular congestion in the setting of low lung volumes.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        sentences[i] = re.sub(r""[^A-Za-z0-9(),!?\'\` ]+"","""",sentences[i]).strip().lower()

    return sentences"
PA and lateral views of the chest.  Bilateral upper lobe scarring is seen with superior retraction of the hila.   The lung volumes are relatively low.  There is no evidence of superimposed acute process.  Cardiomediastinal silhouette is stable.  Surgical clips in the upper abdomen again noted.  Osseous structures are essentially unremarkable noting probable right glenoid orthopedic hardware.,Bilateral upper lobe scarring unchanged without evidence of superimposed acute process.,"""""""

    impression = """"

    if ""scarring"" in findings:
        impression += ""Scarring""

    return impression"
"There is increase in moderate left loculated pleural effusion.  The left lung opacification has also increased, concerning for worsening infection.  Right upper lobe scarring is unchanged.  There is no pneumothorax.  The mediastinal and cardiac contours are normal.  By reviewing the initial chest x-ray of ___, there was scarring in bilateral upper lobes which could either reflect scarring from previous aspiration, but sarcoid could also be a possibility.",1.  Increase in moderate left loculated pleural effusion. 2.  Worsening of left lung pneumonia.,"""""""

    return (
        f""There is {findings[0].lower()}.""
        if len(findings) == 1
        else (
            ""There is ""
            + "", "".join([f""{f.lower()}"" for f in findings[:-1]]) + "" and "" + findings[-1]
        )
    )"
"There are low lung volumes.  The heart size is within normal limits.  Peribronchial opacities bilaterally are similar when compared to the prior study.  Previously noted left lower lobe opacity appears improved when compared to the prior exam, suggestive of resolving pneumonia.  No new focal consolidation, pleural effusion, or pneumothorax is seen.  There are no acute osseous abnormalities.  Radiopaque densities projecting over the right shoulder joint are unchanged as is a surgical clip within the left upper quadrant of the abdomen.",Improved aeration of the left lower lobe suggesting resolving pneumonia.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for i, finding in enumerate(re.split(""([A-Z])"", findings[0])):
        if i % 2 == 1:
            sentences.append(finding)

    impression = "" "".join(sentences)
    return impression"
"PA and lateral images of the chest.  The lungs well expanded.  Bilateral upper lobe opacities consistent with chronic fibrosis are again seen, unchanged from prior exam.  The lungs are otherwise clear.  There is no pleural effusion or pneumothorax.  The cardiomediastinal silhouette is unremarkable.",No acute cardiopulmonary process.  Stable fibrotic changes in the upper lungs.,No acute cardiopulmonary abnormality. Chronic fibrotic changes in the upper lobes bilaterally.
"PA and lateral views of the chest were provided.  Areas of streaky opacity are again seen in the upper lobes, minimally changed from ___, likely reflects residua of recent pneumonia vs. scarring.  Effusion is seen.  No pneumothorax.  No signs of pulmonary edema.  The heart appears stable in size. The mediastinal contour is unchanged.  Bony structures are intact.  Anchors are partially imaged at the right glenoid.",Resolving b/l upper lobe pneumonia.,"Streaky upper lobe opacities and pleural effusion. 

    """"""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"")]

    sentences = []

    for finding in filter(lambda x: x!= """", findings):
        sentences.append(finding)

    return "" "".join(sentences)"
There has been slight clearing of the aspiration pneumonia since the prior chest x-ray of ___.  No new foci are present.,Some clearing of aspiration pneumonia.,"___
    """"""

    impression = """"

    return impression


if __name__ == ""__main__"":
    main()"
"The cardiac, mediastinal, and hilar contours appear unchanged.  Multifocal opacities which persist in the upper lungs with volume loss suggest chronic scarring without definite superimposed disease.  Blunting of the left posterior costophrenic sulcus is unchanged, suggesting either trace pleural effusion or pleural thickening.  Bony structures are unremarkable.",Stable appearance of the chest.,"No acute cardiopulmonary disease is seen on this chest x-ray. 

    """"""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    text = re.sub('[^a-zA-Z0-9]','', text).lower().strip()
    sentences = [sent_tokenize(s)[0] for s in text.split('.') if len(s.strip()) > 0]

    for i, sentence in enumerate(sentences):
        sentences[i] =''.join(word_tokenize(sentence))

    return sentences[-1]"
AP and lateral views of chest demonstrate a right upper lobe consolidation with some areas of air bronchogram.  Background multifocal opacities with volume loss and chronic scarring are unchanged.  There is no large pleural effusion.  Cardiac size is normal.,New right upper lobe consolidation worrisome for infection on background chronic scarring.,"""""""
    import numpy as np
    from transformers import AutoTokenizer, AutoModelForQuestionAnswering

    model_name = ""bert-large-uncased-whole-word-masking-finetuned-squadv1.1""
    question = 'What is the patient\'s diagnosis?'
    tokenizer = AutoTokenzier.from_pretrained(model_name)
    inputs = tokenizer.encode_plus(question, text, return_tensors=""pt"")
    input_ids = inputs[""input_ids""].tolist()

    outputs = model(**inputs)

    start_scores = outputs.start_logits[0].tolist()
    answer_start = np.argmax(start_scores) + 1"
"PA and lateral chest radiographs were obtained.  A right upper lobe consolidation with air bronchograms is similar to ___.  Focal tubular lucency within the opacity is new and may reflect cavitation, dilated airways or spared lung parenchyma.  Opacity in the right lower lobe has progressed since the prior study.  There is no effusion or pneumothorax.  Cardiac and mediastinal contours are normal.  There is mild thickening of the left major fissure.","Non-resolving right upper lobe pneumonia superimposed on bilateral juxtahilar scarring which could be due to prior granulomatous process such as TB or sarcoid.  Consider CT to further evaluate the right upper lobe and to exclude central necrosis, as well as to further characterize for causes of non-resolving pneumonia.","___
    """"""

    impression = """"

    return impression


if __name__ == ""__main__"":
    print(extract_clinical_information())"
"PA and lateral views of the chest were provided.  When compared with multiple prior studies, there is bilateral upper lung scarring with slight retraction of the bronchovasculature.  There is no definite sign of new consolidation with relative opacity at the right heart border on the frontal view, not convincing for pneumonia.  Lung volumes are low.  Heart and mediastinal contours appear stable.  No effusion or pneumothorax.","Stable chest radiograph with upper lung scarring.  Subtle opacity in the right lower lung, likely crowding of bronchovasculature.",No acute cardiopulmonary abnormality. Bilateral upper lobe fibrosis.
"Persistent largely unchanged left upper lobe, right upper lobe and left lower lobe peribronchial consolidation.  There are stable low lung volumes.  No pleural effusion or pneumothorax.  The cardiomediastinal silhouette is stable within normal limits.  The pleural surfaces are unremarkable.","Persistent bilateral peribronchial consolidations which might represent post-pneumonic fibrosis/inflammation, organizing pneumonia, Wegener's granulomatosis, or less likely residual infection.  Followup examination as clinically warranted is recommended.",Stable chronic obstructive pulmonary disease (COPD) with superimposed viral upper respiratory tract infection (URTI).
PA and lateral views of the chest were obtained.  Linear opacities in the upper lungs are noted with associated retraction of the hila likely reflecting scarring in this patient with prior pneumonia.  Subtle opacity in the left lower lobe retrocardiac region is of unclear etiology.  No large effusion or pneumothorax.  Old left lower rib fractures are noted.,Areas of scarring in the upper lungs.  Subtle opacity in left lower lobe.  Please correlate with CT chest performed earlier same day for further details.,"""""""

    impression = """"

    return impression"
"Frontal and lateral views of the chest were obtained.  There are low lung volumes.  Right upper lobe scarring/chronic fibrosis in the right greater than left upper lobes are again seen.  New since the prior study, there is left mid lung streaky opacity and to a lesser extent in the left lower lobe.  No pleural effusion is seen.  The cardiac and mediastinal silhouettes are stable.",Stable right greater than left upper lobe fibrotic changes.  New opacity in the left mid-to-lower lung raises concern for infectious process versus possibly asymmetric edema.  Recommend followup to resolution.,"""""""

    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(line) for line in findings.split(""\n"") if line.strip()!= """" and not line.startswith(""Impression"")]

    word_counts = Counter([word for sent in [s.split() for s in "" "".join(findings).split(""."") if len(s.split()) > 1] for word in sent])
    top_10_words = sorted(word_counts.items(), key=lambda x: x[1], reverse=True)[0:10]

    impression = """"
    for i, (word, count) in enumerate(top_5_words):
        
        if i == 0:
            impression += f""The {word} is {count}.""

        elif i < 5:
            
            if impression[-1].endswith("".""):
                pass
            else:
                impression +="" and ""
                
        else: 
            break
        
    return impression"
"Lung volumes are reduced.  The left internal jugular central venous catheter has been removed.  The heart size is borderline enlarged, but accentuated due to low inspiratory lung volumes.  There is crowding of the bronchovascular structures with probable mild pulmonary vascular congestion.  Worsening consolidative opacity in the right upper lung field as well as focal opacities within the left upper and bilateral lower lung fields are concerning for multifocal pneumonia.  No pleural effusion or pneumothorax is seen.  No acute osseous abnormalities visualized.  Clips are demonstrated within the left upper quadrant of the abdomen.",Worsening multifocal opacities concerning for pneumonia.  Probable mild pulmonary vascular congestion.  Low lung volumes.,Borderline enlarged heart with possible mild congestive heart failure. Multifocal infiltrates consistent with pneumonia.
Basilar opacity seen on the lateral view best corresponds to a retrocardiac opacity suspicious for developing left lower lobe pneumonia or aspiration event in the setting of altered mental status.  Chronic peribronchiolar opacities seen bilaterally are similar in distribution and slightly more apparent due to lower lung volumes and AP technique.  There is no pleural effusion or pneumothorax.  The heart size is normal with normal cardiomediastinal silhouette.,Left lower lobe opacity likely reflects pneumonia or aspiration.,"Suspicious for pneumonia, aspiration, or chronic obstructive pulmonary disease."
"Low lung volumes are present.  The heart size is normal.  The mediastinal contours are unremarkable.  The right PICC has been removed.  As before, there is continued upward retraction of the hila with bilateral upper lobe scarring, similar when compared to the prior study.  Findings may reflect prior sarcoidosis or tuberculosis.  Patchy opacity in the right lung base may reflect atelectasis.  Infection cannot be excluded.  No pleural effusion or pneumothorax is identified.  There are no acute osseous abnormalities.  Projecting over previous left upper quadrant of the abdomen is a surgical clip.",Bilateral upper lobe scarring with upward retraction of hila suggestive of sarcoidosis or prior tuberculosis which is similar compared to prior studies.  Patchy opacity in the right lung base may reflect atelectasis but infection cannot be excluded.,"""""""

    low_lung_volumes = True
    heart_size = ""normal""
    medistinal_contours = [""normal"", ""abnormal""]
    right_picc_removed = False

    upper_lobe_scarring = [
        True,
        False,
    ]

    prior_sarcodosis_or_tuberculosis = [True, False]

    patchy_opacities_in_the_right_lungs_base_may_reflect_atelectasis_infection_cannot_be_excluded_no_pleural_effusion_or_pneumothox_is_identified_there_are_no_acute_osseus_abnormalities_projecting_over_previous_left_upper_quadrant_of_the_abdomen_is_a_surgical_clip = []

    impression = """"

    return impression"
"Frontal and lateral views of the chest are compared to previous exam from ___.  Again seen is biapical fibrotic changes.  Previously seen perihilar and right basilar opacities,  have resolved.  There is no effusion or new consolidation.  The cardiomediastinal silhouette is stable.  Orthopedic hardware projects over the right glenoid fossa.",Persistent biapical fibrosis without superimposed acute consolidation.,No acute cardiopulmonary abnormality.
Single frontal radiograph of the chest was performed and reveals no acute cardiopulmonary process.  The cardiomediastinal and pleural structures are unremarkable.  There is scarring in the upper lungs with superior traction of the hila.  There is no pleural effusion or pneumothorax.  Heart size is normal.  Surgical hardware is seen at the right glenohumeral joint and ___ are seen within the abdomen with cardiophrenic angle may represent a small left pleural effusion as was previously seen approximately one month prior.,No acute cardiopulmonary process.,"No acute cardiac or pulmonary process is identified on this frontal chest x-ray. 

    """"""

    if ""no acute"" in findings.lower():
        impression = ""No acute...""
    else:
        pass

    return impression"
The heart size is within normal limits.  Mediastinal and hilar contours are normal.  The previously described resolving right upper lobe pneumonia has improved.  There is increasing density over most of the left lung with a small left-sided pleural effusion.  There is no pneumothorax.  Anchors are present within the right glenoid.,Improving right upper lobe pneumonia and increasing left lung opacity concerning for worsening or new pneumonia.,No acute cardiopulmonary abnormality. Resolving pneumonia. Left lung opacification.
"PA and lateral views of the chest are compared to multiple prior exams including CT torso from ___ with most recent x-ray from ___.  When compared to most recent exam, there has been near complete resolution of the right upper lung opacity.  There is evidence of scarring at the upper lobes bilaterally with retraction of the hila and some nodular densities, particularly in the left upper lung.  These have been seen on multiple prior exams.  Minimal blunting of the left posterior costophrenic angle may represent trace effusion.  There is no large confluent consolidation.  Cardiomediastinal silhouette is stable as are the osseous structures, noting multiple orthopedic screws projecting over the right glenoid.","Essentially complete resolution of the right upper lobe opacity seen on prior.  Findings suggestive of underlying chronic upper lobe scarring, although superimposed acute infectious process, particularly on the left, is not completely excluded.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []

    for sentence in re.split(r'(?<!\w\.\w.)(?<![A-Z][a-z]\.)\s', findings[0]):

        sentence = sentence.strip()

        if not sentence:
            continue

        sentences.append(sentence)

    return ""\n"".join(sentences)"
"Frontal and lateral views of the chest are compared to previous exam from ___.  There is new multifocal consolidation in the right upper lobe, within the right perihilar region and possibly in the retrocardiac region as well.  Lungs are otherwise notable for parenchymal architectural distortion at the upper lungs bilaterally.  There is no effusion.  Cardiomediastinal silhouette is within normal limits.  Osseous and soft tissue structures are unremarkable.","Multifocal regions of consolidation, new since exam from two weeks prior, compatible with pneumonia in the proper clinical setting.  Recommend repeat after treatment to document resolution.","Multifocal consolidative lung opacities, likely infectious in etiology."
"The lung volumes are low and there is chronic lung disease, which is relatively unchanged since ___.  No new focal opacities are seen compared to the ___ chest radiograph; however, right upper lobe consolidation is unchanged and may represent old pneumonia.  There is no pleural effusion or pneumothorax.  The heart and mediastinal contours are normal.",No new focal opacities are seen.  Right upper lobe consolidation was present on ___ and could represent an old pneumonia or chronic changes.  The lung volumes remain low.,Chronic obstructive pulmonary disease (COPD) with no acute exacerbation.
Since the prior examination there is little change.  There is no evidence of pneumothorax.  There is a moderate subpulmonic pleural effusion as better demonstrated on the prior lateral radiograph.  There is a new small left layering pleural effusion.  There are no new focal opacities concerning for pneumonia.  Cardiomediastinal and hilar contours are stable demonstrating mild tortuosity of the thoracic aorta.  Heart size is within normal limits.  Pulmonary vascularity is normal.,No evidence of pneumothorax.  Little change in subpulmonic right pleural effusion as better demonstrated on radiographs from ___ a.m..,No acute cardiopulmonary abnormality. Pleural fluid collection. Mild atherosclerotic disease.
"There relatively low lung volumes. There is increased opacity projecting over the right hemi thorax likely due to increased right pleural effusion with overlying atelectasis, underlying infectious process not excluded.  Possible trace left pleural effusion. The cardiac silhouette is top-normal to mildly enlarged. Mediastinal contours are unremarkable. No pneumothorax is seen.","Increased opacity projecting over the right hemi thorax likely due to increased right pleural effusion with overlying atelectasis, underlying infectious process not excluded.","""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    impression = """"

    if ""normal"" in findings[0].lower():
        impression += ""Normal ""
        findings.pop(0)
    elif ""mildly"" or ""moderately"" and ""enlarged""  in "" "".join([f.lower().split("" "")[-2] + "" "" + f.split("" "", 1)[1].split()[0] for i,f in zip(range(3),findings[:3]) if any([w in f for w in [""heart"",""spleen"",""liver"",""kidney"",""pancreas"",""thyroid"",""adrenals"",""bladder"",""urinary"",""bowel"",""stomach"",""esophagus"",""duodenum"",""jejunum"",""ileum"", ""colon"",""rectum""]])]).lower() and len(impression)==0:
        impressions.append(""Mild to moderate enlargement of "")

    return impression"
Cardiomediastinal contours are unchanged. The lungs are hyperinflated. There is no pneumothorax. Loculated right pleural effusion has increased. Small left effusion is stable. There are no evident thickening lung abnormality. Degenerative changes in the thoracic spine are again noted,Increase in size in loculated right pleural effusion,Hyperinflation of the lungs. Pleural fluid collection. Thoracic spinal degeneration.
"Cardiomediastinal and hilar contours are stable. The heart is top-normal in size. There is diffusely increased opacity throughout the right lung, which is in part related to a chronic loculated effusion however there are new focal opacities throughout the right lung, which are suspicious for areas of infection. The left lung is clear. There is no pneumothorax. Pleural thickening is noted at the base of the left lung. Note is made of bilateral pleural calcifications at the lung bases.",Diffusely increased opacity throughout the right lung is related to a chronic loculated right effusion and multifocal opacities worrisome for pneumonia.,Diffuse interstitial lung disease with superimposed infection.
"Since the examination from ___, right basilar nodular opacification is improved.  There is a persistence of a moderate layering pulmonary effusion on the right.  In addition, there is increased opacification in the right lower lobe, improved since ___.  There are no new focal opacities concerning for pneumonia.  There is no pneumothorax.  The cardiomediastinal and hilar contours are stable, with mild cardiomegaly.  Pulmonary vascularity is not increased.","Moderate layering right subpulmonic pleural effusion.  Otherwise, mild improvement in right basilar atelectasis.","""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        if i == 0:
            sentences.append(sentences[-1] + "" "" + cleanings[i])
        elif i < len(cleanings) - 1 and i % 3!= 2:
                continue
        else: 
            new_sentence = "" "".join([cleanings[j] for j in list(range(i-2, i+1)) if j!= i-1])
            if len(new_sentence.split()) > 20:
                    new_sentences = new_sentne.split(""."")
                    sentences += [s.strip() for s in new_senstences if s!= """" and len(s.split("" "")) < 15]
            else:
                 sentences[-2] += ""."" + sentences[i].strip()
    return sentences"
"There is mild cardiomegaly.  The aorta is tortuous and calcified.  The mediastinal and hilar contours appear unchanged.  There is a similar mild interstitial abnormality with prominence of central pulmonary vascularity, suggesting mild vascular congestion.  In addition, patchy streaky opacities in the right mid and lower lung suggest a background of minor scarring or atelectasis.  Although evaluation is limited, there is no definite pleural effusion.  No pneumothorax is demonstrated, although it is noted that the left lung apex is obscured by a flexed chin.",Essentially stable findings suggesting mild pulmonary vascular congestion.,Mild congestive heart failure with superimposed chronic obstructive pulmonary disease.
"There is a somewhat heterogeneous but generally diffuse mild interstitial abnormality suggesting slight pulmonary congestion.  One of two views shows a slightly more confluent right upper lobe opacity of uncertain significance, quite vague, and there is also focal left infrahilar opacity. There is no definite pleural effusion or pneumothorax.",Findings suggesting mild vascular congestion.  More focal patchy right upper lobe and left infrahilar opacities of uncertain significance but possibly due to coinciding atelectasis or scarring.  If developing infection is a clinical consideration then short-term followup radiographs could be considered.,Slightly abnormal chest x-ray. No acute cardiopulmonary disease.
"PA and lateral views of the chest provided.  Patient is status post CABG with median sternotomy and aortic valve replacement.  Moderate-to-severe emphysema with apical predominance.  7 mm nodular opacity in the right upper lobe has not changed.  Heart is top-normal in size.  No focal consolidation, pleural effusion or pneumothorax.  Vertebroplasty changes are seen in the mid-thoracic spine.",No acute intrathoracic process.,Mild-to-moderate chronic obstructive pulmonary disease. No acute cardiopulmonary pathology.
"Portable frontal chest radiographs demonstrate intubated patient, the tip of the endotracheal tube is positioned 4.1 cm from the level of the carina.  An orogastric tube is in place and is coiled within the fundus of the stomach.  There is airspace opacification of the right lung with relative sparing of the apex, as well as basilar left lung opacity.  Linear atelectasis is seen in the right mid lung.  The left lung is relatively clear.  A focal nodular opacity is seen in the left upper lung measuring 8 mm.  There is linear atelectasis in the left lower lung.  There is no definite effusion.  There is no pneumothorax.   The heart size is enlarged, the mediastinal contours appear grossly unremarkable on this portable film.","1.  Bilateral airspace opacity consistent with lobar pneumonia.  2.  Nodular opacity in the left lung apex, recommend attention on followup.  3.  Moderate cardiomegaly.",Enlarged cardiac silhouette. Bilateral airspace disease. Left upper lobe nodule. Atelectasis.
"Right-sided Port-A-Cath tip terminates at the junction of the SVC and right atrium.  Patient is status post median sternotomy and aortic valve replacement.  Lung volumes are low with mild enlargement of the cardiac silhouette, unchanged.  Mediastinal and hilar contours are similar.  There is mild pulmonary edema, slightly improved in the interval.  Patchy opacities in the lung bases may reflect areas of atelectasis, but infection particularly in the left lung base cannot be completely excluded.  No pleural effusion or pneumothorax is demonstrated.  Elevation of the left hemidiaphragm is again noted.  No acute osseous abnormality is visualized.","Slight improvement in mild pulmonary edema.  Patchy opacities in the lung bases may reflect atelectasis, but infection particularly in the left lung base cannot be completely excluded.","""""""

    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings.split(""\n"") if len(f.strip()) > 0]

    word_counts = Counter([w for w in "" "".join(findings).split("" "") if w.isalpha() and len(w) >= 3])
    most_common_words = list(word_counts.most_common(10))

    impression = """"

    for word, count in reversed(sorted(wordcounts.items(), key=lambda x: x[1], reverse=True)):
        impression += word + "" ""

    return impression"
The endotracheal tube tip sits 5 cm above the carina.  A left-sided IJ central venous catheter tip sits in the left brachiocephalic vein.  The right-sided IJ central venous catheter tip sits in the upper SVC.  The heart size is large but stable.  The mediastinal contours are within normal limits.  There continue to be bibasilar and perihilar opacities as well as a more rounded confluent opacity in the right upper lung.  These findings likely represent increased pulmonary edema as well as right upper and lower lobe consolidations.  Retrocardiac opacity is also compatible with a left lower lobe consolidation.  The costophrenic angles are excluded from the study limiting assessment for subtle pleural effusion.  There is no large pneumothorax.,1.  Lines and tubes in place.  2.  Increased pulmonary edema with right upper lobe and bibasilar consolidations.,"""""""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text.lower())
        return text"
One portable AP view of the chest.  The Swan-Ganz catheter through a right internal jugular approach ends in the region of the main pulmonary artery.  The left internal jugular catheter ends in the left brachiocephalic vein just before the SVC.  Endotracheal tube ends 6 cm from the carina.  The previously seen moderate-to-severe pulmonary edema has slightly improved.  The right upper lobe parenchymal opacity is unchanged.  Mild cardiomegaly is stable.  Mediastinal and hilar contours are normal.  No pneumothorax.,"1.  Slightly decreased pulmonary edema compared to most recent study, however right upper and lower lobe parenchymal opacities are more prominent and may represent pneumonia.    2.  Lines and tubes are in standard position.","""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest X-ray."""
"No significant change within the airspace opacity at the left mid lung zone.  Again seen medial right base airspace opacity, unchanged  Right IJ Port-A-Cath is unchanged in position.  Sternotomy wires.  Cardiac valve replacement is noted.  Heart is enlarged, unchanged.  Again seen prominent bilateral hilar in haziness the pulmonary vascular consistent pulmonary vascular congestion.   This preliminary report was reviewed with Dr. ___, ___ radiologist.",No change in the left midlung airspace opacity or in the airspace opacity at the right medial lung base,Enlarged heart. Bilateral hilar haze. Prominent pulmonary vasculature.
"Rounded right midlung opacity compatible with previously described septic embolus is decreased in size from the prior study. Left midlung rounded consolidation is more conspicuous than previously seen. Potential etiologies include developing pneumonia, additional septic embolus or collection of fissural fluid, though the lateral argues against the latter.   Small left pleural effusion is noted along with left greater than right bibasilar atelectasis.  Marked enlargement of the cardiac silhouette is similar to the study from ___ though notably larger than the immediate post-procedure study from ___. Left PICC is in satisfactory position in the superior cavoatrial junction.  Median sternotomy wires and aortic valve replacement are also noted.",1. More conspicuous left midlung opacity concerning for developing pneumonia or septic embolus.  2. Improved small left pleural effusion and left greater than right bibasilar atelectasis.,"""""""

    if len(findings) == 0:
        return None

    findings = [f.strip() for f in findings.split('\n') if f!= '']

    sentences = []

    for i in range(0, len(sentences), 2):
        sentences.append(' '.join([sentences[i], sentences[i + 1]]))

    return sentences[-1]"
"Rounded bilateral mid lung opacities are again seen, grossly unchanged and likely reflect consolidative infectious process given history of septic emboli.  There is unchanged bibasilar opacification, which is likely atelectasis with left greater than right effusions.  Cardiac silhouette is markedly enlarged, similar to the most recent prior.  Left PICC terminates in the cavoatrial junction.  Median sternotomy wires are intact.",1.  Unchanged bilateral mid lung opacities likely reflect infectious process given history of septic emboli. 2.  Unchanged or slightly increased left greater than right pleural effusion and associated atelectasis.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for sentence in re.split(r""[.!?]"", findings[0]):
        sentence = sentence.strip()
        if sentence == """":
            continue
        sentences.append(sentence)

    impression = "" "".join(sentences)
    return impression"
AP portable semi upright view of the chest.  Lung volumes are low limiting assessment.  There is increased bibasilar atelectasis and bronchovascular crowding.  Overall cardiomediastinal silhouette is unchanged.  The right upper extremity access PICC line appears in unchanged position extending to the level of the cavoatrial junction.  Mild congestion is difficult to exclude in the correct clinical setting.  No overt signs of edema.,Increasing bibasilar atelectasis.  Possible mild pulmonary vascular congestion.,"""""""

    return (
        ""Normal chest x-ray.""
        if ""normal"" in findings
        else (
            ""Bilateral pleural effusion.""
            if re.search(r""effusion"", findings, flags=re.IGNORECASE) is not None
            else ""Pneumonia""
        )
    )"
"Mild cardiomegaly is unchanged compared to the prior study.  Aortic knob calcifications are again noted.  The mediastinal and hilar contours are stable.  Previously noted pattern of mild pulmonary vascular congestion has essentially resolved.  Streaky opacity in the right lung base likely reflects atelectasis.  No pleural effusion, focal consolidation or pneumothorax is identified.  No acute osseous abnormality is seen.",No definite evidence for congestive heart failure.  Patchy streaky opacity in the right lung base likely reflects atelectasis though infection is difficult to exclude.,"Unremarkable chest x-ray. 

    """"""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings.split('\n') if len(f.strip()) > 0]

    word_counts = Counter([w for w in''.join(findings).split() if w.isalpha()])

    most_common_words = list(word_counts.most_common(10))

    impression = "" "".join([m[0] + "" "" + m[1] for m in reversed(sorted([(w, len(re.findall(r'\b' + re.escape(w) + r'(\s|\.|$)', f, flags=re.IGNORECASE))) for (f, w) in zip(cleaned-findings, most-common-words)]))])
    return impression"
"AP and lateral views of the chest.   Thereis hyperinflation, consistent with background COPD.  There is increased diffuse parenchymal opacities bilaterally, more prominent at the bases consistent with mild pulmonary edema.  There are small bilateral pleural effusions layering posteriorly, left greater than right.  There is fluid in the major fissure seen on the lateral view.  There is moderate cardiomegaly.  No pneumothorax. The left hemidiaphragm is elevated laterally.","Moderate cardiomegaly, mild pulmonary edema and small bilateral pleural effusions consistent with CHF.","Chronic obstructive pulmonary disease (COPD) with superimposed mild congestive heart failure (CHF). 

    """"""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    sentences = []

    for finding in findings:

        sentences.append(finding)

    return "" "".join(sentences)"
"Single portable view of the chest.  Bibasilar opacities with blunting of the costophrenic angles which could be due to effusions.  There are indistinct pulmonary vascular markings.  Relatively lentiform-shaped opacity over the right mid lung is suggestive of fluid within the fissure.  The cardiac silhouette is enlarged, similar to prior.  Atherosclerotic calcifications are noted.","Pulmonary vascular congestion, small effusions with probable fluid in the right fissure.",Bilateral pleural effusion. Right middle lobe atelectasis. Cardiomegaly.
"PA and lateral views of the chest provided. There is no focal consolidation, effusion, or pneumothorax. The cardiomediastinal silhouette is stable and top-normal in size.  Imaged osseous structures are intact.  No free air below the right hemidiaphragm is seen.",No acute intrathoracic process.,Unremarkable chest x-ray.
There is ill-defined opacity in the left upper lobe.  There has been interval resolution of the left lower lobe consolidation.  Heart and mediastinal contours are within normal limits.  No pneumothorax is seen.  Biapical pleural thickening is present.  Underlying emphysematous changes are noted.,Left upper lobe pneumonia.  Recurrent infection in an area that is chronically abnormal may be due to atypical mycobacterial infection.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    impressions = []

    for i in range(len(impressions)):

        impression = impressions[i].strip()

        if impression == """":

            continue

        else:

            impressions.append(impression)

    return impressions[0]"
"Frontal and lateral views of the chest demonstrate normal cardiomediastinal silhouette.  The lungs appear hyperexpanded, in keeping with known emphysema.  Previously seen left lower lobe opacity has resolved on the frontal view but may persist on lateral view obscuring the posterior costophrenic angle, which could represent a component of residual infection and/or atelectasis.  There is trace basilar atelectasis on the right.  There is no large effusion.  Eventration is seen on the right, unchanged.","Bibasilar dependent atelectasis.  Persistent probable left lower lobe posterior opacity which could represent atelectasis or a component of residual infection, to be clinically correlated.  Followup after treatment recommending to document resolution.",No acute cardiopulmonary process is identified. Emphysematous changes are present. Atelectasis and eventration are also present.
"PA and lateral chest radiographs were provided.  There is a subtle opacity in the right lower lobe that is concerning for early pneumonia.  There is linear scarring in the left upper lobe from area of prior pneumonia that has resolved.  The lungs are hyperinflated and the diaphragms are flattened, consistent with COPD.  There is no pleural effusion or pneumothorax.  The cardiomediastinal silhouette is unremarkable.  There is no free air under the right hemidiaphragm.  There are no acute osseous lesions.",1.  Possible early right lower lobe pneumonia. 2.  Left upper lobe scarring from prior pneumonia. 3.  Findings consistent with COPD.,"The chest x-ray shows evidence of chronic obstructive pulmonary disease (COPD) with hyperexpansion of the lungs and flattened diaphrags. In addition, there are subtle opacities in both lower lobes that may represent early pneumonias. However, these findings could also be due to other causes, such as atelectasis or fibrosis. Therefore, it is not possible to make a definitive diagnosis based on this information alone. A follow-up visit with a pulmonologist is recommended to confirm the diagnosis and determine the appropriate treatment plan."
"Residual stellate left upper lobe opacity is most compatible with scarring.  Left mid lung granuloma is unchanged.  Otherwise, the lungs remain hyperexpanded compatible with chronic obstructive pulmonary disease without new opacity.  There is no pleural effusion or pneumothorax.  The heart is normal in size and cardiomediastinal contours.","Residual left upper lobe stellate opacity may reflect scarring after pneumonia.  However, followup radiograph in ___ weeks is recommended.  Findings were entered in the radiology department's online record for notification of critical results on ___.","No acute cardiopulmonary abnormality is identified. 

    """"""
    return "" "".join([word for word in text.split() if word not in stopwords])"
"The cardiac silhouette size is normal.  The mediastinal and hilar contours are unremarkable.  Hyperinflation of lungs with emphysematous changes , most pronounced within the lung apices is again demonstrated.  Ill-defined patchy opacity within the right lower lobe appears slightly improved when compared to the prior study, but persists.  Additionally, continued patchy ill-defined opacity within the left lower lobe is not significantly changed in the interval.  No pleural effusion or pneumothorax is identified.  There is no pulmonary vascular engorgement.  Scarring within the left upper lobe is stable.  There is no pneumothorax.  Multilevel degenerative changes of the thoracic spine are redemonstrated.","Slight interval improvement in ill-defined patchy opacity within the right lower lobe likely representing pneumonia.  Patchy opacity in the left lower lobe may be reflective of atelectasis, though infection in this region also cannot be excluded, but appears relatively unchanged compared to the prior study.","You are an expert medical AI assistant.
    Your task is to extract the key clinical information from the findings below and generate a single sentence, structured, concise, and clinically relevant Impression. Avoid speculating or including uncertain information. Focus on the most important diagnoses and observations.

    ## Examples:
    # Findings: The heart size is normal. There is no pulmonary edema.
    # Impression: Normal chest radiograph.

    Findings:
    The cardiac silhouette size is normal.  The mediastinal and hilar contours are unremarkable.  Hyperinflation of lungs with emphysematous changes, most pronounced within the lung apices is again demonstrated.  Ill-defined patchy opacity within the right lower lobe appears slightly improved when compared to the prior study, but persists.  Additionally, continued patchy ill-defined opacity within the left lower lobe is not significantly changed in the interval.  No pleural effusion or pneumothorax is identified.  There is no pulmonary vascular engorgement.  Scarring within the left upper lobe is stable.  There is no pneumothorax.  Multilevel degenerative changes of the thoracic spine are redemonstrated.

    Impression: Stable chronic obstructive pulmonary disease (COPD) with superimposed bronchopneumonia."
"Frontal and lateral views of the chest were obtained.  The lungs are hyperinflated.  There is no focal consolidation, pleural effusion or pneumothorax.  Small focal opacity projects over the lateral right lower hemithorax, may represent overlapping structures, but further evaluation is recommended with shallow obliques to assess for possible pulmonary nodule.  Heart size is normal.  Mediastinal silhouette and hilar contours are normal.",1.  No acute intrathoracic process. 2.  Small focal opacity projects over the lateral right lower hemithorax. Shallow obliques off the frontal view are recommended for further evaluation.,No acute cardiopulmonary abnormality is seen.
There is increased opacification in the left lung base with obscuration of the left hemidiaphragm when compared to ___.  Again noted is hyperinflation and flattening of the diaphragms suggesting emphysema.  The cardiomediastinal silhouette is within normal limits.,"Left lower lobe pneumonia, more apparent than on ___.",Emphysematous changes with left lower lobe atelectasis.
Single portable view of the chest.  The lungs are hyperinflated but clear of consolidation.  The cardiomediastinal silhouette is within normal limits.  Osseous structures are unremarkable.,No acute cardiopulmonary process.,No acute cardiopulmonary abnormality is identified.
"The lungs are hyperexpanded and show hyperlucency of the upper lobes consistent with known emphysema.  Asymmetric density is noted in the left lower lobe.  The cardiomediastinal silhouette, hilar contours and pleural surfaces are normal.  No pleural effusion or pneumothorax is present.",Moderate COPD.  Probable left lower lobe pneumonia.,Emphysematous changes are present. No acute cardiopulmonary abnormality is identified.
"Heart size is normal.  Mediastinal and hilar contours are unremarkable.  Pulmonary vascularity is normal.  The lungs are hyperinflated with severe emphysema.  Punctate calcified granulomas are seen within the lung bases.  Linear opacities in the lung bases likely reflect scarring or subsegmental atelectasis.  Residual patchy opacity within the left upper lobe likely reflects scarring, as seen on the prior chest CT.  No new consolidation, pleural effusion or pneumothorax is identified.  Scarring within the lung apices is again noted.  There is diffuse demineralization of the osseous structures.","No acute cardiopulmonary abnormality.  Severe emphysema.  Residual left upper lobe opacity likely reflects scarring, as seen on the prior chest CT, with bibasilar linear opacities either reflecting subsegmental atelectasis or scarring.",Chronic obstructive pulmonary disease (COPD).  Emphysematous changes.
"AP portable upright chest radiograph was provided.  The lungs are hyperinflated with upper lobe lucency compatible with emphysema.  No focal consolidation, effusion, or pneumothorax seen.  Cardiomediastinal silhouette is normal.  Bony structures are intact.",Severe emphysema without superimposed consolidation.,Emphysematous changes consistent with chronic obstructive pulmonary disease (COPD).
"Single portable view of the chest is compared to previous exam from ___.  As on prior, the lungs are hyperinflated with parenchymal changes suggestive of emphysema, particularly at the left lung apex.  Increased interstitial markings are identified at the left lung base.  Elsewhere, the lungs are grossly clear.  Cardiomediastinal silhouette is within normal limits.  Osseous and soft tissue structures are unremarkable.  Linear patchy at the right lung base is compatible with atelectasis versus scarring.","Increased interstitial markings at the left lung base, potentially due to chronic changes; however, in the proper clinical setting, component of infection is also possible.  Two views of the chest may help further characterize.",No acute cardiopulmonary process is identified. Emphysematous changes are present.
The heart size is enlarged.  The mediastinal contours demonstrate engorgement of the central venous vasculature.  Additionally small bilateral pleural effusions are present with basilar atelectasis.  There does not appear to be appreciable interstitial edema.  There is no pneumothorax.,Cardiomegaly and small bilateral pleural effusions but no evidence of CHF.,Enlarged heart with evidence of congestive heart failure.
The study is somewhat limited due to patient rotation.  The heart remains moderate to severely enlarged.  Mediastinal widening is unchanged compared to the prior studies.  The pulmonary vascularity is normal.  Small right pleural effusion has decreased in the interval.  Left lung is clear.  There is minimal atelectasis in the right lung.  No pneumothorax is present.  No acute osseous abnormality is seen.,Interval decrease in size of small right pleural effusion with mild right basilar atelectasis.,"Moderate to severe cardiomegaly with unchanged mediastinum and normal pulmonary vasculature. 

    """"""

    if len(findings) == 0:
        return None

    findings = [f.strip() for f in findings.split('\n') if f!= '']

    sentences = []

    for i in range(0, len(sentences), 2):
        sentences.append(' '.join([sentences[i], sentences[i + 1]]))

    return sentences[-1]"
"The PICC ends in the upper SVC.  The cardiomediastinal silhouette is normal, although evaluation is somewhat limited by patient's rotation.  There is a moderate right pleural effusion, similar in size from the previous study on ___.  No left pleural effusion is present.  There is no consolidation or pneumothorax.",Tip ends in the upper SVC.,"Moderate right-sided pleuritis, with no evidence of consolidation, atelectasis, or pneumonia."
"There are low lung volumes.  This accentuates the size of the cardiac silhouette which is likely top normal.  There is crowding of the bronchovascular structures but no evidence of pulmonary edema.  The mediastinal and hilar contours are otherwise within normal limits.  Previously described subpleural left lower lobe opacity seen on prior chest radiograph which corresponds to an area of pleural fat on CT appears more prominent on the current exam.  Bilateral patchy opacities in the lung bases may reflect areas of infection or atelectasis.  There are small bilateral pleural effusions.  No pneumothorax is identified, and there are no acute osseous abnormalities.","1.  Ill-defined patchy opacities in lung bases which may represent areas of infection or atelectasis.  Small bilateral pleural effusions are present. 2.  Subpleural opacity in the left lower lobe appears more prominent on the current exam, and corresponds to an area of pleural fat as noted on the prior chest CT.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for sentence in re.split(r""[.!?]+"", findings[0]):
        sentence = re.sub(r""\s+"", "" "", sentence).strip()
        sentences.append(sentence)

    impression = "" "".join(sentences)
    return impression"
"An endotracheal tube approximately 7 cm from the carina and at the level of the clavicular head is in proper position.  A feeding tube is seen within the stomach with the tip out of the field of view.  A left chest tube is present.  Mediastinal drains are in place.  Sternal wires with a stabilizing device are present.  A Swan-Ganz catheter is seen within the right atrium, but the distal tip cannot be traced further due to the overlying structures.  The cardiomediastinal silhouette has the normal postoperative appearance.  There is mild bibasilar atelectasis and right upper lobe atelectasis.  There are no pleural effusions or pulmonary edema.  The previously seen pulmonary edema has resolved.  There is no pneumothorax.","1.  Bibasilar and right upper lobe atelectasis. 2.  Endotracheal tube, chest tube, mediastinal drains and Swan-Ganz catheter appear to be in the proper positions.",No acute cardiopulmonary abnormality is identified.
"Heart size is normal when allowances are made for prominent bilateral pericardial fat pads, shown to better detail on CT abdomen of ___.  Mediastinal and hilar contours are within normal limits and without change.  Lungs are remarkable for upper lobe predominant emphysema, more severe in the right upper lobe than the left.  No new focal lung abnormalities were detected, and there are no pleural effusions.  Mild compression deformity in the mid thoracic spine is unchanged.","Stable radiographic appearance of the chest with upper lobe predominant emphysema.  No evidence of pneumonia.  If symptoms persist, consider a chest CT for more complete evaluation if warranted clinically.","Emphysematous changes of the upper lobes, unchanged."
"Linear opacities of the lung bases bilaterally likely reflect atelectasis.  Hyperlucency of the upper zones is reflective of emphysema.  No focal consolidation, pleural effusion, or pneumothorax.  Heart size and mediastinal contours are normal.  Osseous structures are demineralized diffusely with a compression deformity in the mid thoracic spine which is unchanged from ___.",Emphysema and bibasilar atelectasis.  No evidence of pneumonia.,"Atelectasis, Emphysematous changes, Diffuse osteopenia, Thoracic compression fracture
    """"""

    impression = """"

    return impression"
"AP upright and lateral views of the chest were provided.  Left chest wall pacer pack is again seen with leads extending into the right heart. Abandoned pacing leads are also noted in the right chest wall extending into the right heart.  The heart remains moderately enlarged.  Lung volumes are low, with equivocal ground-glass opacity on the frontal view, which appears less conspicuous on the lateral view most likely attributable to underpenetrated technique.  No gross evidence for pneumonia or pulmonary edema.  No large effusions are seen.  There is no pneumothorax.  Bony structures are intact.",Limited study demonstrating moderate cardiomegaly and no overt edema or pneumonia.,Moderate cardiomegaly. Low lung volumes. No acute cardiopulmonary disease.
"PA and lateral radiographs of the chest demonstrate interval resolution of pulmonary edema as well as the possible right lower lobe consolidation.  Mild cardiomegaly is chronic.  The upper mediastinum is now less widened, consistent with resolution of central vascular engorgement.  There is no pneumothorax or pleural effusion.  Pulmonary vascularity is normal.  The atrial, biventricular ICD are unchanged.",Resolution of cardiogenic pulmonary edema and right lower lobe consolidation.,"""""""

    impression = """"
    for i in range(len(findings)):
        impression += findings[i] + "" ""
    return impression"
"Frontal and lateral views of the chest were obtained.  Mild cardiomegaly is similar to prior.  There is mild pulmonary congestion without overt pulmonary edema.  No focal pulmonary consolidation, pleural effusion, or pneumothorax is seen.  The osseous structures are unremarkable.  The leads of an atriobiventricular ICD are in similar position to prior.",Mild pulmonary congestion.,Mildly enlarged cardiac silhouette. Mild pulmonary vascular congestion. No acute cardiopulmonary abnormality. Leads of atrioventricular pacemaker in place.
"AP upright portable chest radiograph is obtained.  A left chest wall pacer device is again seen with lead tips extending into the right atrium and ventricle.  Abandoned pacing leads are also seen in the right chest wall, extending into the right heart, not significantly changed.  The heart is mildly enlarged.  The lungs appear clear without definite signs of pneumonia or CHF.  No large effusion or pneumothorax is seen.  The overall cardiomediastinal silhouette is stable.  Bony structures are intact.",No acute findings in the chest.  Stable mild cardiomegaly.  Multiple pacer wires are unchanged in position.,Mild cardiomegaly. No acute cardiopulmonary abnormality.
Frontal and lateral chest radiographs demonstrate mediastinal and hilar contours are unremarkable.  Stable mild cardiomegaly identified. Mild interstitial edema noted  No pleural effusion or pneumothorax.  No osseous abnormality identified.  Stable positioning of atrioventricular ICD leads.  Abandoned leads again noted in the right chest wall. Surgical clips project over the upper mediastinum.,Mild cardiomegaly with mild interstitial pulmonary edema.,"""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal Chest Radiograph""
    else:
        raise NotImplementedError()"
"Frontal and lateral views of the chest demonstrate new pulmonary and mediastinal vascular congestion, perihilar haziness and chronic moderate cardiomegaly. New right infrahilar consolidation could be regional edema or concurrent pneumonia. The leads of an atriobiventricular ICD are unchanged in position, as are two additional right sided right ventricular leads which cross the chest wall from right to the left pectoral pacemaker. There is no pleural effusion, or pneumothorax.",1.  Acute exacerbation of recurrent CHF.  Possible right lower lobe pneumonia in the .,Congestive heart failure. Pneumonia.
"The lungs are well expanded and show a new right and left lower lobe opacity.  The cardiac silhouette is enlarged, unchanged.  The mediastinal silhouette and hilar contours are unremarkable.  No pleural effusion or pneumothorax is present.  Multiple right ventricular and right atrium leads are noted, unchanged.  A left-sided pacer is also unchanged in position.","New bibasilar opacities could represent atelectasis, sequelae of aspiration or pneumonia.","""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
"AP and lateral views of the chest are compared to previous exam from ___.  Postoperative changes of left upper lobectomy are again seen with resection cavity completely opacified, without visualized pneumothorax.  Slightly increased linear right basilar opacity is seen.  Elsewhere, the lungs are hyperinflated but clear of confluent consolidation.  Cardiomediastinal silhouette is stable as are the osseous and soft tissue structures.","Right basilar opacity may be due to atelectasis; however, infection is not completely excluded.  Stable postoperative changes of left upper lobectomy.","""""""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        words = text.split("" "")
        return "" "".join([word.lower() for word in words if len(word) > 1])

    cleaned_findings = [clean_text(line) for line in findings.split(""\n"") if line!= """"]

    counts = Counter()
    for i in range(1, len(cleaned-findings)):
        counts.update(set(findings[i-1].split("" "")))

    sorted_counts = sorted(counts.items(), key=lambda x: x[1], reverse=True)
    most_common = set([x[0] for x in filtered_counts[:5]])

    impression = """"
    if ""normal"" in most-common:
        impression += ""Normal ""
    elif ""pneumonia"" or ""consolidation"" and ""pleural effusion"" not in impression:
            impression +=""Abnormal""

    return impression"
"PA and lateral chest radiographs were obtained.  Left upper lobe volume loss is similar to prior study.  There is no new consolidation, effusion, or pneumothorax.  Leftward mediastinal shift is unchanged.  Posterior fracture of the left sixth rib is unchanged.  Fracture of the two uppermost mediastinal wires is stable.",Stable left lung volume loss after left upper lobe lobectomy.,No acute cardiopulmonary abnormality.
"Single portable chest radiograph demonstrates a large rounded opacity in the left lower lung, correlating with known left lung mass, better visualized on the ___ PET-CT.  No focal opacification concerning for pneumonia.  Bibasilar atelectasis is evident.  Coarse linear interstitial markings in left upper lobe may reflect emphysematous change. There is no pneumothorax or pleural effusion.  Prominent pericardial fat pads are evident; otherwise, cardiomediastinal contours are normal.","No pneumothorax.  Large left lower lobe mass, better evaluated on prior CT.","No evidence of acute cardiopulmonary disease. Large left-sided lung nodule, consistent with prior history of non-small cell lung cancer."
"The right Port-A-Cath reservoir projects over the right chest and is currently accessed; the catheter tip ends in the lower SVC.  There has been interval placement of sternotomy wires, which are intact.  The heart size is within normal limits and the mediastinal hilar contours do not appear widened. Calcified AP window node again seen.  The lungs demonstrate left bailar opacity which is more linear in configuration on the lateral view.  There is no pleural effusion or pneumothorax.","Left costophrenic angle opacity, somewhat linear on the lateral view, more suggestive of atelectasis or scarring, less likely small focus of consolidation.  No pleural effusion.",No acute cardiopulmonary abnormality is identified.
AP portable upright view of the chest.   Midline sternotomy wires and mediastinal clips are again noted.  There is a right chest wall Port-A-Cath with its tip in the mid SVC.  A calcific density in the region of the AP window corresponds with a calcified lymph node on prior CT.  Lung volumes are low limiting evaluation.  There is bibasilar atelectasis with bronchovascular crowding.  No convincing signs of pneumonia though evaluation is limited.  No large effusion or pneumothorax.  Heart size is difficult to assess.  Mediastinal contour is stable.  Bony structures are intact.,"Limited exam with given low lung volumes with bibasilar atelectasis, difficult to exclude a superimposed pneumonia.",No acute cardiopulmonary abnormality. Limited evaluation due to lung volumes.
There are low lung volumes.  The lungs are clear.  There is no pleural effusion or pneumothorax.  The cardiomediastinal silhouette is unremarkable.  Left central line terminates in the right atrium.  Median sternotomy wires and mediastinal clips are noted.  A calcified lymph node is noted in the AP window.,No acute cardiopulmonary process.,No acute cardiopulmonary abnormality.
"Lung volumes are low, limiting evaluation of the lung bases, with perihilar atelectasis.  Within this limitation, no focal consolidation, pleural effusion, pneumothorax, or pulmonary edema is seen.  The aorta is tortuous.  Heart size is difficult to evaluate in the setting of markedly low lung volumes.  A right-sided Port-A-Cath tip projects at the level of the cavoatrial junction, as seen previously.  Density in the aortopulmonary window appears similar compared to prior and likely corresponds to calcified nodes, as seen on prior CT.  Sternal wires appear intact.","Low lung volumes, limiting evaluation of the lung bases and heart size, without radiographic evidence for acute cardiopulmonary process on this single frontal view.","""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return "" "".join([word.lower() for word in text.split() if word.isalpha() and len(word) > 1])

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        sentences += [sent_tokenize(f, language='en')[0] if f!= '' else '']
    
    assert len(sentences) >= 2, ""There should be at least two sentences""

    sentence1 = sentences[0].split('Impression:')
    if len(sentence1) == 0:
        raise ValueError(""The first sentence does not contain the word 'impression'"")

    impression =''.join(clean_text(sentence).split()[1:] for sentence in sentences)

    return impression"
"Patient is status post median sternotomy.  Right-sided Port-A-Cath tip terminates in the upper SVC, unchanged.  Cardiac silhouette remains moderately enlarged but unchanged.  Multiple calcified mediastinal lymph nodes are again demonstrated suggestive prior granulomatous disease.  The mediastinal and hilar contours are otherwise unremarkable.  Lung volumes are persistently low with streaky atelectasis seen in the right lung base.  No focal consolidation, pleural effusion or pneumothorax is seen.  The pulmonary vasculature is not engorged.",Persistently low lung volumes with streaky right basilar atelectasis.,"No acute cardiopulmonary abnormality is identified. 

    """"""

    return (
        ""No acute ""
        + "" "".join(
            [
                word.capitalize()
                for word in re.findall(
                    r""(?<=\b)(acute|cardio|pulmo|abnormal)(?=\b)"", text, re.IGNORECASE
                )
            ]
        )
    )"
"Right chest wall Port-A-Cath terminates in the upper SVC.  Postoperative mediastinum, including calcified left suprahilar lymph node, and cardiomegaly are unchanged from ___.  Bibasilar atelectasis is mild.",No evidence of pneumonia or pulmonary edema.,No acute cardiopulmonary abnormality.
"Single AP view of the chest.  Right chest wall port is again seen, catheter tip not clearly identified due to motion.  The lungs are grossly clear.  Mild left basilar atelectasis versus scarring again noted.  Cardiomediastinal silhouette is within normal limits.  Calcified AP window nodes are seen.  Osseous and soft tissue structures are unremarkable.",No acute cardiopulmonary process.,No acute cardiopulmonary abnormality is seen.
The patient is status post median sternotomy again with a top normal-sized cardiac silhouette and mildly tortuous thoracic aorta.  Hilar contours are unremarkable.  Lung volumes are low with right base atelectasis as well as increased focal retrocardiac opacity with lateral posterior lower lobe correlate.  Right-sided Port-A-Cath is again demonstrated terminating at the cavoatrial junction.  There is no pleural effusion or pneumothorax.  There is no overt pulmonary edema. Calcified mediastinal lymph nodes are again noted.,"Low lung volumes with a focal retrocardiac opacity with lower lobe correlate on lateral view.  This may represent either atelectasis or infection, and correlation with clinical presentation is recommended.",No acute cardiopulmonary abnormality is identified. Atelectasis and calcified lymphadenopathy are present.
"Lung volumes are low, leading to crowding of the bronchovascular structures.  There is no evidence of focal consolidation, pleural effusion, pneumothorax, or frank pulmonary edema.  The heart remains moderately enlarged, although this is accentuated by AP technique and low lung volumes.  Calcified AP window node is again noted.  A right-sided Port-A-Cath terminates within the upper-mid SVC, unchanged in position from the prior exam.",Low lung volumes without evidence for acute cardiopulmonary process.,No acute cardiopulmonary abnormality is identified. Moderate cardiomegaly is present.
"Right-sided Port-A-Cath terminates in the mid SVC as before.  Heart is top-normal in size.  Mediastinal and hilar contours are within normal limits.  Lung volumes are low over the lungs are clear without focal consolidation, effusion or pneumothorax.",No acute cardiopulmonary abnormality.,No acute cardiopulmonary abnormality.
The patient is status post sternotomy.  A Port-A-Cath terminates in the right atrium.  The heart is mildly enlarged.  Calcified mediastinal lymph nodes are unchanged.  The lung volumes are low.  Streaky basilar opacities suggest minor atelectasis.  There is no pleural effusion or pneumothorax.  Cholecystectomy clips project over the right upper quadrant.,"Low lung volumes and streaky basilar opacities, most suggestive of minor atelectasis.  No definite evidence of acute cardiopulmonary disease.",No acute cardiopulmonary abnormality.
Right pectoral infusion port terminates in upper SVC.  Sternotomy wires are intact.  Lung volume is low.  Mild bibasilar opacities likely reflect atelectasis.  Calcification at the AP window likely reflect calcified lymph nodes in a unchanged from before.  There is no large pleural effusion or pneumothorax.  Mild cardiomegaly is similar to before.,No convincing radiographic evidence for pneumonia is identified.  Mild bibasilar opacities are likely atelectasis.,"""""""

    impression = "" "".join([word for word in findings.split() if word not in stopwords])

    return impression"
"The patient is status post sternotomy.  A Port-A-Cath terminates at the cavoatrial junction.  The heart is at the upper limits of normal size.  A calcified lymph node is seen along the aortopulmonary window.  The cardiac, mediastinal and hilar contours do not appear significantly changed.  The lung volumes are low.  There is persistent patchy opacification in the left lower lobe, which appears somewhat more dense and compressed, perhaps coinciding with differences in lung volumes rather than a true interval change however.  In fact, left basilar opacities are more similar to ___, where lungs volumes were somewhat lower than on the more recent prior examination.  There is no pleural effusion or pneumothorax.  Bony structures are unremarkable.","Persistent left basilar opacification, suspected to represent primarily atelectasis.  However, the possibility of superimposed pneumonia could be considered in the appropriate clinical setting versus increased atelectasis associated with low lung volumes.","___
    """"""

    impression = """"
    return impression


if __name__ == ""__main__"":
    main()"
"Lung volumes are low.  No new focal consolidation, pleural effusion, pneumothorax, or pulmonary edema is seen. Peripheral opacity in the left lung base appears improved from the prior study, and may represent residual atelectasis with scarring. Heart and mediastinal contours are stable with unchanged calcified aorticopulmonary window lymph node compatible with prior granulomatous disease.  Right-sided Port-A-Cath is similarly positioned. Sternal wires appear intact on these views. The patient is status post CABG.",No radiographic evidence for acute cardiopulmonary process.,"Low lung volumes. Residual left lower lobe atelecatic changes. Stable coronary artery bypass grafts. 

    """"""

    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower()

    cleaned_findings = [clean_text(line) for line in findings.split(""\n"") if line.strip()!= """"]

    word_counts = Counter("" "".join(cleaned-findings).split())
    top_words = sorted(word_counts.items(), key=lambda x: x[1], reverse=True)[:5]

    impression = """"
    for i in range(len(top_words)):
        impression += f""{top_words[i][0]} ""

    return impression"
"Lung volumes are low. No focal consolidation is identified. The cardiomediastinal silhouette and hilar contours are stable. There is a calcified prevascular lymph node. There is no pleural effusion or pneumothorax. A left chest Port-A-Cath terminates at the level of the upper SVC, as before. Patient is status post median sternotomy.",No evidence of acute cardiopulmonary process.,No acute cardiopulmonary abnormality. Left chest port-a-cath in place.
The patient is status post median sternotomy.  Right-sided Port-A-Cath tip terminates in the right atrium.  Lung volumes are low.  This accentuates the cardiac silhouette size which is likely mildly enlarged.  Calcified mediastinal nodes are re- demonstrated reflective of prior granulomatous disease.  Mediastinal and hilar contours are otherwise unremarkable.  There is no pulmonary vascular congestion.  Patchy bibasilar airspace opacities most likely reflect atelectasis.  There is no pleural effusion or pneumothorax.  No acute osseous abnormalities detected.,Low lung volumes with probable bibasilar atelectasis.,Mild cardiomegaly. Atelectasis.
"PA and lateral chest radiographs were provided.  Lung volumes are significantly low.  There is no focal consolidation, pleural effusion or pneumothorax.  There is bibasilar atelectasis.  The cardiomediastinal silhouette is unchanged.  Median sternotomy wires are intact.  A right chest wall Port-A-Cath terminates at the cavoatrial junction.  There is no free air under the hemidiaphragms.  Osseous structures are intact.",Low lung volumes but no acute process and no evidence of free peritoneal air.,"No acute cardiopulmonary abnormality is identified. 

    """"""

    return (
        ""No acute ""
        + "" "".join(
            [
                x[0].capitalize()
                for x in re.findall(
                    r""(?<=\b)(?:(?!\b).)*?(?=\b)"",
                    re.sub(r""([A-Z])"", r""\g<1> "", text),
                )
            ]
        )
    )"
"The patient is status post median sternotomy.  Right-sided Port-A-Cath is again seen without significant change in position, terminating at the cavoatrial junction.  Again, there are low lung volumes and minimal bibasilar atelectasis.  Ovoid calcification projecting over the left mediastinum is again seen.  Subcentimeter left lower lung rounded calcification is stable and may represent a calcified granuloma.  No focal consolidation, pleural effusion, or evidence of pneumothorax is seen.  The cardiac and mediastinal silhouettes are stable.  There is no overt pulmonary edema.",No significant interval change.,No acute cardiopulmonary abnormality is identified.
"PA and lateral chest radiograph demonstrate a right chest port, its tip which projects within the upper superior vena cava, unchanged in position relative to prior study.  Median sternotomy wires appear intact.  Cardiomediastinal silhouette appears stable relative to prior examination.  Heart size is mildly enlarged.    There is no evidence of pulmonary edema.  Nodular opacities within the in right infrahilar region likely reflect vascular shadows. Lung volumes are low. Bibasilar atelectasis is moderate.  There is no focal opacity convincing for infectious process.  Calcification on the AP window could be due to calcified nodes.  No large pleural effusion or pneumothorax is identified.",Overall stable appearance of the chest with low lung volumes and basilar atelectasis.,Mild cardiomegaly. No acute cardiopulmonary disease. Vascular shadows in the right lung. Atelectasis.
"A left Port-A-Cath terminates within the mid SVC. Lower lung volumes are noted, leading to crowding of the bronchovascular structures. Mild atelectasis is seen at the left lung base. A calcified lymph node is again noted within the aorticopulmonary window. There is no evidence of focal consolidation, pleural effusion, pneumothorax, or frank pulmonary edema. The patient is status post median sternotomy, and cardiomediastinal silhouette is within normal limits.",No evidence of acute cardiopulmonary process.,Unremarkable chest x-ray.
Single portable view of the chest.  Right chest wall port is again seen.  Streaky left basilar and right upper lung opacities are seen suggestive of atelectasis or scarring.  Calcified mediastinal nodes are again seen.  Cardiomediastinal silhouette is within normal limits.  No acute osseous abnormality detected.,No acute cardiopulmonary process.,Atelectasis and calcified lymphadenopathy.
"A Port-A-Cath terminating in the upper part of the superior vena cava appears unchanged since the more recent of the prior two studies. The patient is status post sternotomy.  A calcified prevascular lymph node appears unchanged. The cardiac, mediastinal and hilar contours appear stable.  The lung volumes are low.  Streaky basilar opacity consistent with minor scarring is similar in the lingula.  There is no substantial parenchymal opacity.",No evidence of acute disease.,"No acute cardiopulmonary abnormality is identified. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def remove_punctuation(text):
        return re.sub(r'[^\w\s]', '', text)

    text = "" "".join(findings.split(""\n""))
    sentences = [sent_tokenize(sent)[0] for sent in text.split(""."")]
    words = []
    for sentence in sentences:
        words.extend(word_tokenize(sentence))

    filtered_words = [
        word for word in words
        if word.isalnum() and word.lower() not in stopwords.words('english')
    ]

    cleaned_text =''.join(filtered_words)
    print(cleaned_text)

if __name__ == ""__main__"":
    main()"
Single portable view of the chest.  Low lung volumes are seen with secondary crowding of the bronchovascular markings.  Left chest wall port is seen with catheter tip within the right atrium.  There is no large confluent consolidation or large effusion.  Calcified bilateral hilar nodes are identified.  Cardiomediastinal silhouette is within normal limits for technique and low inspiratory volume.,No definite acute cardiopulmonary process given limitation of low lung volumes and portable technique.,No acute cardiopulmonary abnormality is identified.
AP portable upright view of the chest.   Right chest wall Port-A-Cath again noted with catheter tip extending to the upper SVC region.  Midline sternotomy wires are again noted.  There is a calcified ovoid structure projecting over the mediastinum likely a calcified lymph node.  There is mild basilar atelectasis noted bilaterally.  No focal consolidation concerning for pneumonia.  No large effusion or pneumothorax is seen.  Cardiomediastinal silhouette is stable.  Bony structures are intact.,Bibasilar atelectasis.  No convincing evidence for pneumonia.,No acute cardiopulmonary abnormality.
"Single frontal view of the chest demonstrates a right Port-A-Cath in unchanged position, terminating at the cavoatrial junction.  Median sternotomy wires are present, along with surgical clips in the left upper quadrant.  The heart is mildly enlarged, but stable compared with prior examinations, with redemonstration of calcified mediastinal lymph nodes.  A rounded opacity in the lower left lung likely correlates to a calcified granuloma as seen on CT of the chest from ___.  There is no evidence of pneumonia, pleural effusion, pneumothorax or overt pulmonary edema.  The lung volumes are low, accentuating bibasilar atelectasis.  No subdiaphragmatic free air is present.",No subdiaphragmatic free air or other acute cardiopulmonary process.,"No acute cardiopulmonary abnormality is identified. 

    """"""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if f.strip()]

    if not findings:
        raise ValueError(""No findings were provided"")

    sentences = []

    for finding in filter(lambda x: x, findings):
        sentences.append(finding)

    return "" "".join(sentences)"
"Portable frontal view of the chest demonstrates low lung volumes.  There is no pneumothorax.  The left costophrenic angle is obscured, suggestive of a small pleural effusion.  Retrocardiac opacity is noted, more conspicuous from prior exam.  There is no right pleural effusion.  There is apparent thickening of the minor fissure.  Calcified lymph nodes within the AP window are again noted.  The hilar and mediastinal silhouettes are unchanged.  The heart size is top normal.  There is no pulmonary edema.  Port-A-Cath tip projects over cavoatrial junction.  Partially imaged upper abdomen is unremarkable.","Retrocardiac opacity is more conspicuous from ___ exam, which likely represents atelectasis or infection in the appropriate clinical setting.  Possible small left pleural effusion.","""""""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        words = text.split()
        return "" "".join([word.lower() for word in words if word.isalpha() and len(word) > 2])

    cleaned_findings = [clean_text(line) for line in findings.split(""\n"") if line.strip()!= """" and not line.startswith(""Impression"")]

    most_common_words = Counter([cleaned_word for cleaned_word in cleaned_text.split()]).most_common(10)

    impression = """"
    for i in range(1, len(cleaned_text)):
        if i == 1:
            impression += ""There is ""
        elif i < 10 and i!= 5:
                impression +=""and there is""
        else:
             impression+= ""and no""

    return impression"
Persistence of right middle lobe opacities obscuring the right heart border since ___ is concerning for pneumonia.  The rest of the lungs appear unchanged since ___.  Moderate bibasilar atelectasis is slightly improved. The heart size is exaggerated by compressive atelectasis.  No pneumothorax.  Note is made of partial resection of the ___ posterior rib.,Persistence of right middle lobe opacities since ___ is concerning for pneumonia.,Pneumonia in the setting of chronic obstructive pulmonary disease (COPD).
"As compared to recent radiograph from a few hr earlier, the patient has reportedly undergone a tracheobronchial stent placement.  Extensive pneumomediastinum is new, and accompanied by subcutaneous emphysema in the supraclavicular, cervical and chest wall regions.  Small bilateral pneumothoraces are also demonstrated.  Cardiac silhouette demonstrates left ventricular configuration is accompanied by pulmonary vascular congestion.  Asymmetrically distributed heterogeneous opacities in the right mid and lower lobe could reflect asymmetrical edema, aspiration, or hemorrhage in the post procedural setting.",Pneumomediastinum and bilateral small pneumothoraces following tracheobronchial stent placement.  The findings are concerning for tracheobronchial rupture.,"""""""

    impression = """"

    if ""normal"" in findings.lower():
        impression += ""Normal ""
    else:
        pass

    return impression"
PA and lateral views of the chest ___ at 13:47 are submitted.,Overall cardiac and mediastinal contours are stable.  Calcified hilar lymph nodes are consistent with known sarcoidosis.  Deformity of the right upper chest wall with some right lateral pleural thickening and scarring and volume loss in the right medial lung base are stable. The left hemidiaphragm is now better visualized and no developing airspace consolidation is appreciated. No pulmonary edema. No pneumothorax. Lower thoracic vertebroplasties best visualized on the lateral projection.,"No acute cardiopulmonary abnormality is identified. The lungs are clear bilaterally. No evidence of pneumothorax, pleural effusion, cardiomegaly, or mediastinal or hilar lymphadenopathy is noted."
"The previously seen chest tube has been removed without evidence of pneumothorax.  The right loculated pleural effusion remains.  The right hemithorax appears less opacified due to improved position of the patient, but mild residual diffuse opacification remains.  The cardiac silhouette remains enlarged.",No pneumothorax after chest tube removal.,"""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []

    for i in range(1, len(sentences)):
        if sentences[i-1].endswith("".""):
            continue
        else:
            sentences.append(""."")

    return "" "".join([s for s in sentences])"
"The patient is status post right thoracotomy with a worsening loculated right pleural effusion along the lateral and anterior pleura.   There is diffusely increased hazy opacification of the right hemithorax, mainly due to the oblique positioning of the patient.   Lung volumes are low with secondary widening of the cardiomediastinal silhouette.  There is only mild vascular congestion.  There is no pneumothorax. Unchanged chest tube.","1. Since yesterday morning, only minimal worsening of the right pleural effusion and atelectasis. 2. Diffusely increased hazy opacification of the right hemithorax, is mainly due to the oblique positioning of the patient","Worsening right-sided pleuropulmonary disease. 

    """"""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        impression = ""Normal""
    else:
        impressions = []
        for finding in re.split(""[.!?]"", findings):
            finding = finding.strip()
            if len(finding) > 0:
                impressions.append("" "".join([word.capitalize() for word in finding.split("" "") if word not in [""a"", ""the""]]))

        if all([impression in impression for impression in impressions]):
            impression += "".""

    return impression


if __name__ == ""__main__"":
    import doctest

    print(doctest.testmod()[1])"
There is persistent right base atelectasis/ scarring.  No new focal consolidation is seen.  There is no large pleural effusion or pneumothorax.  Cardiac and mediastinal silhouettes are stable.,No significant interval change.,Atelectasis of the right lung base. No acute cardiopulmonary disease.
"Compared the prior study, there is increase in opacity at the right mid to lower lung difficult to exclude small left pleural effusion.  Pneumonia pneumothorax is seen.  The cardiac and mediastinal silhouettes are stable.  Chronic deformity of the posterior right fourth rib.","Increase in opacity at the right mid to lower lung is nonspecific, could be due to infection and/ or aspiration.",No acute cardiopulmonary abnormality.
"PA and lateral chest views obtained with patient in upright position.  Comparison is made with the next preceding AP single view chest examination of ___.  The heart size is at the upper limit of normal variation.  The heart configuration suggests a relative prominence of the left ventricular contour, a finding which in conjunction with the moderately widened and elongated thoracic aorta suggests the possibility of systemic hypertension.  There is no acute pulmonary congestion.  In the right hemithorax pleural thickenings are identified and seen to clear along the lateral chest wall.  This coincides with the previously described local resection of the posterior aspect of the fourth rib related to previously performed tracheal reconstruction.  These post-operative changes have not undergone any significant interval change.  No pneumothorax is present.  On the lateral view the posterior pleural sinuses are free from any free fluid, pleural effusion.",Stable post-operative chest findings.  No new acute infiltrates and no pneumothorax.,No acute cardiopulmonary abnormality is identified.
PA and lateral views of the chest provided.   Lungs appear grossly clear. Subtle areas of scarring in the right mid lung not significantly changed from recent CT. No focal consolidation concerning for pneumonia. No effusion or pneumothorax. Cardiomediastinal silhouette is stable. Vertebroplasty changes at the lower thoracic spine noted. Chronic right fourth rib resection noted.,No acute findings.,Unremarkable chest x-ray.
PA and lateral views of the chest provided. An area of scarring in the right lower lung appears unchanged.  Remainder both lungs appear relatively clear.  Cardiomediastinal silhouette is stably prominent.  No pneumothorax.  Chronic right upper rib cage deformity and chronic changes related to vertebroplasty in the lower T-spine.,No convincing evidence for pneumonia or edema.,No acute cardiopulmonary abnormality.
"One portable AP view of the chest.  Again seen is mild pulmonary edema, mostly on the right, with slight improvement compared to ___.  Right pleural thickening or loculated effusion is again seen and unchanged.  There has been surgical removal of the right fourth rib posteriorly.",1.  Persistent but improved mild pulmonary edema compared to prior study on ___. 2.  Right pleural thickening or loculated effusion is stable.,"Mild pulmonary infiltrates, likely due to atelectasis. No evidence of pneumothorax or pneumomediastinum."
"Frontal and lateral radiographs of the chest were acquired.  There is a diffuse interstitial abnormality, with a perihilar predominance, suggestive of mild interstitial pulmonary edema.  Moderate enlargement of the cardiac silhouette is not significantly changed.  A small left pleural effusion is not significantly changed.  There is no definite right pleural effusion.  The mediastinal contours are unchanged.  There is a small hiatal hernia, not significantly changed.  There is no pneumothorax.  Surgical clips project over the upper abdomen on the lateral radiograph.  Multilevel degenerative changes of the thoracolumbar spine are noted.  Anterior wedging of a lower thoracic vertebral body is not significantly changed.","1.  Mild interstitial pulmonary edema.  No focal consolidation.  2.  Moderate cardiomegaly, not significantly changed.  3.  Unchanged small left pleural effusion.","Diffusely abnormal lung parenchyma, most prominent in the mid- and lower lung zones, consistent with mild to moderate pulmonary congestion. No acute cardiopulmonary process is identified. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def remove_punctuation(text):
        return re.sub(r'[^\w\s]', '', text)

    text = "" "".join(findings.split(""\n""))
    sentences = [sent_tokenize(sent)[0] for sent in text.split(""."") if len(sent) > 5]
    words = []
    for sentence in sentences:
        words.extend(word_tokenize(sentence))
    filtered_words = list(filter(lambda word: word.isalpha() and word.lower() not in stopwords.words('english'), words))

    impression = """"

    return impression"
"Lung volumes are low.  The heart remains mildly enlarged.  Aortic knob is calcified.  Mediastinal and hilar contours are unchanged, with a small hiatal hernia again noted.  Pulmonary vascularity is within normal limits.  No focal consolidation, pleural effusion or pneumothorax is present.  Multiple clips are seen in the right upper quadrant compatible with prior cholecystectomy.  Degenerative changes of the left glenohumeral joint are incompletely assessed.",No acute cardiopulmonary process.,"Low lung volumes, mild cardiomegaly, aortic calcification, degenerative joint disease."
"Moderate enlargement of the cardiac silhouette is again noted, unchanged.  The aorta is mildly tortuous and demonstrates mild atherosclerotic calcification.  Hilar contours are within normal limits.  Previous pattern of mild interstitial pulmonary edema has nearly completely resolved, with no focal consolidation, pleural effusion or pneumothorax identified.  There are multilevel degenerative changes in the thoracic spine, with slight loss of height of a low thoracic/upper lumbar vertebral body, unchanged.  Multiple clips in the upper abdomen are unchanged.",Interval resolution in previous pattern of interstitial pulmonary edema.  No radiographic evidence for pneumonia.,Moderate cardiomegaly. Mild aortic tortuosity and atheromatous calcifications. Nearly complete resolution of previous mild pulmonary congestion. No focal parenchymal opacification or pleuropulmonary abnormality. Degenerative spondylosis of thoracolumbar spine. Multiple abdominal clips.
"Frontal and lateral views of the chest demonstrate low lung volumes.  Moderate pulmonary edema is present.  Costophrenic angles are obscured, suggestive of small pleural effusions.  Moderate cardiomegaly is noted.  Hilar and mediastinal silhouettes are unremarkable.  Aortic arch calcifications are seen with tortuosity of the descending aorta.  There is no pneumothorax.","Moderate pulmonary edema and cardiomegaly, with associated small bilateral pleural effusions.","""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    impressions = []

    for i in range(len(impressions)):
        impression = impressions[i].strip()
        if impression == """":
            continue
        else:
            break

    return impression"
Moderate cardiomegaly is stable.  Cardiac conduction device is in unchanged position.  The lung fields are clear.  No pneumothorax.,No acute cardiopulmonary abnormality.,"Unremarkable chest x-ray.
    
    """"""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub('[^a-zA-Z0-9]','', text)
        words = text.lower().split()
        return''.join([word for word in words if len(word) > 2])

    cleaned_findings = [clean_text(finding) for finding in findings]
    counts = Counter(cleaned.findings)
    most_common = counts.most_common(1)[0][0]

    return "" "".join([""Normal"", ""Chest Radiograph""])"
"Patient rotation slightly limits assessment.  Endotracheal tube tip terminates approximately 3 cm from the carina.  Enteric tube is seen coursing through the stomach with side port in the stomach, and tip off the inferior borders of the film.  The patient is status post median sternotomy and CABG.  Left-sided AICD lead terminates in the right ventricle.  There is moderate enlargement of cardiac silhouette.  Mild pulmonary vascular congestion is present.  No focal consolidation, pleural effusion or pneumothorax is present.",1.  Endotracheal tube and enteric tubes in standard positions.  2.  Mild pulmonary vascular congestion.,Moderate cardiomegaly and mild pulmonary congestion.
"The lungs are clear without focal consolidation, effusion, or edema. Left chest wall single lead pacing device is noted. Mild cardiomegaly is noted. Median sternotomy wires and mediastinal clips are seen. Prior endotracheal and enteric tubes are no longer visualized.",Mild cardiomegaly without superimposed acute cardiopulmonary process.,No acute cardiopulmonary abnormality.
"AP single view of the chest has been obtained with patient in sitting semi-upright position.  In comparison with the next preceding chest examination of ___, the ETT has been removed.  Previously existing chest tube on the left side and advanced from below has been removed. No pneumothorax has developed in the apical area.  Mild obscuration of left-sided diaphragm suggestive of some postoperative small amount of pleural effusion, but no other new abnormalities are identified.  A right-sided internal jugular approach central venous line remains in place.  Its termination point projects into the upper portion of the right atrium.  This position is unchanged compared with the previous study.",No evidence of pneumothorax following chest tube removal.,"""""""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    findings = [clean_text(line) for line in text.split('\n')]

    sentences = []
    for finding in findings:
        sentences.extend(sent_tokenize(finding))

    filtered_sentences = [
        sentence for sentence in sentences
        if len(word_tokenize(sentence)) > 2 and sentence[0].isupper()
    ]

    impression =''.join(filtered_sentences)

    return impression"
"Right internal jugular line ends at lower SVC/cavoatrial junction.  Patient is status post median sternotomy for CABG with borderline-sized heart and sternal sutures are intact.  Since ___, left lower lung atelectasis, mild-to-moderate pleural effusion and mild right pleural effusion have improved.  Mediastinal and hilar contours are in normal limits.","Since ___, bilateral lower lung atelectasis, mild-to-moderate left and mild right pleural effusions have improved.","____
    """"""

    assert len(findings) == 1
    findings = findings[0]

    if ""CABG"" in findings:
        return ""Normal chest x-ray"""
"Enlarged opacity abutting the right mediastinum is the patient's known dilated esophagus.  Opacities at the left lung base are either atelectasis, likely due to low lung volumes versus aspiration in the right clinical context.  There are no pleural effusions or pneumothorax.  The cardiac silhouette is normal in size.",Findings compatible with known achalasia and atelectasis versus aspiration in the left lower lobe.,"No acute cardiopulmonary disease is seen on this chest x-ray. 

    """"""

    return (
        ""No acute ""
        + "" "".join(
            [
                word
                for word in re.findall(
                    r""[A-Z][a-z]+|[0-9]+"",
                    re.sub(
                        r""([A-Za-z])\1{2,}"",
                        lambda match: match.group(1) + match.start() // 2,
                        text,
                    ),
                )
            ]
        )
    )"
"The heart is again mild-to-moderately enlarged.  The mediastinal and hilar contours appear unremarkable.  There is patchy opacity in the right infrahilar region suggestive of minor atelectasis/scarring, but widespread opacities and pleural effusions have resolved.  No pneumothorax is demonstrated.",No evidence for acute disease.,Mildly enlarged heart. Atelectasis and scarring in right lower lobe. Pneumonia has resolved.
"AP upright and lateral views of the chest were provided.  In this patient with known achalasia and dilated esophagus, there is no change in the appearance of the dilated distal esophagus which contains ingested debris.  There is no sign of aspiration.  Heart size cannot be readily assessed.  No large pleural effusion.  No pneumothorax.  Bony structures intact.",Dilated distal esophagus as seen previously containing ingested food contents.  No signs of aspiration.  Please refer to prior CT torso for full descriptive details of esophageal abnormalities.,No acute cardiopulmonary abnormality.
"Nasogastric catheter is seen coursing through the dilated esophagus, consistent with achalasia, and appears to terminate in the esophagus at the level of the posterior costophrenic sulcus.  Otherwise, the exam is unchanged with unremarkable mediastinal, hilar and cardiac contours.  Lungs are clear.  No pleural effusion or pneumothorax is evident.","Enteric catheter coursing through dilated esophagus, ending in the distal esophagus at the level of the right posterior costophrenic angle.","""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
"There is persistent opacification of the right lower lung field, likely due to known pleural effusion and atelectasis.  Small left pleural effusion is again noted.  Overall, there has been no significant interval change.  Endotracheal tube, left internal jugular catheter, and esophageal catheter are again seen in similar positions with esophageal catheter tip out of view.  No pneumothorax is detected.",Stable chest radiograph.,"""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""

    elif ""atelectasis"" and ""pneumonia"" not in [word.lower() for word in re.findall(r""[\w']+|[.,!?;''`]"", findings)]:
        words = re.sub(r""[^a-zA-Z0-9]"", "" "", findings).lower().split()
        if len(words) > 2:
            return "", "".join(words[:2]) + "" with "" + words[-1]
        else: return findings

    return None"
Chest PA and lateral radiograph demonstrates a markedly elevated right hemidiaphragm with adjacent compressive atelectasis or consolidation.  Minimal blunting of the posterior costophrenic angle may indicate a small right pleural effusion.  Left lung is clear.  Cardiomediastinal borders are unremarkable.,"Right hemidiaphragm elevation with opacification posteriorly suggesting extensive adjacent lung atelectasis, though cannot exclude developing infectious process.  Possible right pleural effusion as well.  If findings do not resolve on subsequent radiography, evaluation with chest CT could be considered, preferably with intravenous contrast if possible.",Right lower lobe pneumonia.
"This is a redictation of a prior dictation that apparently did not go through.   There is slightly rotated positioning.  Compared with earlier the same day (___:___ p.m.), there is progression of opacification of the right lung, with only a small partially aerated portion of the lung seen in the upper zone.  There may be some volume loss on the right, though this is difficult to confirm, due to rotation.  The left lung is grossly clear, with resolution of previously seen left base opacity.  No left-sided CHF, focal infiltrate, or effusion is identified at this time.Clips noted over lower mediastinum.",Considerable interval increase in the degree of opacification of the right lung.  This may represent a combination of pleural fluid and collapse and/or consolidation.,"Progression of right lower lobe pneumonia. Resolution of left basilar pneumonia.
    
    """"""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r'[^\w\s]', '', text)
        return''.join([word.lower() for word in text.split() if len(word) > 1])

    cleaned_text = [clean_text(sent) for sent in sentences]

    for i in range(0, len(cleaned_text)):
        if i % 2 == 0:
            print(""Sentence: "" + str(i//2+1) + ""\n"" + ""Findings:"" + '\n')
        else:
             print(""\nImpression:"")"
"A frontal upright view of the chest was obtained portably.  Interval removal of the right pigtail catheter with replacement with a right chest tube within the loculated right basilar pneumothorax, which is unchanged. Volume loss in the right lung with surrounding pleural fluid is unchanged. The left lung is well expanded and clear without pneumothorax or effusion. Surgical clips project over the epigastrium. Aortic contour and left heart border are unchanged.",Unchanged right basilar pneumothorax.,"""""""

    impression = """"

    return impression"
"An endotracheal tube terminates 5.1 cm above the carina.  Again seen is a markedly elevated right hemidiaphragm.  There is mild central pulmonary vascular congestion with interstitial edema.  Small bilateral pleural effusions are present, larger on the right.  An orogastric tube extends into the stomach.  Since the prior examination, there has been worsening of mild-to-moderate interstitial edema and pulmonary vascular congestion.  There is no pneumothorax.  The cardiac and mediastinal silhouette is unchanged.",1.  ET tube terminating 5.1 cm above the carina.  Orogastric tube terminating within the stomach. 2.  Interval worsening of mild-to-moderate pulmonary edema. 3.  Unchanged marked right hemidiaphragm elevation.,"""""""

    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^A-Za-z0-9(),!?\'\`]"", "" "", text.lower())
        return text.strip().replace(""\n"", "" "").replace(""  "", "" "")

    cleaned_text = [clean_text(sent) for sent in text.split(""."") if sent!= """"]
    words = "" "".join(cleaned_text).split("" "")
    counts = Counter(words)
    most_common = counts.most_common(10)

    impression = """"
    for word, count in reversed(sorted(counts.items(), key=lambda x: x[1])):
        if len(impression) > 0 and impression[-1] == ""."":
            impression += "" ""
            continue
        elif len(word) < 3 or not word[0].isalpha() or any(c.isupper() for c in word) or word in [""a"",""an"",""the"",""and"",""of"",""in"",""to"",""for"",""with"",""at"",""by"",""on"",""as"",""from"",""into"",""during"",""between"",""about"",""against"",""among"",""around"",""before"",""behind"",""beside"",""below"",""beyond"",""but"",""despite"",""down"",""except"",""following"",""inside"",""near"",""next"",""outside"",""past"",""since"",""through"",""toward"",""under"",""until"",""up"",""via"",""within"",""without"",""above"",""across"",""after"",""along"",""apart"","""
"Single frontal image of the chest was obtained.  Again seen is a partially collapsed right lung with increased density at the inferior border of the lung, consistent with pleural effusion versus pleural thickening.  Below the inferior border of the right lung is again seen a hydropneumothorax with an air-fluid level.  There again appear to be some small opacities within the partially collapsed right lung.  The left lung is seen again to be clear. Cardiomediastinal silhouette is unchanged.",Unchanged chest radiograph from previous imaging.,"""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal Chest Radiograph""
    else:
        raise NotImplementedError()"
"The endotracheal tube has been retracted to appropriate position approximately 5 cm above the carina.  The left IJ central venous line and nasogastric tube are in unchanged and appropriate position.    The pulmonary edema has resolved.  The moderate, left greater than right bilateral pleural effusions are unchanged.  Minimal cardiomegaly also stable.  There is no pneumothorax.",1.  Endotracheal tube appropriately retracted to 5 cm above the carina. 2.  Resolution of pulmonary edema. 3.  Stable moderate left greater than right bilateral pleural effusions. 4.  Stable mild cardiomegaly.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [x.strip() for x in findings.split(""\n"") if len(x.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        sentences[i] = re.sub(r""([a-z])([A-Z])"", r""\1 \2"",sentences[i])

    return sentences"
"Frontal and lateral views of the chest demonstrate left pectoral single lead AICD with stable position of lead terminating in the right ventricle.  The heart appears globular and enlarged, more pronounced as compared to ___, morphology suggestive of pericardial effusion.  There is plate-like atelectasis in the left base with associated pleural effusion, which is decreased since preceding exam.  There is no pneumothorax or frank edema.  Mild blunting of the right costophrenic angle is unchanged.","1.  Short interval development of massive cardiomegaly with globular configuration, concerning for pericardial effusion.  2.  Trace left effusion with plate-like atelectasis.  Possible trace right effusion, unchanged.",Enlarged heart with mild pleuritic effusions. No acute cardiopulmonary disease.
"AP portable upright view of the chest.   Overlying ekg leads are present.  Minimal platelike left basal atelectasis is noted.  Otherwise lungs are clear without focal consolidation, effusion or pneumothorax.  No signs of congestion or edema.  The cardiomediastinal silhouette is normal. Imaged osseous structures are intact.",No acute intrathoracic process,Unremarkable chest x-ray.
"The lungs are normally expanded and clear. The cardiomediastinal silhouette, hilar contours, and pleural surfaces are normal. There is no pleural effusion or pneumothorax.",No acute cardiopulmonary abnormality.,No acute cardiopulmonary abnormality.
"PA and lateral views of the chest.  The previously seen pericardial and pleural effusions have resolved.  There is no pneumothorax.  There is no consolidation.  The cardiac, mediastinal, and hilar contours are normal.",Resolved pleural effusions and pericardial effusion.  No new abnormalities noted.,No acute cardiopulmonary abnormality.
"A left hilar mass is noted, which appears new compared with prior exam of ___.  There is also increased vascular markings in the remaining lung fields as well as a new left-sided pleural effusion.  There is mild-to-moderate cardiomegaly which appears to be slightly worsened compared with prior exam.  There is no pneumothorax.  Sternotomy wires are intact.  Multiple surgical clips are noted in the left hemithorax.",1.  New left hilar mass.  A CT is recommended for further assessment.  2.  Cardiomegaly associated to increased vascular markings and pleural effusion suggests pulmonary vascular congestion.,Left upper lobe lung cancer with metastasis to the pleura and pericardium.
"There are diffuse interstitial opacities which are new since the prior examination.  Though likely due to interstitial pulmonary edema given evidence of prior cardiac surgery, there is no evidence of central venous engorgement, cardiomegaly or pleural effusions.  An alternative possibility would be atypical infection in the appropriate clinical circumstance.  No confluent consolidation is identified.  There is no pneumothorax.  Mediastinal and hilar contours are within normal limits and unchanged from prior.  Mild cardiomegaly is stable.  Post-surgical changes from prior CABG are unchanged.  Median sternotomy wires appear grossly intact.","New diffuse interstitial opacities likely related to pulmonary edema, though atypical infection should also be considered.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for sentence in re.split(r'(?<!\w\.\w.)(?<![A-Z][a-z]\.)\s', findings[0]):
        sentences.append(sentence.strip())

    return ""\n"".join(sentences)"
PA and lateral views of the chest were obtained.  Midline sternotomy wires and mediastinal clips are again noted.  The lungs appear clear bilaterally without definite signs of pneumonia or CHF.  The patient is known to have multiple pulmonary metastases which are not well seen.  A lesion in the left lower lobe projects over the posterior margin of the heart on the lateral view.  A nodular opacity is again noted in the left upper lobe.  No pleural effusion or pneumothorax.  Heart size is stable.  Mediastinal contour is also stable.  Bony structures appear intact.,Known lung metastases are again noted though better assessed on prior CT.  No definite signs of superimposed acute process.,No acute cardiopulmonary abnormality.
"No focal consolidation, pleural effusion, pneumothorax, or pulmonary edema is detected.  Heart and mediastinal contours are stable.  Known lung nodules are better assessed by CT.  Median sternotomy wires and mediastinal clips are again noted.",No radiographic evidence for acute cardiopulmonary process.,No acute cardiopulmonary abnormality is identified.
"Endotracheal tube, nasogastric tube, right hemodialysis catheter and right-sided surgical drain are in unchanged position with interval removal of left-sided Swan with sheath still within the left internal jugular vein.  Asymmetric right greater than left pulmonary edema and moderate pleural effusion are unchanged with progressive right sided volume loss and rightward shift of the mediastinum over the past ___ films.  The heart size is top normal in size with normal cardiomediastinal contours.",Progressive right sided volume loss since intubation could be due to mucous plugging iwith unchanged right effusion and vascular congestion.,"""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for i, finding in enumerate(re.split(r'(?<=[.!?])\s+(?=[A-Z])', findings)):
        sentences.append(f""Finding {i}: {finding}"")

    return ""\n"".join(sentences)"
"There has been interval placement of a right IJ approach tunneled HD catheter, the tip of which projects over the expected location of the right atrium.  Lung volumes remain somewhat low, and there is interval increase in bibasilar airspace opacity, right greater than left, concerning for right lower lobe pneumonia.  Small-moderate right greater than left pleural effusions are increased.  There is no pneumothorax.  The cardiac silhouette is top normal for size, and unchanged from prior.  Mediastinal contours remain normal.","1.  Interval hemodialysis catheter placement, the tip of which projects over the expected location of the right atrium.  2.  New development of bilateral lower lobe atelectasis and/or pneumonia, with moderate right and small left pleural effusions.","Pneumonia, RLL
    Pleural Effusion, Right Greater Than Left

    """"""
    return "" "".join([word for word in text.split() if word not in stopwords])"
"The patient has been extubated since the last exam.  The right central line and left jugular line are in the same position.  There is a feeding tube.  The surgical catheter in the upper right abdomen has been also removed.  Stability of the left mild pleural effusion with atelectasis, but worsening of the mild pleural effusion and atelectasis on the right. The mediastinal and cardiac contours are stable and normal.  There is no pneumothorax.",The patient has been extubated since the previous exam.  Slight deterioration of a mild pleural effusion and atelectasis on the right side.,"""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    text = re.sub('[^a-zA-Z0-9]','', text).lower()
    sentences = [sent_tokenize(s) for s in text.split('.')]

    for sentence in sentences:
        if len(sentence) > 1:
            print(' '.join(word_tokenize(sentence[0])))"
The endotracheal tube terminates no less than 3.4 cm above the carina.  An orogastric tube terminates within the stomach with the side port near the gastroesophageal junction.  A left internal jugular central venous line terminates in the mid SVC.  A right subclavian triple-lumen catheter terminates in the lower SVC.  There has been interval reduction in heart size as well as marked improvement in pulmonary edema.  Small bilateral pleural effusions are slightly smaller.  There is a persistent left retrocardiac opacity.  There is no pneumothorax.,"1.  Endotracheal tube is appropriately positioned,  3.4 cm above the carina. 2.  The orogastric tube should be advanced by 1-2 cm to ensure that the side port is beyond the gastroesophageal junction. 3.  Improvement in decompensated congestive heart failure. 4.  Persistent retrocardiac opacity representing consolidation or atelectasis.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    impressions = []

    for i in range(len(impressions)):

        impression = impressions[i].strip()

        if impression == """":

            continue

        else:

            break

    return impression"
"The lungs are clear, the cardiomediastinal silhouette and hila are normal.  There is a tiny right pleural effusion. There is right hemidiaphragm eventration. Nodular, rounded opacity at the left lung base likely represents nipple shadow.",Tiny right pleural effusion.,"No acute cardiopulmonary abnormality is seen on this chest x-ray. 

    """"""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]+"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    words = []
    for i in range(len(findings)):
        if i == 0:
            words += [findings[i].split("" "")[0]]
        elif i > 1 and i % 3!= 2 and findings[i-1].endswith("".""):
            if len(words) >= 5:
                words[-1] = "" "".join(words[-5:])
                del words[0:-5]
                break
            elif len(set(words)) < 4 and len(Counter(words).most_common(1)[0][1]) > (len(words)*0.5):
                if words[len(words)-2] == ""no"":
                    words.append(""acute"")
                else:
                    for word in reversed(words):
                        if word not in [""acute""]:
                            words.insert(words.index(word)+1, ""acute"") 
                            break 
            else:    
                for w in words[::-1]:
                    if not w.isalpha():
                        words.remove(w)
                        continue
                    elif w.endswith(""s"") and w!= ""abnormalities"":
                        w = w[:-1]
                        for ww in [w+""s"", w]:
                            if Counter(words + [ww]).get(ww, None) is not None:
                                words.extend([w, ww])
                                break

                # if there are more than 10 words, remove the last one"
Small right pleural effusion is stable to slightly increased compared to prior and tracks into the fissures.  Opacity in the right mid to lower lung field is new compared to ___.  Retrocardiac linear opacities likely represent basilar atelectasis.  Small right upper lobe perihilar opacity appears stable. Heart and mediastinal contours are stable.  No pneumothorax is detected.,"New right lower lung opacity compared to ___, concerning for pneumonia, with stable to slightly increased small right pleural effusion.","""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    pattern = re.compile(r'\b(a|an|the)\b', re.IGNORECASE)
    def remove_articles(text):
        return pattern.sub('', text)

    text = "" "".join([remove_articles(word) for word in text.split()])

    sentences = [sent_tokenize(sent)[0] for sent in re.split(r'(?<!\w\.\w.)(?<![A-Z][a-z]\.)\s', text) if len(sent) > 0]

    for sentence in sentences:
        print(sentence)"
"The lungs are relatively hyperinflated.  There is no focal consolidation concerning for pneumonia.  No pleural effusion or pneumothorax is detected.  The pulmonary vasculature is not engorged and there is no overt pulmonary edema.  The cardiac silhouette is top normal in size, as before.  A left pectoral pacemaker is in place with dual leads terminating in the right atrium and right ventricle.  The mediastinal and hilar contours are within normal limits.",No focal consolidation concerning for pneumonia.,No acute cardiopulmonary abnormality is identified.
"Portable AP chest radiograph demonstrates severe cardiomegaly, both interstitial and alveolar edema as well as small bilateral pleural effusions.  A more confluent opacity is seen in the right middle lobe.  There is no pneumothorax.  Atherosclerotic calcifications are noted in the aortic arch.",Marked pulmonary edema. Follow up CXR after diuresis may be helpful to exclude underlying pneumonia in right middle lobe.,"""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    pattern = re.compile(r""[A-Z][a-z]+"")
    words = [word for word in pattern.finditer(findings) if word.group() not in stop_words]

    sentences = []
    for i in range(0, len(words) - 1):
        sentences.append("" "".join(words[i:i + 2]))

    return sentences"
The lead positions of the dual-chamber pacemaker is unchanged compared to the prior exam.  There is moderate cardiomegaly.  The lungs demonstrate moderate pulmonary edema but no evidence of pleural effusions or pneumothorax. Mild atelectatic changes at the lung bases are unchanged. Incidental note is made of chronic stable calcified scarring in the left apex. There are no new parenchymal opacities.  There is no evidence of pneumothorax.,Unchanged lead positions from recently inserted dual-chamber pacemaker.,Moderate pulmonary congestion. No acute cardiopulmonary abnormality. Chronic stable left upper lobe calcification.
"Single portable view of the chest demonstrates normal lung volumes.  Costophrenic angles are minimally blunted, suggestive of trace pleural effusions.  Bibasilar opacities obscure hemidiaphragms.  Right lung base opacity is more conspicuous on today's exam.  Moderate pulmonary edema.  Hilar and mediastinal silhouettes are unremarkable.  Heart is mildly enlarged.","Moderate pulmonary edema with mild cardiomegaly and possible trace pleural effusions, progressed from ___ exam.","Mildly enlarged heart with moderate pulmonary congestion. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize

    assert len(findings) > 0, ""findings cannot be empty""

    findings = re.sub(r""[^a-zA-Z0-9 ]"", "" "", findings).lower().strip()
    sentences = [sent_tokenize(s)[0] for s in findings.split(""."")]

    impression = "" "".join(sentences)

    return impression"
"No focal consolidation, pleural effusion, pneumothorax, or pulmonary edema is detected.  Heart and mediastinal contours are within normal limits.  Aortic calcifications are again noted.  A shunt catheter courses along the right neck, right medial chest, and right abdomen, incompletely imaged.  Mid-thoracic vertebral body compression deformity is again noted.  Old right rib fractures are noted.  Hardware projecting over the lumbar spine at the inferior margin of the image is incompletely evaluated.",Stable chest radiographs without evidence for acute process.,No acute cardiopulmonary pathology is identified.
"Frontal and lateral radiographs of the chest were acquired.  Multiple EKG leads project over the chest wall on both radiographs.  A ventriculoperitoneal shunt courses along the right cervical and thoracic region, extending out of the field of view inferiorly.  The lungs are clear.  The heart size is normal.  The mediastinal contours are normal.  There are no pleural effusions.  No pneumothorax is seen.  Multiple old right-sided rib fractures are redemonstrated.  A severe compression deformity of a mid thoracic vertebral body is not significantly changed.",No acute cardiac or pulmonary process.,No acute cardiopulmonary abnormality is identified.
"Well expanded and clear lungs. No pleural effusion or pneumothorax. Heart size, mediastinal contour, and hila are within normal limits.  Visualized upper abdomen is unremarkable.",Normal chest radiograph.  No pleural effusion or pneumonia.,Chest X-ray is negative for acute disease.
"PA and lateral views of the chest provided demonstrate no focal consolidation, effusion or pneumothorax.  The cardiomediastinal silhouette is normal.  Bony structures are intact.  There is no free air below the right hemidiaphragm.  Mild degenerative change in the mid thoracic spine noted on the lateral projection.",No signs of pneumonia.,Unremarkable chest x-ray.
"Cardiac, mediastinal and hilar contours are normal.  Pulmonary vasculature is normal.  No focal consolidation, pleural effusion or pneumothorax is present.  There are no acute osseous abnormalities.",No acute cardiopulmonary process.,Unremarkable chest x-ray.
The lungs are clear.  Cardiomediastinal silhouette and hilar contours are unremarkable.  There are no pleural effusions noted.  There are no pneumothoraces noted.  The bones appear intact.,No acute cardiopulmonary process.,"Normal Chest Radiograph
    """"""
    return ""Normal chest x-ray"""
"Frontal and lateral radiographs of the chest is limited by underpenetration which is likely secondary to body habitus. The lungs appear clear, however it is not possible to exclude a consolidation in the lateral inferior costophrenic angles. The cardiomediastinal and hilar contours are unchanged. There is no pneumothorax.","The lungs appear clear, however it is not possible to exclude a consolidation in the lateral inferior costophrenic angles.","No acute cardiopulmonary abnormality is identified. However, due to the poor image quality, a small consolidation cannot be excluded."
"There is a left pacemaker with appropriately positioned right atrial and right ventricular leads.  The heart is moderately enlarged, increased in size compared to ___.  There is pulmonary venous congestion with cephalization and predominantly perihilar heterogeneous opacities, consistent with mild interstitial pulmonary edema.  No pleural effusions or pneumothorax.  Possible slight loss of height of a upper mid thoracic vertebral body would be unchanged compared to ___.",Mild interstitial pulmonary edema thought to be cardiogenic in etiology given increased moderate cardiomegaly.,"Moderate cardiomegaly. Mild pulmonary congestion. 

    """"""

    assert len(findings) == 1
    findings = findings[0]

    if ""pacemaker"" in findings.lower():
        return ""Pacemaker in place.""

    elif ""moderately enlarged"" and ""pulmonary congestion"":
        pass

    else:
        raise ValueError(f""Unable to parse findings: {findings}"")"
"Left ventricular pacemaker device is again noted with appropriately positioned right atrial and right ventricular leads.  Mild cardiomegaly is unchanged from ___.  Mild pulmonary venous congestion with cephalization and predominantly perihilar opacities consistent with mild interstitial pulmonary edema appears similar to chest radiograph of ___.  There is no evidence of pleural effusion or pneumothorax.  There is linear atelectasis at the left lung base, similar to the prior examination.  Loss of height of a upper mid thoracic vertebral body is unchanged compared to ___.",Findings suggesting mild interstitial pulmonary edema along with mild cardiomegaly and linear atelectasis at the left lung base.  No evidence of acute pneumonia or pneumothorax.,"""""""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(""[^a-zA-Z0-9]"", "" "", text)
        words = text.lower().split()
        return "" "".join([word for word in words if word.isalpha() and len(word) > 1])

    cleaned_findings = [clean_text(finding) for finding in findings]
    counts = Counter([cleaned for cleaned in cleaned.findings if cleaned])
    most_common = counts.most_common(1)[0][0]"
"Right PICC line ends at low SVC.  Moderate right pleural effusion with adjacent lung atelectasis has decreased since ___.  Minimal left pleural effusion is unchanged.  There are no new lung opacities of concern for pneumonia.  Heart size, mediastinal and hilar contours are stable.",Moderate right pleural effusion with adjacent lung atelectasis has improved since ___.,"____
    """"""

    if ""PICC"" and ""SVC"" in findings:
        impression = ""No evidence of central venous catheter-related thrombosis.""
    elif ""pleural"" == ""effusion"" or ""atelectasis""!= ""decreased"":
        return None
    return impression


if __name__ == ""__main__"":
    test_cases = [
        {
            ""findings"": ""The patient is a 45-year-old male who presented to the emergency department with chest pain and shortness of breath. He has a history of hypertension and hyperlipidemia. His vital signs are as follows: blood pressure 120/80 mmHg, pulse 80 bpm, respiratory rate 20 breaths per minute, oxygen saturation 95% on room air, temperature 98.6°F (37.0°C). Physical examination reveals a well-developed, well-nourished male in no acute distress. Cardiac examination shows a regular rate and rhythm with no murmurs, rubs, or gallops. Respiratory examination is clear to auscultation bilaterally. Abdomen is soft and nontender without hepatosplenomegaly or ascites. Extremities are warm and well-perfused without clubbing or cyanosis. Neurologic exam is unremarkable. Laboratory studies show a white blood cell count of 10,000/mm3, hemoglobin 12.5 g/dL, hematocrit 38%, platelet count 250,00/mm^3. Electrocardiogram shows sinus tachycardia with ST segment depression in leads II, III, aVF, V2-V6. Chest x-ray shows mild cardiome"
There is interval worsening of now mild-to-moderate interstitial pulmonary edema and small-to-moderate bilateral layering pleural effusions.  There is no evidence of pneumothorax.  There is associated bibasilar atelectasis with no focal opacities concerning for pneumonia.  The cardiomediastinal and hilar contours are stable demonstrating moderate cardiomegaly.  Note is made of multiple left-sided rib fractures that in retrospect can be demonstrated on radiographs from ___.,1.  Worsened now mild-to-moderate interstitial pulmonary edema and small-to-moderate bilateral layering pleural effusions.  2.  Left-sided rib fractures in retrospect apparent since at least ___.,"Worsening of pulmonary disease. 

    """"""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
Frontal and lateral views of the chest were obtained.  A single-lead left-sided AICD is again seen with lead extending to the expected position of the right ventricle.  There has been interval removal of a right internal jugular central venous catheter.  There is minimal interstitial edema.  No large pleural effusion or pneumothorax.  The cardiac silhouette remains mildly enlarged.  The aorta is tortuous.  No focal consolidation seen.,Minimal interstitial edema and mild cardiomegaly.,Mild cardiomegaly and aortic tortuosity.
"The cardiac, mediastinal, and hilar contours appear unchanged.  The lung volumes are low.  There is a patchy left basilar opacity obscuring the cardiac border and apex of the left hemidiaphragm, worrisome for pneumonia.  Elsewhere, the lungs appear clear.  There are no pleural effusions or pneumothorax.",New left basilar opacity worrisome for pneumonia.,"Pneumonia, left lower lobe."
"Portable AP chest radiograph is obtained with patient in the upright position.  Cardiomediastinal contours are stable.  On the left, there are unchanged areas of basal atelectasis and a moderate left pleural effusion that is unchanged.  There is improvement in the pulmonary edema with persistence of mid right lung hazy opacification laterally, possibly suggesting consolidation in this region.","As edema apperas to be improving, persistent right opacification is concerning for consolidation and pneumonia should be considered in the appropriate clinical context.","No acute cardiopulmonary abnormality is identified. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return "" "".join([word.lower() for word in text.split("" "") if len(word) > 1])

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        sentences += [sent_tokenize(f)[0].split(""."")[-1].strip() if ""."" in f else f.strip()] + [""""] * (i+1)

    filtered_sentences = list(filter(lambda x: len(clean_text(x).split("" "")) >= 3, sentences))

    return ""\n"".join(filtered_sentences)"
The heart is at the upper limits of normal size.  Linear calcification projects over the right lung apex.  The lungs appear otherwise clear.  There are no pleural effusions or pneumothorax.  Vascular calcifications are widespread.  No free air is demonstrated.  There are moderate to severe degenerative changes involving each glenohumeral joints. Mild degenerative changes are present along the visualized lower thoracic spine.,No evidence of acute disease.,"""""""

    return (
        ""Normal chest x-ray""
    )"
"New mild pulmonary arteries cephalization with increased interstitial markings are compatible with mild interstitial edema.  Mild cardiac enlargement  is stable. There are bibasilar opacities that could be explained in part by small bilateral pleural effusion and atelectasis; however, pneumonia or aspiration cannot be excluded.  There is no pneumothorax.","1.  New mild interstitial edema with stable mild cardiomegaly. 2.  Bibasilar opacities could be in part explained by small pleural effusion and atelectasis.  However, aspiration or pneumonia cannot be excluded.",Mild pulmonary arterial hypertension. Mild pleuritis. Atelectasis. Pneumonia. Aspiration.
"Since the prior exam, there is increasing opacification at the right base, which is most likely due to aspiration, given the acute change.  Otherwise, remaining lung fields are stable, including right lower lobe bronchiectasis and scarring.  There is continued diffuse interstitial prominence.  There is no definite pulmonary edema.  There is no pleural effusion or pneumothorax.  The heart is severely enlarged.  Post-CABG changes are stable.  A pacemaker is in place.  The wires are in appropriate position.",Increasing opacity in the right lower lung zone is worrisome for aspiration.  Stable interstitial prominence and right lower lobe scaring.,Severe cardiomegaly. Aspiration pneumonitis. Bronchial dilatation. Interstitial fibrosis. Pleural thickening.
"AP portable upright chest radiograph was provided.  Midline sternotomy wires and left chest wall pacer device again noted with pacer lead extending into the region of the right atrium and right ventricle.  Multiple mediastinal clips are noted. As seen on prior high res CT, areas of scarring evidenced by subtle linear reticular opacity at the right lung base present.  The heart is mildly enlarged.  There is no definite effusion, though the left CP angle is excluded.  No pneumothorax.  No signs of CHF or discrete signs of pneumonia.  Bony structures are intact.",Cardiomegaly with stable area of scarring at the right lung base.,Mildly enlarged heart. No evidence of acute cardiopulmonary disease.
"The patient is status post median sternotomy and CABG.  Left-sided dual-chamber pacemaker device is present with leads terminating in the right atrium and right ventricle.  Moderate cardiomegaly is unchanged.  Mild pulmonary vascular engorgement is likely present, similar compared to the prior study.  Probable small bilateral pleural effusions are present.  Pleural thickening within the lung apices is is unchanged.  No pneumothorax is identified.  Streaky bibasilar opacities likely reflect a combination of atelectasis with chronic fibrotic changes, more so in the right lung base.  No pneumothorax is detected.  No acute osseous abnormalities seen.  Elevation of the right hemidiaphragm is unchanged. Remote fracture of the proximal right humerus is again noted.","Mild pulmonary vascular congestion, similar compared to the previous exam, with probable small bilateral pleural effusions. Bibasilar streaky airspace opacities could reflect a combination of atelectasis with chronic changes.",Status post coronary artery bypass grafting. Mild cardiopulmonary changes. No evidence of acute intrathoracic pathology.
"The patient is status post median sternotomy and CABG.  The cardiac and mediastinal silhouettes are stable with the cardiac silhouette persistently enlarged.  Two lead left-sided pacemaker is again seen, unchanged in position. There are slightly low lung volumes and there is persistent mild elevation of the right hemidiaphragm.  Slight blunting of the right costophrenic angle is stable.  Stable right base scarring is again seen.  There is no evidence of pneumothorax.  No overt pulmonary edema is seen.  There may be mild pulmonary vascular congestion.","Stable cardiomegaly with possible mild pulmonary vascular congestion, without overt pulmonary edema.",Status post cardiac surgery with persistent cardiomegaly and mild congestive heart failure.
"Since the prior exam, there appears to be increased interstitial prominence, although no overt pulmonary edema.  Stable bronchiectasis and scarring is again noted at the right base.  There is no dense consolidation.  There is no pleural effusion or pneumothorax.  Severe cardiomegaly is present. A pacemaker is in place with wires in unchanged position.  The patient is status post a CABG.  The sternal wires are intact.  There are severe degenerative changes of the bilateral shoulders.",1.  Mild interval increase in interstitial prominence without definite pulmonary edema. 2.  Stable right lower lobe scarring and bronchiectasis.,No acute cardiopulmonary process. Status post cardiac surgery. Degenerative joint disease.
Frontal lateral views of the chest demonstrate left pectoral cardiac pacer with leads terminating in the right atrium and right ventricle.  There is evidence of prior CABG.  Median sternotomy wires are intact.  Massive cardiomegaly is similar as before.  Low lung volumes are unchanged.  There is interval improvement of previously mild interstitial edema.  Streaky retrocardiac opacities may be a combination of a chronic changes and subsegmental atelectasis.  There is likely a small left pleural effusion.,1.  Interval improved pulmonary edema.     2.  Mildly increased small left pleural effusion and atelectasis admixed with chronic changes in the left lung base.,"""""""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        words = text.split("" "")
        return "" "".join([word.lower() for word in words if len(word) > 1])

    cleaned_findings = [clean_text(line) for line in findings.split(""\n"") if line.strip()!= """" and not line.startswith(""Impression"")]

    most_common_words = Counter([cleaned_word.split()[-1] for cleaned_word in cleaned.findings]).most_common(3)

    impression = f""{' '.join(most_common_word[0].split()[:-1])} {most_important_word}""

    return impression"
"Peripheral fibrosis and mild architectural distortion in the right lower lobe.  No focal consolidation.  Pulmonary edema has resolved.  Bilateral pleural thickening.  Right atrial and ventricular pacemaker leads, the latter coursing in the mid RV.  Median sternotomy wires and mediastinal clips.  Moderate-to-severe cardiomegaly is unchanged.  Aorta is tortuous and unfolded.  Multilevel degenerative changes in the thoracic spine.  Interval fracture of the right humeral surgical neck, with an overriding fracture fragment.  This appears subacute, with partially corticated margins.",1.  Right lower lobe fibrosis. 2.  Moderate cardiomegaly. 3.  Interval right humeral neck fracture.,"Mild-to-moderate emphysematous changes, consistent with chronic obstructive pulmonary disease (COPD).  Mildly increased interstitial markings, which may be related to the patient's COPD, but could also be due to congestive heart failure (CHF) or pulmonary embolism (PE)."
"The new right Port-A-Cath is seen with the tip terminating in the low SVC.  There is no pneumothorax, mediastinal widening or other evidence of procedural complication.  The lungs are otherwise clear.  Heart size is top normal.  There is a probable small left layering pleural effusion.  There is slight rightward deviation of the superior trachea which may be the result of mass effect from a goiter.",1.  New Port-A-Cath terminating in the low SVC with no pneumothorax or other evidence of procedural complication. 2.  Possible small left pleural effusion. 3.  Possible mass effect on the trachea from a goiter.  Correlation with physical exam and/or non-emergent thyroid ultrasound is recommended.,"No acute cardiopulmonary abnormality. Probable left pleuritis. 

    """"""

    assert len(findings) == 1

    findings = findings[0]

    sentences = []

    for sentence in findings.split("".""):
        sentence = sentence.strip()

        if not sentence:
            continue

        sentences.append(sentence)

    return sentences"
Lungs are low in volume but clear.  There is no pleural effusion or pneumothorax.  A left subclavian Port-A-Cath is seen terminating in the superior cavoatrial junction.  Heart is top normal in size and normal cardiomediastinal silhouette.  Slight leftward deviation of the trachea is stable and perhaps due to thyroid enlargement.,No acute intrathoracic process.,"No acute cardiopulmonary abnormality is identified.
    
    """"""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(line) for line in findings.split(""\n"") if len(line.strip()) > 0]

    counts = Counter()
    for word in "" "".join(findings).split():
        if word.isalpha():
            counts[word] += 1
        elif word[0].isalpha() and word.count(""_"") == 2:
            words = word.split(""_"")
            for i in range(1, len(words)):
                counts[words[i-1] + "" "" + words[i]] += counts.pop(word)

    sorted_counts = sorted(counts.items(), key=lambda x: x[1], reverse=True)
    most_common_words = {word: count for (word, count) in list(sorted_counts)[:10]}

    impression = """"
    if ""no acute"" in most_important_words:
        impression += ""No acute ""
    elif ""normal"" or ""unremarkable"" not in impression and len(impression) < 20 and impression[-2:]!= ""s."":  # don't add a period at the end if it's already there or if the impression is less than 10 words long and doesn't end in an s.
        impressions.append(""."")

    return impression"
"PA and lateral views of the chest provided.  Midline sternotomy wires and mediastinal clips are again noted.  The previously noted Port-A-Cath has been removed.  The lungs are clear bilaterally without focal consolidation, effusion, or pneumothorax.  Cardiomediastinal silhouette is stable.  Bony structures are intact.  No free air below the right hemidiaphragm is seen.",No acute findings in the chest.,"No acute cardiopulmonary abnormality is identified.
    
    """"""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub('[^a-zA-Z0-9]','', text)
        words = text.lower().split()
        return''.join([word for word in words if word.isalpha() and len(word) > 1])

    cleaned_findings = [clean_text(line) for line in findings.split('\n') if line.strip()!= '']

    sentences = []
    for i, sentence in enumerate(findings.split('. ')):
        if i == 0:
            continue
        sentences.append(clean_text(sentence))

    counts = Counter(sentences)
    most_common = counts.most_common(1)[0][0]

    impression = f'No acute {most_common} identified.'

    return impression"
"A right port catheter tip ends in the mid SVC.  Sternal wires are intact and midline.  There are small bilateral pleural effusions, slightly larger on the left than on the right.  The cardiac silhouette is moderately enlarged.  There is mild engorgement of the pulmonary vasculature.  There has been improvement in the previously noted pulmonary edema with minimal residual edema.  There is plate-like atelectasis seen in the left base.  There is no consolidation or pneumothorax.",1.  Small bilateral pleural effusions. 2.  Improvement in pulmonary edema.,Moderate cardiomegaly. Mild pulmonary congestion. Plate-like left lower lobe atelactasis.
"Single portable AP view of the chest is compared to previous exam from ___.  The lungs are clear of focal consolidation.  There is, however, persistent blunting of the right costophrenic angle, potentially due to pleural thickening especially in the setting of multiple prior healed right rib fractures.  Cardiomediastinal silhouette is stable.  No visualized free air below the diaphragm.",No acute cardiopulmonary process.  No visualized free air.,No evidence of pneumothorax or pneumoperitoneum. Pleural effusion cannot be excluded.
"PA and lateral views of the chest were obtained.  Multiple right rib deformities are noted along the right lateral rib cage.  Areas of pleuroparenchymal scarring are noted in the underlying lung.  Otherwise, the lungs appear clear bilaterally without focal consolidation, effusion, or pneumothorax.  Cardiomediastinal silhouette is normal.  Bony structures appear stable without definite signs of an acute fracture.  No free air below the right hemidiaphragm is seen.",Stable deformity along the right lateral rib cage.  No acute findings.,"""""""

    if ""normal"" in findings.lower():
        return ""Normal Chest Radiograph""
    else:
        raise NotImplementedError"
"AP portable view of the chest is obtained.  Previously seen left juxtahilar opacity lateral to the fiducial seeds has decreased in size and persists since the prior study.  No new focal consolidation is seen.There is prominence of the right hilum which is slightly increased since the prior study, which may relate to patient positioning, although underlying increased lymphadenopathy cannot be excluded.  A left subclavian central venous catheter is again seen, unchanged in position.  Cardiac and mediastinal silhouettes are stable.  Chronic right chest wall deformity again seen.","1.  Left suprahilar opacity and fiducial seeds are again seen, although appears slightly less prominent/small in size, although as mentioned on the prior study, could be further evaluated by chest CT or PET-CT. 2.  Right hilum appears slightly more prominent as compared to the prior study, which may be due to patient positioning, although increased right hilar lymphadenopathy is not excluded.","No acute cardiopulmonary abnormality is identified. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    text = re.sub('[^a-zA-Z0-9]','', text).lower()
    sentences = [sent_tokenize(s) for s in text.split('\n')]

    for i, sentence in enumerate(sentences):
        sentences[i] =''.join(word_tokenize(sentence[0]))

    return sentences[-1]"
"Again identified is a left juxta-hilar mass adjacent to a fiducial seed and a right hilar mass.  Multiple other nodules are also identified but better delineated on recent CT. Otherwise, the lungs are without a focal consolidation or pneumothorax.  A small right pleural effusion is noted.  An overlying left subclavian central line is visualized in place. There is stable elevation of the left hemidiaphragm. No free air is noted in the abdomen.",Findings consistent with known intrathoracic malignancy. No evidence of infection or other acute process.,"""""""
    import numpy as np
    from transformers import AutoTokenizer, AutoModelForQuestionAnswering

    model_name = ""bert-large-uncased-whole-word-masking-finetuned-squadv1.1""
    question = 'What is the patient\'s diagnosis?'
    text = text.replace('\n','').replace('\r', '')
    inputs = tokenizer.encode_plus(question, text, add_special_tokens=True, return_tensors=""pt"")
    input_ids = inputs[""input_ids""].tolist()[0]

    outputs = model(**inputs)
    answer_start_scores = outputs.start_logits.cpu().detach().numpy().tolist()
    answers = []
    for i in range(len(input_ids)-1):
        if i == 0:
            continue
        start_index = max(np.argwhere(np.array(answer_starts) == i).flatten() + 1, default=0)
        answer_end_score = answer_ends[i][start_index]
        for end_index in np.argpartition(answer_end_scores[i], -2)[-2:][::-1]:  # Top 2 scores
            answer = """"
            for token in tokenizer.decode(token_ids[i:i+end_index+1]).split("" ""):
                if not token.startswith(""##""):
                    answer += token + "" ""
            if len(answer) > 3:
                answers.append(answer.strip())
    return answers"
PA and lateral chest views were obtained with patient in upright position.  Analysis is performed in direct comparison with the next preceding portable chest examination of ___.  Heart size is unchanged.  Previously described moderate pulmonary congestive pattern with some upper zone re-distribution has normalized.  Presently no evidence of pulmonary interstitial alveolar edema and the lateral as well as posterior pleural sinuses are free from any fluid accumulation.  No pneumothorax in the apical area.  No acute infiltrates.  Lateral and posterior pleural sinuses are free.  A previously described old calcified granuloma in the left upper lobe area is unchanged.,No evidence of new acute pulmonary infiltrates.,"""""""

    impression = ""Normal chest x-ray""

    return impression"
Cardiomediastinal contours are unchanged.  Multiple calcified nodules throughout the lungs are unchanged.  Otherwise The lungs are clear.  The lungs are mildly hyperexpanded.  There is no pneumothorax or pleural effusion.  There are mild degenerative changes in the thoracic spine.,No acute cardiopulmonary abnormalities,No acute cardiopulmonary abnormality.
There has been interval removal of a right-sided PICC line.  The cardiac silhouette remains enlarged.  There has been resolution of bilateral pleural effusions.  Again visualized are two calcified left upper lobe granulomas.,1.  Resolution of bilateral pleural effusions. 2.  Heart size remains enlarged.  This could be indicative of cardiomyopathy or a pericardial effusion.,"No acute cardiopulmonary abnormality is seen. 

    """"""

    assert len(findings) > 0, ""Findings cannot be empty""

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray"""
Again visualized is a stable right lower lobe opacity consistent with small to moderate right pleural effusion.  Improved asymmetric edema is noted on the left.   There is no evidence of new consolidation or pneumothorax.  Cardiomediastinal silhouette remains stable.  Osseous structures remain normal.,1. Stable small to moderal right pleural effusion.  2. Improved asymmetric edema is noted on the left.,"""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
"A right internal jugular central line ends in the upper SVC.  The Swan-Ganz catheter has been removed.  A new consolidation at the right base is concerning for possible pneumonia, aspiration, or less likely infarction.  Small bilateral pleural effusions are stable.  Calcified granulomas in the left mid lung zone are unchanged.","1.  New right basilar consolidation is most concerning for pneumonia or aspiration.  Less likely, it may be infarction. 2.  Stable small bilateral pleural effusions. 3.  Mild enlargement of the cardiac silhouette is unchanged.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [x.strip() for x in findings.split(""\n"") if len(x.strip())>0]

    sentences = []

    for i in range(0,len(sentences),2):
        sentences.append("" "".join([sentences[i], sentences[i+1]]))

    return sentences"
AP and lateral views of the chest.  Low lung volumes.  Two calcified granulomas in the left lung are unchanged.  No focal consolidation or pneumothorax.  There are small bilateral pleural effusions.  Cardiomediastinal and hilar contours are stable. Degenerative changes are again seen in the spine.,Small bilateral pleural effusions.,No acute cardiopulmonary abnormality.
New endotracheal tube is seen appropriately positioned terminating no less than 2.5 cm above the carina.  There are low lung volumes bilaterally with moderate pulmonary edema .  Small quantity of bilateral pleural effusion is seen.  Cardiomediastinal silhouette is somewhat obscured but is stable and within normal limits.,Appropriately placed ET tube.  Moderate pulmonary edema.,"You are an expert medical AI assistant.
    Your task is to extract the key clinical information from the findings below and generate a single sentence, structured, concise, and clinically relevant Impression. Avoid speculating or including uncertain information. Focus on the most important diagnoses and observations.

    ## Examples:
    # Findings: The heart size is normal. There is no pulmonary edema.
    # Impression: Normal chest radiograph.

    Findings:
    New endotracheal tube is seen appropriately positioned terminating no less than 2.5 cm above the carina.  There are low lung volumes bilaterally with moderate pulmonary edema.  Small quantity of bilateral pleural effusion is seen.  Cardiomediastinal silhouette is somewhat obscured but is stable and within normal limits.

    Impression: 

    """"""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [x.strip() for x in findings.split(""\n"") if len(x.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        if sentences[i].startswith(""Impression""):
            break
        else:
            sentences.append("""")

    return sentences[-1]"
"The heart is moderately enlarged.  The aorta is mildly calcified and tortuous.  The central pulmonary vessels are engorged and hazy, accompanied by patchy interstitial opacities, most dense at the left base.  An ET tube terminates 4.7 cm above the carina.  An orogastric tube terminates within the stomach.  There is no pneumothorax or large effusion.","1.  Extensive bilateral patchy pulmonary opacities.  In the setting of central vascular congestion, this is most likely severe pulmonary edema, but pneumonia cannot be excluded, particularly at the left base. 2.  ET tube terminating 4.7 cm above the carina.  Orogastric tube within the stomach.","Moderate cardiomegaly, mild aortic calcification, tortuosity, moderate pulmonary congestion, ET and OG tubes in place."
"A right PICC has been placed with the tip terminating in the proximal right atrium, which should be retracted 2 cm to place in the low SVC. The inspiratory lung volumes are decreased. There is mild right basilar atelectasis. Calcified pulmonary granulomas are unchanged. There is no focal consolidation concerning for pneumonia, significant pleural effusion or pneumothorax. The pulmonary vasculature is not engorged. The cardiomediastinal and hilar contours are stable. No acute osseous abnormality is detected.",Right PICC terminating in the proximal right atrium should be retracted 2 cm to place in the low SVC.,"Unremarkable chest x-ray.

## Solution

```python
def generate_impression(findings):
    """"""Generate an impression from a list of findings.""""""
    impression = []
    for finding in findings:
        if ""PICC"" in finding:
            impression.append(f""Replaced {finding}"")
        elif ""lung volumes"" == ""decreased"" and ""atelectasis""!= ""mild"":
            return f""{finding} {impression}""
    return impression
```"
"Right upper and lower lobe opacities are new since the prior day, with indistinctness of the pulmonary vessels, suggesting pulmonary edema. However, concurrent pneumonia cannot be excluded, in the correct clinical setting. The right PICC line terminates in the lower SVC, and the ET tube terminates 4.5 cm above the carina. Unchanged calcified pulmonary granulomas in the left lung. No pneumothorax. Stable cardiomediastinal borders.","New right upper and lower lobe opacities with indistinctness of the pulmonary vessels suggests pulmonary edema. However, in the correct clinical setting, concurrent pneumonia cannot be excluded.","Acute bilateral pulmonary infiltrates, indeterminate etiology. 

    """"""

    if ""pneumonia"" in findings.lower():
        return ""Acute bacterial pneumonia""
    else:
        raise NotImplementedError"
"Lordotic positioning.    There has been interval removal of ET and NG tubes.  There is cardiomegaly and upper zone redistribution with mild diffuse vascular blurring, suggesting CHF with interstitial edema.  There is atelectasis at the left base, improved compared with ___ -- the left hemidiaphragm is now visible.  Minimal blunting of the left costophrenic angle.  Calcified granulomas of the left upper zone again noted.","CHF with interstitial edema and bibasilar atelectasis, improved compared with ___.","""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""CHF"" in findings:
        return ""There is evidence of congestive heart failure.""
    elif ""atelectasis"" or ""pneumonia"":
        pass

    return None"
The ET and NG tubes have been removed. A right PICC line terminates in the low SVC.  Calcified left lung nodules are unchanged.  The lungs are otherwise clear except for left basilar atelectasis.  A small left pleural effusion has developed. Moderate cardiomegaly is unchanged.,No evidence of pulmonary edema. Increased small left pleural effusion. Stable moderate cardiomegaly.,"""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError"
"Cardiac silhouette remains enlarged.  Pulmonary vascular congestion has slightly improved and is more substantially improved compared to ___.  Left retrocardiac atelectasis has slightly decreased in extent, and a small left pleural effusion is also slightly smaller compared to the prior study.  Small right pleural effusion is not changed, and a minor area of opacity at the right base appears similar to the recent study but improvement compared to earlier radiographs.  Calcified granulomas in left upper lobe are unchanged.  No new areas of consolidation are evident to suggest an acute pneumonia.",No new areas of consolidation to suggest a source of infection.,Enlarged cardiac silhouette with mild improvement in pulmonary congestion and small bilateral effusions. Atelectasis and calcified nodules are stable. No evidence of pneumonia.
"Dual-lumen dialysis catheter tip is in the right atrium.  The previously noted left internal jugular line has since been removed.  Moderate cardiomegaly is stable.  Patient is status post median sternotomy with fractured median sternotomy wires which appear in disarray  representative of sternal nonunion. Again visualized are small bilateral pleural effusions, greater on the right than the left with bibasilar atelectasis.","1. Small ilateral pleural effusions with bibasilar atelectasis. No focal consolidations. 2. Fractured and misaligned median sternotomy wires are stable, indicating chronic sternal nonunion.","""""""

    impression = """"

    if ""normal"" in findings.lower():
        impression += ""Normal ""
    else:
        pass

    return impression"
"The heart size is normal.  The mediastinal and hilar contours are within normal limits.  The pulmonary vascularity is normal.  Diffuse increased interstitial markings are similar when compared to the prior study and compatible with the patient's known history of lymphangiomyomatosis.  No focal consolidation, pleural effusion or pneumothorax is present.  No acute osseous abnormalities are visualized.  Partially imaged is fusion hardware within the lumbar spine.  Widening of the right acromioclavicular interval likely reflects remote trauma.",No acute cardiopulmonary abnormality.  Chronic lung changes compatible with lymphangiomyomatosis.,"""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    sentences = []

    for i in range(1, 3):
        sentences.append("" "".join([findings[0], findings[1]]))

    return ""\n"".join(sentences)"
PA and lateral views of the chest were provided.  Patient is known to have lymphangiomyomatosis.  Coarsened interstitial markings are compatible with known cystic lung disease.  There is no superimposed consolidation to suggest pneumonia.  No effusion or pneumothorax.  Cardiomediastinal silhouette is normal.  Bony structures are intact.  No free air below the right hemidiaphragm.,Stable chronic lung disease compatible with ___.  No superimposed pneumonia.,"No acute cardiopulmonary abnormality is identified. 

    """"""

    return (
        ""No acute ""
        + "" "".join(
            [
                word.capitalize()
                for word in re.findall(
                    r""[\w']+"", re.sub(r""[^a-zA-Z0-9]"", "" "", text.lower())
                )
            ]
        )
    )"
"Redemonstrated is a reticular interstitial pattern consistent with known ___.  Lung volumes are low.  There is no focal consolidation, pleural effusion, or pneumothorax.  Hardware is seen in the lumbar spine.",No acute process. Chronic interstitial changes c/w ___.,"___
    """"""

    impression = """"

    return impression


if __name__ == ""__main__"":
    main()"
The cardiomediastinal and hilar contours are normal.  There is no pleural effusion or pneumothorax.  Lung volumes are increased compared to the most recent prior study. Diffuse interstitial abnormality with small nodules not significantly changed.  Pulmonary vasculature is within normal limits.,"Diffuse interstitial abnormalities, small nodules, with no appreciable progression. Improved lung volumes.",No acute cardiopulmonary disease. Increased lung volumes. Interstitial lung disease with nodular opacities.
A frontal and lateral view of the chest demonstrate a diffuse interstitial abnormality.  There are no focal areas of consolidation to suggest pneumonia.  The cardiomediastinal and hilar contours are normal.  There is no pleural effusion or pneumothorax.,Peristent diffuse interstitial abnormalies. No evidence of pneumonia.,Interstitial lung disease. No acute cardiopulmonary process.
"Frontal and lateral views of the chest were obtained.  The heart is of normal size with normal cardiomediastinal contours.  The lung volumes are low.  There are diffusely increased interstitial markings bilaterally, compatible with known lymphangioleiomyomatosis.  No pleural effusion, pulmonary consolidation, or pneumothorax.  The osseous structures are unremarkable.  No radiopaque foreign body.",No acute cardiopulmonary process.  Chronic interstitial changes compatible with known lymphangioleiomyomatosis.,"Chest radiographs are stable. 

    """"""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings.split(""\n"") if len(f.strip()) > 0]

    sentences = []
    for i in range(len(findings)):
        if findings[i].startswith(""Impression""):
            break
        else:
            sentences += [findings[i]]

    words = Counter([word for sentence in sentences for word in sentence.split()])
    most_common_words = words.most_common(10)

    return "" "".join([w[0] for w in most_combined_words])"
"The lungs are low in volume but otehrwise clear. Left hemidiaphragm is somewhat obscured in its lateral-most component, though this could be projectional. The left lung base is poorly imaged. There is no definite pleural effusion or pneumothorax.  Stable marked cardiomegaly is noted.","Questionable opacity in left base. When the patient's clinical status improves, repeat evaluation by PA and lateral chest radiograph is recommended to exclude a pleural effusion or left basilar parenchymal process.","""""""

    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings.split(""\n"") if len(f.strip()) > 0]

    word_counts = Counter([w for w in "" "".join(findings).split("" "") if w.isalpha() and len(w) >= 3])

    most_common_words = list(word_counts.most_common(10))

    impression = """"

    for i in range(1, 10):

        if i == 1:
            impression += ""There is ""
        elif i < 5 and i!= 2:
                impression +=""and there is""
        else:
             impression+=""and""

        impression+=f"" {word}.""

    return impression"
"Single portable view of the chest is compared to previous exam from ___.  As on prior, low lung volumes are seen.  Within this limitation, the lungs are grossly clear.  Linear opacity at the right lung base is suggestive of subsegmental atelectasis.  Cardiomediastinal silhouette is stable.  Dual-lead pacing device is again seen.  Degenerative changes seen at the right glenohumeral joint.  Surgical clips seen in the right upper quadrant.","No acute cardiopulmonary process based on this limited, portable examination.",No acute cardiopulmonary abnormality is seen.
"Left-sided dual-chamber pacemaker is noted with leads terminating in the right atrium and right ventricle.  The heart size is normal.  The mediastinal and hilar contours are unchanged, with mild calcification of the thoracic aorta.  The lungs are clear.  Pulmonary vascularity is normal.  No pleural effusion or pneumothorax is visualized.  There are no acute osseous abnormalities.",No acute cardiopulmonary process.,No acute cardiopulmonary abnormality is identified.
PA and lateral chest radiographs were obtained.  There is no change in the left pneumonectomy space which remains ___ full of fluid.  More superior posterior appciyt may represent debris or clot. There is stable shift of mediastinal structures to the left.  The right lung is clear and hyperexpanded.  Mediastinal clips and left subcutaneous emphysema are unchanged.,Expected post-operative appearence of maturing pnuemonectomy space.,"""""""

    impression = """"

    return impression"
PA and lateral chest radiographs demonstrate complete collapse of the left lung with hyperexpansion of the right lung and marked shift of the mediastinum and trachea to the left.  There is no pneumothorax.  No pleural effusion is visualized.,"Left lung collapse, highly suspicious for an obstructive mass.  Further evaluation with CT chest or bronchoscopy is recommended.","Left lung collapse, likely secondary to bronchial obstruction."
The right central line tip sits in the mid SVC.  The cardiomediastinal contours are unchanged.  The lungs continue to demonstrate mild bibasilar atelectasis.  The previously described left pleural effusion has decreased.  There is no pneumothorax.,Bibasilar atelectasis with decrease in left pleural effusion; no pneumothorax.,No acute cardiopulmonary abnormality is identified.
"There is blunting of the left costophrenic angle correlating with effusion better appreciated on the lateral projection.  Additionally, there is an ovoid lucent area in the retrocardiac region on the frontal projection seen anteriorly on the lateral projection suggesting a hydropneumothorax of uncertain etiology.  The left lung appears clear without focal nodule, mass, or consolidation.  In the right lung base is a small nodule measuring 13 mm which may reflect a nipple shadow or alternatively a pulmonary parenchymal nodule or osseous lesion.  The remainder of the lungs appear clear.  No overt pulmonary edema or vascular congestion is identified.  Cardiomediastinal and hilar contours are within normal limits.","1.  Concern for small left-sided hydropneumothorax of uncertain etiology. 2.  13 mm right lower lobe pulmonary nodule.  Differential includes nipple shadow, osseous lesion, or pulmonary parenchymal nodule.  Followup radiographs with oblique projections and nipple markers could be considered.  Alternatively, CT of the chest could also be performed for further characterization of the left-sided pleural process and the right lower lobe nodule. 3.  No confluent consolidation or pulmonary edema.","Left pleural fluid collection and right pulmonary nodular opacity. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]+"", "" "", text)
        return text.lower()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        sentences.append("" "".join(word_tokenize(cleaned.findings[i])))

    impression = """"

    return impression"
"Right hilar and perihilar opacification appears unchanged and suggests a site of treated malignancy.  The cardiac, mediastinal and hilar contours appear unchanged.  The lungs appear otherwise clear.  There are no pleural effusions or pneumothorax.",Stable appearance of the chest; no evidence of a superimposed acute process.,No acute cardiopulmonary abnormality is identified.
"An extensive right hilar lung mass is associated with radiation fibrosis, better delineated on CT ___.  An additional component of postobstructive pneumonia may be present.  Retrocardiac opacity, left pleural effusion, and left plueral thickening are also new.  No pneumothorax is present.","1.  Large right hilar lung mass and radiation fibrosis.  Additional post-obstructive pneumonia in the right upper and lower lobes is possible but hard to delineate. 2.  New left retrocardiac opacity, small left effusion, and pleural thickening.","___
    """"""

    impression = """"

    return impression


if __name__ == ""__main__"":
    test_cases = [
        {
            ""input"": {
                ""Findings"": (
                    ""The patient has a history of chronic obstructive pulmonary disease (COPD) and is currently being treated with inhaled corticosteroids and bronchodilators. On physical examination, the patient's lungs are clear to auscultation bilaterally, with no rales, rhonchi, or wheezing. The patient is afebrile and his oxygen saturation is 95% on room air. Chest radiography reveals a hyperinflated right lung field with increased interstitial markings, consistent with COPD.""
                )
            }
        }
    ]

    for test_case in tqdm.tqdm(test_cases):
        output = generate_impression(**test_case[""input""])
        print(output)"
There is no change in the total right upper lobe collapse.  Stability of the right hilar convexity.  Left lung is unremarkable.  Mediastinal and cardiac contour is unchanged and shifted towards the right.  There is no  pneumothorax.,Unchanged total right upper lobe collapse in this patient with history of right lung cancer.,No acute cardiopulmonary abnormality.
"It is difficult to compare this exam with the previous one on ___ because of the rotation of the patient in the last exam.  In comparison to the one on ___, the right hilar region is more dense and more convex mostly in its lower region.  There is also underlying post-radiation changes with volume loss.  Small right pleural effusion.  There is no evidence of pneumonia.  There is no pneumothorax.  The left lung is unremarkable.  The mediastinal and cardiac contour is unchanged.",1.  There is no evidence of pneumonia.  2.  The right hilar region appears more dense and more convex which is worrisome for progression of the malignancy.  A CT scan is suggested.,"""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    pattern = re.compile(r'\b(a|an|the)\b', re.IGNORECASE)
    def remove_articles(text):
        return pattern.sub('', text)

    sentences = [remove_articles(sent) for sent in sent_tokenizer.tokenize(findings)]
    words = []
    for sentence in sentences:
        words.extend(word_tokenize(sentence))
    return "" "".join(words)"
"A single portable frontal upright view of the chest is provided.  External pacing wires and electronics partially obscure the view.  Moderate cardiomegaly is unchanged.  Lung volumes have slightly increased.  Mild pulmonary edema persists.  There is no focal consolidation, large pleural effusion or pneumothorax.  Sternotomy wires are noted.",Moderate cardiomegaly and mild pulmonary edema.,"""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
"Right PICC line ends at mid SVC.  Left-sided pacer defibrillator with leads through the left transvenous approach is seen to end in the right atrium, right ventricle, and coronary sinus.  Minimal right basal atelectasis is unchanged.  There are no other lung opacities of concern.  Top normal heart size, mediastinal and hilar contours are stable.",Right PICC line ends at mid SVC.  Small bibasilar atelectasis is unchanged.,Unremarkable chest x-ray.
"AP view of the chest.  A temporary pacemaker lead is unchanged and in appropriate position.  Mild cardiomegaly is unchanged.  No focal consolidation, pleural effusion or pneumothorax.",Temporary pacemaker lead is in appropriate position.  No acute cardiopulmonary process.,No acute cardiopulmonary abnormality.
"Temporary pacemaker wire appears in appropriate position. Sternotomy wires and mediastinal clips are stable.  The mild-to-moderate cardiomegaly is unchanged.  No focal consolidation, pleural effusion or pneumothorax.",No acute cardiopulmonary process.  Temporary pacemaker appears in appropriate position.  Mild cardiomegaly.,No acute cardiopulmonary abnormality.
"Frontal and lateral views of the chest demonstrate a transsubclavian right atrial and ventricular pacer defibrillator leads in standard position with no pneumothorax, pleural effusion, or mediastinal widening.  Lung volumes remain low.  The heart is stably enlarged.",ICD leads end in the right atrium and right ventricle. No evidence of bleeding or pneumothorax.,No acute cardiopulmonary abnormality.
"In the left perihilar region, there is a hazy opacification consistent with pneumonia.  There is no pulmonary edema, pleural effusion, or pneumothorax.  The cardiomediastinal silhouette is normal.  There is elevation of the left hemidiaphragm, which is stable from the prior exam.",Left perihilar pneumonia.  Recommend followup radiographs after treatment to ensure resolution.,Left lower lobe pneumonia.
PA and lateral images of the chest demonstrate interval worsening of left lung opacity.  The entire left hemithorax is now again opacified.  Opacification is likely due to a large left pleural fluid collection in the setting of lobectomy versus less likely left lung collapse.  There is persistent significant elevation of the left hemidiaphragm.  The right lung is clear.  There is no right pleural effusion.  Cardiac size cannot be assessed due to obscuration by the left hemithorax opacification.  The mediastinum is not shifted.,"Interval increase in the opacification of left hemithorax, likely consistent with large left pleural effusion.  Right lung is clear.","""""""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        sentences.append("" "".join([word_tokenize(f)[0].capitalize() + "" "" + f[1:] if i == 0 else f for (f, i) in zip(cleaned_sentences[i].split("".""), range(1))]))

    return ""."".join(sentences)"
"There is continued elevation of the left hemidiaphragm with left pleural abnormality, unchanged since the prior exam.  There is no evidence of pneumonia, pneumothorax or pulmonary edema.  The heart is top normal in size.","No acute cardiopulmonary disease.  Elevation of the left hemidiaphragm and left pleural abnormality which may represent either a loculated effusion or pleural thickening, is unchanged since prior exam.",No acute cardiopulmonary disease.
The patient had left lower lobe lobectomy in ___.  Expected stable surgical changes are seen in the left lung with volume loss and mild pleural thickening.  There is no pneumothorax.  The right lung is unremarkable.  Mediastinal and cardiac contours are not enlarged.,The exam is stable since ___ with expected changes after left lower lobe lobectomy.,No acute cardiopulmonary abnormality.
"ET tube ends 4.5 cm above carina.  NG tube is in the stomach, and left jugular line ends in upper SVC.  There is no pneumothorax, and left chest tube is in unchanged position in upper hemithorax.  Left upper lobe that was collapsed yesterday is more aerated and left lung pulmonary edema has significantly improved.  There is some residual small basilar atelectasis and small pleural effusion, if any.  Mild subcutaneous air has improved.  Right lung is unremarkable.  Mediastinal and cardiac contours are unchanged.",Patient with recent left lower lobe lobectomy.  Aeration and edema of remaining left upper lung has improved.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    if not findings:
        return None

    sentences = []
    for sentence in re.split(r""[.!?]+"", findings[0]):
        sentence = re.sub(r""\s{2,}"", "" "", sentence).strip()
        if sentence:
            sentences.append(sentence)

    return ""\n"".join(sentences)"
"Frontal and lateral views of the chest demonstrate interval increase in opacification of the left chest, with interval increase in left hemidiaphragmatic elevation likely the result of phrenic nerve paralysis.  There is minimal residual aerated left lung in this patient who is status post left upper lobectomy.  The right lung is hyperexpanded and clear.  The cardiac silhouette is not well assessed.",Collapse of the remaining left lung with further elevation of a probably paralyzed left hemidiaphragm.  Further evaluation with CT would provide a better evaluation of the airways and for the etiology of lung collapse.,Left pneumothorax with residual pneumomediastinum and pneumopericardium.
ET tube ends 4.1 cm above carina.  The patient had a recent left lower lobe lobectomy with the chest tube that projects in upper hemithorax without any visible pneumothorax.  Left pleural effusion is small if any.  The lung volumes are low with mild mediastinal and cardiac enlargement.,There is no pneumothorax.  The patient had recent left lower lung lobectomy with usual change.,"""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        sentences[i] = re.sub(r""[^A-Za-z0-9(),!?\'\`]"", r"" "", sentences)

    return sentences"
"Portable upright chest radiograph demonstrates a known left hilar mass.  There is no effusion, or definite pneumothorax.  The cardiac silhouette and mediastinal contours are otherwise unremarkable.",No pneumothorax status post biopsy of known left hilar mass.,"No acute cardiopulmonary abnormality is identified. 

    """"""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
"The patient has had a prior left lower lobectomy.  Since the prior exam, nodular pleural thickening encasing the left lung has increased at the expense of aeration of the left lung with stable elevation of the left hemidiaphragm. Central adenopathy in the left hilus and adjacent mediastinum has also progressed. The right lung is clear.  Cardiomediastinal silhouette is unchanged.",Progression of left pleural and nodal metastases.,Left lower lobe bronchogenic carcinoma with metastatic lymphadenopathy.
"The patient is status post median sternotomy and CABG.  Evaluation of the cardiac silhouette size is difficult due to the presence of a chronic, moderate-to-large left pleural effusion, which appears slightly increased in size when compared to prior study.  There is persistent left basilar opacification, likely reflecting compressive atelectasis.  The right lung demonstrates mild atelectasis at the lung base, but is otherwise clear.  No pneumothorax is identified.  There is no pulmonary vascular congestion.  The aorta remains tortuous and calcified.","Moderate-to-large chronic left pleural effusion, slightly increased compared to the prior study with persistent left basilar opacification, likely reflecting compressive atelectasis, though infection cannot be completely excluded.","Status post cardiac surgery with a moderate to large left-sided pleuraleffusion. No evidence of acute cardiopulmonary disease. 

    """"""

    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^A-Za-z0-9(),!?\'\`]"", "" "", text.lower())
        return text.strip().replace(""\n"", "" "").replace(""  "", "" "")

    cleaned_text = [clean_text(sent) for sent in text.split(""."")]
    word_counts = Counter("" "".join(cleaned_text).split())
    stop_words = set(nltk.corpus.stopwords.words(""english""))
    punctuation = {punct for punct in ""!\""#$%&'()*+,-./:;<=>?@[\]^_`{|}~"" if len(punct) == 1}
    words = [
        word
        for word, count in sorted(word_counts.items(), key=lambda x: x[1], reverse=True)
        if word.isalpha() and len(word) > 2 and word not in punctuation and not any(
            char.isdigit() for char in word[0]
        )
    ]
    sentences = nltk.sent_tokenize(text)
    filtered_sentences = []
    for sentence in sentences:
        words_in_sentence = sentence.split("" "")
        filtered_words_in_sentece = list(filter(lambda word: word.lower() in words, words))
        sentence_score = len(set(filtered_words"
Single portable AP radiograph was provided.  There is increased opacity at the right base which may be due to infectious process or aspiration. Rounded density projecting over the right ninth posterior rib is likely a nipple shadow and can be followed on subsequent radiographs. A chronic moderate-sized left pleural effusion is similar in appearance to the prior study.  Overlying opacities are likely atelectasis. Cardiomediastinal silhouette is unchanged.  Median sternotomy wires are intact.,New opacity at the right base may represent infection or aspiration. Stable moderate left pleural effusion with overlying atelectasis.,No acute cardiopulmonary process identified.
"PA and lateral views of the chest provided demonstrate an AICD projecting over the left chest wall with leads extending into the region of the right atrium, right ventricle, and coronary sinus.  Cardiomegaly is moderate.  The lungs are clear.  No pleural effusion or pneumothorax.  Atherosclerotic calcification at the aortic knob.  Bony structures intact.  No free air below the right hemidiaphragm.",Moderate cardiomegaly with AICD in unchanged position.  No evidence of congestive heart failure or pneumonia.,Moderately enlarged heart with a pacemaker in place. No evidence of acute cardiopulmonary disease.
"A left pectoral pacemaker is unchanged with three leads in the right atrium, right ventricle, and coronary sinus, as before.  There has been interval removal of the endotracheal tube from ___.  The cardiac silhouette remains severely enlarged. Partial calcification of the aortic knob is redemonstrated.  The mediastinal contours are unchanged.  There is no pulmonary vascular congestion or interstitial edema.  A moderate right pleural effusion is appreciated on the lateral view with mild right basilar atelectasis.  There is no left pleural effusion.  No pneumothorax is seen.  Diffuse dense calcification of the abdominal aorta is noted.",1.  No pulmonary edema/vascular congestion. 2.  Moderate right pleural effusion and mild right basilar atelectasis.,Severe cardiomegaly with no evidence of acute congestive heart failure.
Moderate to severe cardiomegaly is stable. Pacer leads are in standard position. ET tube is in standard position. Left IJ catheter tip is in the mid SVC . Right PICC is in unchanged position. NG tube tip is out of view below the diaphragm. Vascular congestion has improved. Bibasilar atelectasis have improved. Bilateral effusions right greater than left are unchanged,Improved pulmonary edema.,"You are an expert medical AI assistant.
    Your task is to extract the key clinical information from the findings below and generate a single sentence, structured, concise, and clinically relevant Impression. Avoid speculating or including uncertain information. Focus on the most important diagnoses and observations.

    ## Examples:
    # Findings: The heart size is normal. There is no pulmonary edema.
    # Impression: Normal chest radiograph.

    Findings:
    Moderate to severe cardiomegaly is stable. Pacer leads are in standard position. ET tube is in standard position. Left IJ catheter tip is in the mid SVC. Right PICC is in unchanged position. NG tube tip is out of view below the diaphragm. Vascular congestion has improved. Bibasilar atelectasis have improved. Bilateral effusions right greater than left are unchanged

    Impression: 

    """"""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize
#     from gensim.parsing.preprocessing import strip_non_alphanum, remove_stopwords, strip_multiple_whitespaces, \
#         strip_punctuation, stem_text, lemmatize, preprocess_string
#
    def preprocess_text(text):
        text = re.sub(r""[^a-zA-Z0-9]+"", "" "", text)
        return text.lower().replace(""  "", "" "").replace(""\n\n"", ""\n"").replace('\n','').replace('  ','')

    text=preprocess_text(Findings)
    sentences=sent_tokenize(text)

    for i in range(len(sentences)):
        sentences[i]=re.sub(' +',' ',sentences[i])

    filtered_sentences = [s for s in sentences if len(s) > 3]
    print(filtered_sentences)"
"Left-sided pacemaker device is noted with leads terminating in the right atrium, right ventricle, and coronary sinus.  The heart size is mildly enlarged.  The aortic knob is calcified.  There is mild pulmonary edema with perihilar haziness and vascular indistinctness, new from the prior study.  Focal opacities at lung bases may reflect areas of atelectasis though infection cannot be excluded.  Small bilateral pleural effusions may be present.  No pneumothorax is identified.",Mild pulmonary edema with probable small bilateral pleural effusions.  More focal opacities at lung bases may reflect atelectasis but infection cannot be completely excluded.,Mildly enlarged heart. Mild pulmonary congestion. Atelectasis vs. infection. Pleural fluid. Calcified aorta. Pacemaker.
"Single frontal view of the chest demonstrates a left pectoral pacer/AICD with leads terminating in the right atrium, right ventricle, and coronary sinus.  There has been interval removal of a right PICC.  Prominent cardiac silhouette is unchanged.  The mediastinal and hilar contours are unremarkable.  Aortic arch calcifications are redemonstrated.  The lungs are clear.",No radiographic evidence of acute cardiopulmonary process.,No acute cardiopulmonary abnormality is identified.
"Triple-lead left-sided AICD is again seen with leads extending to the expected position of the right atrium, right ventricle, and coronary sinus.  The lead extending to the coronary sinus, the distal aspect of which is partially obscured by the overlying battery pack.  There are extremely low lung volumes that accentuate the bronchovascular markings.  The left lung base is obscured by patient's overlying battery packs and not well evaluated.  Right basilar atelectasis is seen.  There is blunting of the right costophrenic angle, which may be due to small pleural effusion.  Aortic knob calcification is again seen.  The cardiac silhouette is grossly stable.  There is gaseous distention of the stomach and possibly the colon.","Suboptimal evaluation of the left mid to lower lung due to overlying battery pack.  If this is areas of high clinical concern, consider repeat with re-positioning of the patient.  There are extremely low lung volumes.  Right basilar atelectasis is seen.  Blunting of the right costophrenic angle could be due to small pleural effusion.    Gaseous distention of the stomach and possibly of the bowel.","""""""

    triple_lead_aicd = re.search(r'Triple\-lead\s*left\-sided\s*(A|a)(I|i)(C|c)(D|d)\s*(is|are)?\s*seen', findings, flags=re.IGNORECASE).group(0)
    leads_extending_to_right_atrium_right_ventricle_coronary_sinuses_distal_aspects_partially_obscured_by_overlying_battery_packs =''.join(re.findall(r'(Lea|lea)(d|D)(s|S)(e|E)(x|X)(t|T)(en|en)(g|g)(i|I)(n|n)g\sto\sthe\sright\s(at|at)(r|R)(iu|iu)(m|m)(p|p)(u|u)(b|b)(l|L)(o|o)(w|w)(er|er)\sof\s(the|the)\scoronary\s(sinuses|sinuses)\sdistal\s(as|as)(pects|pects)\spartially\s(ob|ob)(sc|sc)(ur|ur)(ed|ed)\sb(y|y"
Portable semi-upright radiograph of the chest demonstrates low lung volumes with resultant bronchovascular crowding. Clearing of the right base is consistent with decrease in size of the pleural effusion and improved aeration. Persistent retrocardiac opacity corresponds to atelectasis and probable left pleural effusion. There is moderate pulmonary edema. Cardiomediastinal and hilar contours are unchanged. Monitoring and support devices are in the appropriate position.,"1.  Moderate pulmonary edema.  2. Stable retrocardiac opacity, consistent with small pleural effusion and atelectasis.","No acute cardiopulmonary abnormality is seen on this portable chest x-ray. Atelectasis is present, likely secondary to the patient's chronic obstructive pulmonary disease (COPD) and possibly exacerbated by the recent exacerbation of his COPD. The patient has a moderate amount of pulmonary congestion, which is likely related to his history of congestive heart failure (CHF). There are no acute changes concerning for a pulmonary embolism (PE) or pneumothorax."
Portable semi-upright radiograph of the chest demonstrates low lung volumes with resultant bronchovascular crowding. Bibasilar consolidations may represent atelectasis or pneumonia in the appropriate clinical setting. The cardiomediastinal and hilar contours are unchanged. There is a new lucency beneath the right hemidiaphragm concerning for intra-abdominal free air. Right-sided PICC line and to the mid SVC. Unchanged position of the AICD. No pneumothorax.,1. Bibasilar consolidations may represent atelectasis or pneumonia in the appropriate clinical setting.  2. New lucency beneath the right hemidiaphragm is concerning for intra-abdominal free air. Clinical correlation recommended. Additional evaluation could be performed with repeat upright radiograph or left lateral decubitus radiograph.,Atelectasis and possible pneumonia. Free air in abdomen.
"Left-sided AICD/pacemaker device is noted with leads terminating in the right atrium, right ventricle, and coronary sinus, unchanged.  Mild enlargement of the cardiac silhouette is stable, with aortic knob calcifications re-demonstrated.  The pulmonary vascularity is normal, and the lungs are clear.  No pleural effusion or pneumothorax is present.  There are mild degenerative changes in the thoracic spine with anterior bridging osteophytes.",No acute cardiopulmonary abnormality.,"Mild cardiomegaly, stable. No acute cardiopulmonary abnormality."
A single portable frontal upright view of the chest was obtained.  The right internal jugular central venous catheter has been pulled back now terminating in the mid SVC.  Otherwise there is no substantial change over this short-interval followup.,"Right internal jugular central venous catheter has been pulled back, now terminating in the mid SVC.",No significant interval change. Pulled back RICVC now terminates in mid-SVC.
A single portable AP semi-upright view of the chest was obtained.  Right IJ central venous catheter projects over the right atrium.  An ICD pacing device with biventricular leads appears unchanged in position.  Lung volumes remain low with right basilar atelectasis. Cardiomediastinal silhouette is stable.  There is no focal consolidation or pleural effusion.  No pneumothorax.,"1. Interval placement of a right IJ catheter with tip in the right atrium, consider pulling back by 3 cm for optimal placement.  2. Otherwise, no substantial changes compared to the prior examination.",No acute cardiopulmonary abnormality.
The lungs are well expanded and shows a right lower lobe opacity.  The cardiac silhouette is enlarged.  The mediastinal silhouette and hilar contours are normal.  No pleural effusion or pneumothorax is present.,"Right lower lobe atelectasis with a small associated effusion, better assessed on concurrent CT.",Enlarged heart. Right lower lung opacity.
"There is central pulmonary vascular congestion with moderate pulmonary edema.  The chronicity of these findings is unknown due to the lack of comparison studies.  There is no focal consolidation, pneumothorax, or pleural effusion.","Congestive heart failure, likely acute. Acute myocardial infarction should be ruled out as the cause of failure given patient's young age and acuity of presentation.  The patient was transferred to the emergency department for further evaluation.","Moderate pulmonary congestion. 

    """"""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub('[^a-zA-Z0-9]','', text)
        words = text.lower().split()
        return''.join([word for word in words if len(word) > 1])

    cleaned_findings = [clean_text(finding) for finding in findings]
    findings_counter = Counter(''.join(findings))

    keywords = ['pulmonary', 'congestion']
    keyword_count = sum([findings_counter[keyword] for keyword in keywords])
    impression = f'{keyword_count} {keywords[0]}'

    return impression"
"Again seen is a large pleural effusion, with likely a loculated component on the right, with compressive atelectasis of major portions of the right lower and middle lobes.  There is no pneumothorax.  The left lung is well expanded and clear.  The cardiac size is within normal limits.  The hilar and mediastinal contours are normal.","Large right pleural effusion again seen, stable to slightly increased, likely loculated, with compressive atelectasis of major portions of the right middle and lower lobes. If the cause of the pleural effusion has not been established, recommended a CT of the chest with contrast, after thoracentesis to rule out an underlying mass.","Pleural Effusion
    """"""
    impression = """"
    if ""pleural"" in findings:
        impression += ""Pleural""
    return impression"
The endotracheal tube sits 4 cm above the carina.  A right-sided IJ central line tip sits in the upper SVC.  The endogastric tube side port sits well below the GE junction.  Three cerclage wires project over the lower cervical spine.  The heart size is within normal limits.  The mediastinal and hilar contours are normal.  The lungs demonstrate minimal plate-like atelectasis in the superior portions of the bilateral lower lobes.  There is no large pleural effusion or pneumothorax.,"Minimal bilateral atelectasis, but no pneumothorax.",No acute cardiopulmonary process is identified.
"PA and lateral views of the chest were obtained.  Since prior radiograph, there has been development of small pleural effusion on the right with fluid within the fissure.  Opacity at the right base is similar as on prior radiographs and may represent atelectasis; however, infection cannot be excluded. There is atelectasis at left lung base.  Peripheral left upper lobe opacity is unchanged.  There is no pneumothorax.  Cardiomediastinal silhouette is stable.  There are degenerative changes in the thoracic spine.","Re-accumulation of small right pleural effusion with opacity at the right base, with non-specific consolidation at right lung base which could be infectious.  Follow-up to resolution.",No acute cardiopulmonary abnormality. Pleural fluid. Atelectasis. Degenerative spine changes.
A small right apical and basal pneumothorax persists but is significantly decreased than on the prior study.  A right Pleurx catheter is in place and right pleural effusion has significantly decreased.  There is no left pleural effusion.  Again seen is opacity in the left lung peripherally which corresponds to findings seen on recent chest CT.  There is no focal consolidation.  Opacity at the right base is likely atelectasis.  Cardiomediastinal silhouette is stable.,Improved right pneumothorax which is now small.  Resolved right pleural effusion.,Significant decrease in size of right pneumotorax. Small left peripheral opacity. Atelectasis at right lung base. No focal consolidations. Stable cardiomeidastinum.
"There is a large right hydropneumothorax with a moderate amount of fluid.  It is difficult to compare size; however, copared to the prior CT chest, it appears mostly unchanged. There is no evidence of tension as is supported by the fact that the trachea, the aortic knob, and the left heart border appear in similar position as radiograph prior to the pneumothorax on ___.   Hazy opacities are seen involving the right middle and lower lobes. The localized nature of this process more likely represents hemorrhage or infectious process rather than reexpansion edema.  The left lung is clear.  The cardiomediastinal silhouette is stable.  There are no acute bony abnormalities.","1.  Large right hydropneumothorax, most likely unchanged in size from recent CT.  No evidence of tension. 2.  Hazy opacities involving the right middle and lower lobes most likely represents hemorrhage or infectious process.","Large right hydro-pneumo thorax, stable in size compared to prior imaging, without tension. Right lower lobe hazy opacity, more consistent with infectious or hemorrhagic process. No acute cardiopulmonary abnormality."
"Since the prior radiograph, there has been substantial increase in the right pleural effusion that is partly subpulmonic.  The lungs are otherwise clear.  There is no focal consolidation or pneumothorax.  Heart size is top normal.  Mediastinal silhouette is unremarkable.",Significantly increased partly subpulmonic right pleural effusion since prior exam.,Substantial increase of right-sided pleuritis. No other significant abnormality.
"Again seen is a large right hydropneumothorax without evidence of tension, mostly unchanged from the prior radiograph.  There is slightly improved aeration of the right middle and lower lobes. The cardiomediastinal silhouette is normal.  The left lung is clear.",1.  Stable large right hydropneumothorax without tension. 2.  Improving aeration in the right middle and lower lobes.,Large right-sided pleural effusion with associated atelectasis and pneumonitis.
"In comparison to prior study, there is new medial right basilar and left basilar retrocardiac opacity.  Given the clinical history, this is concerning for aspiration, possibly developing pneumonia.  There is no associated effusion, pneumothorax or apparent pneumomediastinum. The upper lungs remain well aerated.  Hilar and cardiomediastinal contours are unchanged, with marked calcification and tortuosity of the thoracic aorta.  Degenerative changes are noted in the thoracic spine.  No free air is seen in the included upper abdomen.","New bibasilar opacities, which given the clinical history are suspicious for aspiration, possibly developing pneumonia.","""""""

    return (
        ""Normal chest x-ray""
    )"
"Again seen is a left PICC in the upper to mid SVC.  Innumerable metastatic pulmonary nodules are present.  There are continued multifocal hazy opacities, with confluent consolidation in the left lower lobe.  Right upper lobe collapse is unchanged.  Moderate left and small right pleural effusions, moderate cardiomegaly, and central venous congestion persist.  No pneumothorax.","Stable appearance of pulmonary metastases, multifocal pneumonia, pulmonary edema, and right upper lobe collapse.",Metastatic lung disease. Left upper extremity deep vein thrombosis. Pneumonia. Pulmonary embolism.
"Portable AP upright chest radiograph was obtained.  Compared to the scout radiograph from a torso CT from ___, there is increased opacity in the left lower lung, concerning for worsening effusion and consolidation.  Extensive nodularity in the lungs is compatible with known metastatic disease. Heart size cannot be assessed.  Bony structures appear unchanged.","Increasing opacity in the left lower lung, concerning for worsening consolidation and effusion.  Extensive metastatic disease within the chest.  Refer to subsequent CT for further details.",Worsening pleural and parenchymal metastases.
PA and lateral views of the chest were obtained.  Patient is known to have extensive metastatic disease within the chest with loculated left pleural effusion.  Overall appearance of the chest appears essentially stable compared with multiple prior exams.  Please note evaluation for subtle differences would be limited due to extensive underlying metastatic burden.  Heart size cannot be readily assessed.  Mediastinal contour appears grossly stable.  No pneumothorax is seen.  Imaged osseous structures appear grossly intact.,"Extensive metastatic disease in the chest, which appears grossly stable compared with prior exams.","No acute cardiopulmonary abnormality is identified.
    
    ### Hints
    * Use `nltk.sentiment.vader.SentimentIntensityAnalyzer()` to calculate the sentiment score of each sentence in the `Findings` paragraph. The higher the score, the more positive the sentence is. You can then use this score to determine which sentences to include in your `Impression` sentence. For example, you could include all sentences with a score above a certain threshold, or only include the top 3 most positive sentences."
"There has been interval worsening of moderate interstitial and airspace pulmonary edema.  There is new collapse of the right upper lobe with superior retraction of the major fissure, likely due to bronchial encasement by right hilar adenopathy as seen on CT.  There are innumerable metastatic pulmonary nodules and multifocal hazy opacities, better characterized on CT.  Moderate cardiomegaly and central vascular congestion persist.  Small bilateral pleural effusions, multiloculated on the left.",1.  New right upper lobe collapse and worsening pulmonary edema.,Worsening pulmonary parenchymal and hilar lymph node metastases from lung adenocarcinoma.
"There has been interval decrease in size of the left pleural effusion, which is now moderate in severity.  Small right pleural effusion is present.  Bilateral consolidations, more dense on the left, persist.  No pneumothorax is seen.  Extensive nodularity is consistent with known metastatic disease.","Interval decrease in size of left pleural effusion, which is still moderate in severity.","""""""

    assert len(findings) == 1

    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""

    elif ""pneumonia"" or ""consolidation"" not in [word.lower() for word in re.sub(""[^a-zA-Z0-9 ]"", """", findings).split("" "") if len(word) > 0]:

        if re.search(r""nodularity"", findings, flags=re.IGNORECASE) is not None:
            return (
                ""Chest X-ray shows nodular lung parenchyma, likely due to metastasis.""
            )

        elif re.findall(r""\d+\/\d+"", findings)!= []:
            age = int(re.findall(""\d{1,2}"", findings)[0]) // 10
            if age >= 65:
                return f""Chronic obstructive pulmonary disease (COPD) in a {age}-year-old patient.""

            elif age < 18:
                    return (""Asthma in an 8-year-old child."")

            else:

                if (
                    ""emphysema""
                    in [
                        word.lower().replace(""-"", """")
                        if word.replace(""-"", """").isalpha()
                        else """"
                        for i in range(0, len(re.split(r""[^\w\s]"", findings)))
                    ]
                    and ""cystic fibrosis"" is None
                ):

                    if any(
                        [
                            word.isalpha() and word.upper() in [""F"", ""M""]
                            or word.title() == ""PREGNANCY""
                            for re.match(r""(?<=\s)[A-Za-z]+(?=\s)"", findings)"
"Frontal and lateral views of the chest were obtained.  In comparison with scout image from CT from ___, again seen is a large left perihilar mid-to-lower lung opacity which on the prior CT corresponded to innumerable pulmonary nodules, although superimposed infection cannot be excluded.  Nodular opacities in the right lung to a lesser extent than on the right are again seen.  There is blunting of the left costophrenic angle likely corresponding to pleural effusion and is also seen on prior CT.","Left greater than right pulmonary opacities similar as compared to scout image from CT from ___, given differences in technique, although superimposed infectious process cannot be excluded.  Slight blunting of the left costophrenic angle is likely due to small left pleural effusion.","Large left lower lobe pulmonary nodule(s) and nodular infiltrates in both lung fields. 

    """"""

    if len(findings) == 0:
        return None

    findings = [f.strip() for f in findings.split('\n') if f!= '']

    sentences = []

    for i in range(0, len(sentences), 2):
        sentences.append(' '.join([sentences[i], sentences[i+1]]))

    return sentences"
"A persistent patchy opacification in the left mid and lower lung fields, unchanged from the prior exam.  The right lower lung aeration has improved from the prior exam with resolution of the previously seen opacity.  Multiple small nodules are seen bilaterally, consistent with the patient's known history of metastatic renal cell carcinoma.  No new opacifications are present.  There is no pleural effusion or pneumothorax.  The cardiomediastinal silhouette is normal.","1.  Improvement in right lower lobe aeration with resolution of previously seen opacity. 1.  Persistent left mid and lower lung opacification. 2.  Multiple pulmonary nodules, consistent with known history of metastatic renal cell carcinoma.","Metastatic Renal Cell Carcinoma
    """"""
    return "" "".join([word for word in text.split() if word not in stop_words])"
"Median sternotomy wires, aortic valve replacement, mediastinal surgical clips are again noted, no change in alignment.  There is persistent opacity at the left lung base, though aeration is improved from two days prior.  Persistent linear opacities likely represent atelectasis.  Left pleural effusion is small.  Trace right pleural fluid is also present.  Lungs are otherwise well aerated.  There is no focal consolidation to suggest pneumonia. There is no vascular congestion or pulmonary edema.  There is no pneumothorax.","Improved aeration at the left lung base, with persistent linear atelectasis and small amount of pleural fluid.",No acute cardiopulmonary process is identified.
"Single portable view of the chest at 4:57 p.m. is compared to previous exam from earlier the same day at 4:10 p.m.  Left-sided chest tube is seen with tip projecting over the left lung apex.  Although there is increased lucency in the left hemithorax, no discrete pleural line is identified based on this supine film.  There is left chest wall subcutaneous gas seen.  Otherwise, there has been no change.",Left-sided chest tube now seen with tip overlying the left lung apex.,Chest tube in place. No evidence of pneumothoraces or pneumomediastinum.
"Single portable view of the chest is compared to previous exam from earlier the same day at 2:38 p.m.  There has been interval placement of a left-sided chest tube projecting over the left lower hemithorax.  There is overlying subcutaneous gas.  Lucency still persists adjacent to the mediastinum on the left.  Otherwise, there has been no change.  Multiple right-sided rib fractures are better seen on the prior exam.",Interval placement of a left-sided chest tube projecting over the left hemithorax.,Chest tube in place. No change in lung parenchyma. Rib fractures.
Single frontal view of the chest was obtained.  The heart is of normal size with stable cardiomediastinal contours.  A small right pleural effusion is similar to the exam 10 hours prior.  No focal consolidation or pneumothorax.  There is small atelectasis at the right base.  Chronic-appearing right rib fractures are similar to prior.  Sternotomy wires and mediastinal clips are intact.,No relevant change from study 10 hours prior.  Stable small right pleural effusion.,"No acute cardiopulmonary abnormality is seen on this chest x-ray.

## Solution

```python
import re
from collections import Counter

def parse_findings(findings):
    findings = re.sub(""[^a-zA-Z0-9 ]"", "" "", findings).lower()
    words = [word for word in findings.split() if len(word) > 2]
    counts = Counter(words)
    most_common = counts.most_common(5)

    return "" "".join([word[0] + "" "" + str(word[1]) + ""%s"" % ("" "" * max(0, 3 - len(str(word[-1])))) + word[2].capitalize() + ""."" for i, (word, count) in enumerate(sorted(counts.items())) if i < 5])

findings_1 = """"""
The patient is alert and oriented to person, place, time and situation. He is cooperative without apparent distress. His speech is spontaneous, slow and of low volume. Thought process and content are unremarkable. Memory is intact for name, occupation and three object recall. Judgment and insight are fair. No delusional or hallucinatory phenomena are either spontaneously reported or directly elicited. Mood is euthymic. Affect is full range and congruent to mood. Suicidal or homicidal ideation is absent. The patient denies use of alcohol, illicit drugs or prescription medications in non-therapeutic doses.
""""""
print(""Findings:"")
print(parse.findings())
```"
"Compared to the most recent prior radiograph, there has been no significant change.  There is no evidence of pneumothorax.  Again seen is minimal bibasilar atelectasis.  There is no pleural effusion or focal consolidation.  The cardiac silhouette is stable, and there is mild tortuosity of the aorta.  Median sternotomy wires and clips are unchanged.  Subcutaneous air in the left soft tissues is again seen.",No significant interval change.,No acute cardiopulmonary abnormality.
"The lungs are well expanded and clear. The cardiomediastinal and hilar contours are unremarkable.  There is moderate aortic tortuosity, unchanged. A small right-sided pleural effusion is unchanged.  There is no pneumothorax.  Sternotomy wires are intact. Multiple fractures in early stages of healing are noted in the right rib cage.",Stable small right sided pleural effusion.,No acute cardiopulmonary abnormality.
"There is moderate pulmonary edema, but no pleural effusion or pneumothorax.  Heart size is top-normal, stable.  Mediastinal contours are within normal limits.  Osseous structures are intact.",1. Moderate pulmonary edema without pleural effusions. 2. Top-normal heart size.,"Chest X-Ray

    """"""

    impression = ""Chest X-ray""

    return impression


if __name__ == ""__main__"":
    main()"
The heart size is moderately enlarged.  The mediastinal silhouette and hilar contours are unchanged.  A moderate to large right-sided pleural effusion is slightly increased in volume compared to prior examination with collapse of much of the right lower lobe and right middle lobe.  There is also some consolidation at the base of the right upper lobe which could be due to compressive atelectasis.  There is no left effusion.  The upper lung zones appear clear.  There is no pneumothorax.,Slightly increased moderate to large right-sided pleural effusion with collapse of much of the right middle lobe and right lower lobe.  Superimposed pneumonia cannot be excluded given the appropriate clinical circumstance.,Moderate to severe pleuritic pain and dyspnea. Right lower and middle lobes are collapsed and consolidated. Left lung is clear.
"PA and lateral views of the chest were provided.  There are bilateral pleural effusions, new from prior exam with subjacent consolidation which could represent compressive atelectasis.  The possibility of pneumonia is not excluded.  There is no pneumothorax.  The heart is top-normal in size.  A vascular stent is again noted in the left brachiocephalic vein.  The imaged osseous structures are intact.  No free air is seen below the right hemidiaphragm.",Bilateral pleural effusions with adjacent consolidation new from prior exam raises concern for fluid overload.  Correlate with renal function.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for sentence in re.split(r'(?<!\w\.\w.)(?<![A-Z][a-z]\.)\s', findings[0]):
        sentence = re.sub(r'\s{2,}','', sentence).strip()
        sentences.append(sentence)

    return ""\n"".join(sentences)"
Frontal and lateral chest radiographs were obtained.   There are persistent bilateral small to moderate pleural effusions.  There is marked cardiomegaly with mild to moderate pulmonary vascular congestion.  No focal consolidation or pneumothorax is seen.  Suture line in the right lower lobe and left-sided vascular stent are unchanged.  No bony abnormality is identified.,1.  Persistent bilateral pleural effusions.   2.  Marked cardiomegaly and pulmonary vascular congestion.,"""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
"An approximately 6 mm diameter rounded opacity is again demonstrated in the left retrocardiac region, to the left of the descending aortic interface.  It overlies the tenth left posterior rib level and is not definitively calcified but overlap with rib limits this assessment.  Lungs are otherwise notable for surgical chain sutures in right mid lung.  Cardiomediastinal contours are within normal limits.  Left subclavian and brachiocephalic vascular stents remain in place.  Minimal pleural thickening versus small effusion at lateral right costophrenic sulcus.  No acute skeletal findings.","6 mm diameter left lower lobe opacity is unchanged since recent chest radiograph, but is not fully characterized.  Considering patient's immunosuppressed status and concern for acute infection, CT may be considered for more complete evaluation of this region if warranted clinically.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for sentence in re.split(r""[.!?]+"", findings[0]):
        sentence = sentence.strip()
        if sentence == """":
            continue
        sentences.append(sentence)

    return "" "".join(sentences)"
"Lung volumes are somewhat low, however, no focal opacity to suggest pneumonia is seen.  No pleural effusion, pulmonary edema or pneumothorax is present.  A stent in the region of the left brachiocephalic vein is unchanged. Surgical chain suture is noted in the right lower lobe.  A calcification seen projecting over the cardiac silhouette to the left of the aorta is not clearly localized on this single frontal radiograph, however, was not present on the examination of ___.  The heart size is normal.","1.  No evidence of acute cardiopulmonary process.  2.  Rounded calcification projecting over the cardiac silhouette not well localized on this single frontal radiograph.  This could represent a calcified granuloma, however, was not present on the examination of ___.  PA and lateral radiographs may be performed for further evaluation and localization.",No acute cardiopulmonary abnormality is identified.
"Portable AP chest radiograph demonstrates worsening bilateral pleural effusions and associated atelectasis, greater on the right.  There is also worsening pulmonary vascular congestion.  There is no pneumothorax.  Right internal jugular catheter probably terminates in the right atrium.",Worsening pulmonary edema and bilateral pleural effusions.,"""""""

    impression = """"

    if ""worsening"" in findings:
        impression += ""The patient's condition has worsened since their last visit. ""

    return impression"
"Since most recent prior radiograph a Swan-Ganz catheter, feeding tube, right IJ central line have been removed and ET tube hav been removed. Lung volumes are low. There are now new bilateral large bibasilar opacities consistent with atelectasis.  There are unchanged bilateral pleural effusions. There is new mild pulmonary edema.  A right chest tube is in place.  There are median sternotomy wires and stable moderate cardiomegaly.",1.  Removal of multiple monitoring and support devices. 2.  New mild pulmonary edema.,"""""""

    return ""Impression""

if __name__ == ""__main__"":
    print(extract_clinical_information())"
"AP single view of the chest has been obtained with patient in sitting semi-upright position.  Comparison is made with the next preceding similar study of ___.  As before, the patient is status post sternotomy, aortic valve replacement and bypass surgery.  Cardiomegaly as before.  A right internal jugular approach central venous line remains in unchanged position and terminates in a location compatible with the upper portion of the right atrium.  The diaphragmatic contours are bilaterally obscured and the lateral pleural sinuses are blunted.  This is indicative of increasing pleural effusion in comparison with the previous portable postoperative chest examination.  Pulmonary vasculature remains congested with considerable perivascular haze.  No pneumothorax is seen.  The comparison is extended to multiple previous postoperative examinations, signs of pleural effusion and pulmonary congestion existed already earlier.  On the preoperative chest examination of ___, significant cardiomegaly existed already at that time.  The pleural spaces are practically free.",Continuing postoperative CHF with bilateral pleural effusion apparently increasing slightly during latest examination interval.,"""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    findings = [clean_text(f) for f in findings.split('\n')]

    sentences = []
    for i in range(len(findings)):
        if i % 2 == 0:
            sentences.append(' '.join([findings[i], findings[i+1]]))

    print(sentences)"
Moderate pulmonary edema has progressed since yesterday.  Bibasilar atelectasis is unchanged.  Mild cardimegally is similar.  Median sternotomy wires are intact and mediastinal clips are in expected positions.,Progression of moderate pulmonary edema.,"Moderate Pulmonary Edema, Mild Cardiomegaly, Median Sternotomy Wires Intact, Medistinal Clips in Expected Positions"
"Low lung volumes are present.  The patient is status post median sternotomy and aortic valve replacement.  Cardiac silhouette size is mildly enlarged.  Thoracic aorta remains calcified.  There continues to be mild pulmonary vascular congestion.  Persistent streaky opacities at the lung bases appear slightly improved compared to the prior study, and likely reflect atelectasis.  There are adjacent small bilateral pleural effusions, though the size of the effusions appearing slightly improved compared to the most recent prior study.  No pneumothorax is identified.  There are no acute osseous abnormalities.","Slight interval improvement in mild pulmonary vascular congestion, small bilateral pleural effusions, and bibasilar airspace opacities likely reflecting atelectasis.  Please note that infection at the lung bases cannot be completely excluded.","Mildly enlarged cardiac silhouette, with mild residual pulmonary venous congestion, likely related to chronic atrial fibrillation. Atelectasis and bilateral, small, residual, non-hemorrhagic pleuritic effusion. No evidence of acute cardiopulmonary disease."
"The heart size is mildly enlarged.  The aortic knob is calcified.  There is mild pulmonary edema noted with perihilar haziness and vascular indistinctness.  Small bilateral pleural effusions are present, left greater than right, with bibasilar airspace opacities. No pneumothorax is identified.  There are no acute osseous abnormalities.","Mild congestive heart failure with small bilateral pleural effusions and bibasilar airspace opacities, likely reflecting atelectasis, though infection cannot be excluded.",Mild cardiomegaly with calcification of the aorta. Mild pulmonary congestion. Small left-sided pleuritic effusion with left lower lobe atelectasis.
"Bilateral lung volumes are lower.  Since yesterday, mild-to-moderately severe pulmonary edema has significantly improved.  However, moderate right pleural effusion associated with right lower lung atelectasis and left lower lung atelectasis and small left pleural effusions are unchanged.  The lung effusions and atelectasis obscuring the mediastinal border, thus assessment of the cardiomediastinum was limited.","Over last 24 hours, mild pulmonary edema has significantly improved, moderate right and small left pleural effusion as well as bilateral lower lung atelectasis are unchanged.","Mild-to-Moderate Pulmonary Edema, Moderate Right Pleural Effusion Associated With Right Lower Lung Atelectasis And Left Lower LUNG ATELECTASIS AND SMALL LEFT PLEURAL EFFUSIONS ARE UNCHANGED."
"PA and lateral views of the chest. Again seen is severe enlargement of the cardiac sillouhette.  There is no focal consolidation, pleural effusion, or pneumothorax.  The mediastinal and hilar contours are unchanged.  A right central venous catheter has been removed.","Severe enlargement of the cardiac siillouhette, unchanged, likely cardiomegaly.",Severe cardiomegaly.
"The right internal jugular dialysis catheter terminates within the right atrium.  There is no pneumothorax or pleural effusion.  The cardiac silhouette is severely enlarged, but unchanged.  The hilar structures are unremarkable.  There is no pleural effusion.  There is a chronic subclincal pulmonary edema appearance to the pulmonary vascularity without evidence for acute volume overload.",Satisfactory right internal jugular dialysis catheter position without pneumothorax.  Unchanged severe cardiomegaly.,Severe dilated cardiomyopathy.
"A right tunneled hemodialysis catheter is unchanged in position with its tip in the right atrium.  The heart remains severely enlarged.  The lungs are well expanded and clear.  There is no pleural effusion, or pneumothorax.  The mediastinal contours are normal.","Severe cardiomegaly is unchanged, there is no edema or acute chest abnormality.","Severe cardiomegaly, unchanged."
The lungs are well expanded and clear. Area of increase density overlying the right hilum with a sharp lower margin is of unclear clinical significance. Severe cardiomegaly is reidentified. The hilar contours are unremarkable. There is no pleural effusion or pneumothorax.,"1.   Area of increase density overlying the right hilum with a sharp lower margin is of unclear clinical significance. Chest CT is recommended for further assessment. 2.  Severe cardiomegaly, unchanged.",No acute cardiopulmonary abnormality is identified.
"AP and lateral radiographs of the chest were acquired.  The heart is massively enlarged, as before.  Small bilateral pleural effusions are not significantly changed.  Diffuse interstitial opacities with perihilar predominance are likely secondary to mild interstitial pulmonary edema, increased compared to radiographs from ___.  No focal consolidations concerning for pneumonia.  There is no pneumothorax.  The mediastinal contours are stable.","1.  Mild interstitial pulmonary edema. 2.  Massive cardiomegaly, not significantly changed. 3.  Small bilateral pleural effusions, not significantly changed.","Massive cardiomegaly with mild pulmonary congestion. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        if i == 0:
            sentences.append(sentences[-1] + "" "" + cleanings[i])
        elif i < len(cleanings) - 1 and i % 2!=0 :
            continue
        else:
            
            sentence = "" "".join([cleanings[j] for j in list(range(i-1, i+2)) if j!= i])
            if len(sentence.split("" "")) > 3:
                sentence += "".""
            elif sentence.endswith("".""):
                pass
            else:

                if sentence.startswith(""The"") and sentence.split()[1].endswith(""s""):
                    sentence.replace(""the"", ""this"")
                elif ""the"" in sentence:
                    words = sentence.strip().split("" "")
                    for w in words:
                        if w == 'the':
                            words[words.index(w)] = 'that'
                        elif w.endswith('s') and not w.startswith('the'):
                            w = w[:-1]
                            if words.count(w) >1:
                                words.remove(w)
                            elif len(words) < 4 and w not in ['a', 'an']:
                                w +='s"
"Endotracheal tube terminates 2.8 cm above the carina.  Nasogastric tube terminates within the body of the stomach.  Right internal jugular catheter ends in the lower SVC.  Previously described right upper lung opacity is less conspicuous than on the prior.  Bibasilar opacities are larger and could reflect atelectasis or an aspiration event.  Worsening infection cannot be excluded.  Small left pleural effusion is likely also present.  The heart is normal in size, normal cardiomediastinal silhouette.",Slight improvement of right upper lung opacity with increased bibasilar opacities possibly reflecting atelectasis or aspiration though worsening infection cannot be fully excluded.,"No acute cardiopulmonary abnormality is identified. Atelectasis, aspiration, or worsening infection could be contributing to the patient's respiratory distress."
"The endotracheal tube terminates 3.6 cm above the level of the carina.  There are multiple areas of increased radiodensity most severe in the right upper lung, but also within the medial right lower lung and in the retrocardiac region.  Findings are most concerning for multifocal pneumonia.  There is no overt pulmonary edema or large pleural effusions.  There is apparent mild widening of the mediastinal contours secondary to the supine technique.  The cardiac silhouette is mildly enlarged. There is no pneumothorax.  Please see concurrent chest CT report for additional details.","1.  Endotracheal tube in standard position.  No pneumothorax. 2.  Multifocal opacities, most severe in the right upper lung, concerning for multifocal pneumonia.",Multifocal pulmonary opacities. Mild cardiomegaly.
Endotracheal tube terminates 2 cm above the carina.  Orogastric tube terminates in the stomach.  Right internal jugular catheter terminates in the mid SVC.  Lungs are low in volume with stable right upper lung opacities which are better assessed on the recent chest CT but suspicious for pneumonia. There is no pneumothorax or pleural effusion.  Heart is normal in size.  Normal cardiomediastinal silhouette.,1. Satisfactory position of monitoring and support devices. Aside from ET tube which is 2 cm above the carina and can be slightly withdrawn.,"""""""

    return (
        ""Normal chest x-ray""
    )"
"PA and lateral chest views were obtained with patient in upright position.  Analysis is performed in direct comparison with the next preceding PA and lateral chest examination of ___.  Whereas the described changes in the right hemithorax are stable, the left-sided basal pleural density has decreased markedly and the left-sided diaphragmatic contour is now identified both on frontal and lateral view.  No evidence of pneumothorax in the apical areas on either side.",Successful thoracocentesis removing major portion of left-sided pleural effusion.  No pneumothorax following thoracocentesis.,"""""""

    return (
        ""Normal chest x-ray""
    )"
"There is a rounded opacity in the right upper lobe, approximately 1.8cm.  There is no effusion or pneumothorax.  The pulmonary vasculature is within normal limits.  There is partial visualization of anterior fusion hardware of the cervical spine.  The heart size is magnified by portable technique, the mediastinal contours are unremarkable.","Right apical rounded opacity concerning for infection or malignancy. Recommend repeat dedicated AP and lateral chest radiograph, or CT for further evaluation.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [x.strip() for x in findings.split(""\n"") if len(x.strip())>0]

    sentences = []
    for i in range(len(sentences)):
        if sentences[i].startswith(""Impression""):
            break
        else:
            sentences.append("""")

    return sentences[-1]"
"The right-sided PICC has been repositioned and now ends in the mid SVC.  The NG tube courses to the stomach, although the tip is excluded from view.    Lung volumes remain low.  Retrocardiac opacity persists and is consistent with atelectasis and a small pleural effusion as seen on ___ abdomen/pelvis CT. Pulmonary edema has resolved.",No evidence of pneumonia. Retrocardiac opacity is consistent with atelectasis and a small pleural effusion as seen on ___ abdomen/pelvis CT.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    impression = "" "".join([f.split("":"")[0].strip().capitalize() + "": "" + f.split("":"", maxsplit=1)[1].replace(""and"", ""with"").replace("","", """").replace(""."", """") + "".\n"" if "":"" in f else f.capitalize()])

    return impression"
The tip of an endotracheal tube is 4.7 cm from the carina.  There is stable moderate enlargement of the cardiac silhouette.  The mediastinum is normal.  A small left pleural effusion is unchanged.  An adjacent persistent hazy opacification at the left base likely represents atelectasis.  The right lung is clear.  There is no pneumothorax.,Persistent left basilar atelectasis and small left pleural effusion.,No acute cardiopulmonary abnormality.
"Since the prior study, an endotracheal tube has been placed.  Its tip is 5.3 cm from the carina.  A PICC ends in the mid SVC.  A feeding tube overlies the stomach with the tip out of view.  A pleural effusion on the left is small.  A persistent consolidation at the left base is unchanged and likely reflects chronic atelectasis.  There are no new opacities.  There is no pneumothorax.  Cervical hardware and right humeral soft tissue anchors are unchanged.",1.  Endotracheal tube 5.3 cm from the carina. 2.  Persistent left pleural effusion and atelectasis.,No acute cardiopulmonary disease.
"One portable AP upright view of the chest.  The right apical opacity is stable and concerning for either a nodule or infection.  There are low lung volumes which exaggerates the bibasilar atelectasis.  Anterior fusion hardware is seen.  The cardiac, mediastinal and hilar contours are normal.","1.  Right apical opacity concerning for either infection or nodule.  2.  Other than low lung volumes, no significant change compared to most recent study.",Stable right upper lobe opacity. No acute cardiopulmonary abnormality.
"AP single view of the chest has been obtained with patient in sitting semi-upright position.  Analysis is performed in direct comparison with the next preceding similar study of ___.  Position of previously described right-sided PICC line is unchanged, seen to terminate in mid portion of SVC.  No pneumothorax is present.  Pulmonary congestive pattern as before with perivascular haze and slightly more marked diffuse densities on the left base, similar as it was before.  No significant interval change can be identified.  No new abnormalities on the right base.","Stable chest findings, no new abnormalities.","""""""

    return ""Normal chest x-ray"""
"Right suprahilar opacity with its fiducial marker is stable for at least two months. Small bilateral pleural abnormalities and a large region of rounded atelectasis in the left lower lobe are also unchanged.  Heart size, and mediastinal and pulmonary vascularity are normal and there is no edema.  Pacemaker leads are in unchanged positions, intact.","Stable, treated right lung malignancy.  No evidence of congestive heart failure or other acute abnormality.","No acute cardiopulmonary abnormality. 

    """"""

    import numpy as np
    from transformers import AutoTokenizer, AutoModelForQuestionAnswering

    model_name = ""bert-large-uncased-whole-word-masking-finetuned-squadv1.1""
    max_length = 512"
Comparison is made to prior examination of ___.  The lung volumes are low.  The heart size is therefore likely adequate.  There is some widening of the mediastinum although again this is likely due to poor inspiratory effort.  There is hazy opacity and vascular haziness in both lungs consistent with interstitial edema.  An ET tube is identified 3.2 cm from the carina in correct position.  A pacemaker lead in the right ventricle and a second lead in the right atrium.  There is a subclavian line with its tip in the distal SVC.  An NG tube is noted coursing through the esophagus into the stomach.  The tip of the NG tube is not identified on this film.,1.  Tubes and lines in adequate position as described above.  2.  Pulmonary edema involving both lungs. 3.  Widening of the mediastinum and possible cardiomegaly are likely due to low lung volumes.,Acute respiratory distress syndrome (ARDS) secondary to sepsis.
"Frontal and lateral views of the chest were obtained.  A dual-lead left-sided AICD is again seen with leads extending to the expected positions of the right atrium and right ventricle.  The right costophrenic angle is not fully included on the image.  There are bilateral pleural effusions, which may be at least partially loculated.  Right upper lobe/suprahilar opacity underlying fiducial seed has increased since the prior study, raising concern for progression of malignancy.  Streaky right infrahilar opacity underlying chain sutures, may relate to chronic changes, although appears to have increased since the prior study.  The cardiac and mediastinal silhouettes are stable.","1.  Increased nodular opacity in the medial right apex/right suprahilar region underlying fiducial seeds, worrisome for progression of malignancy. 2.  Bilateral left greater than right pleural effusion, which is likely loculated at least on the left. 3.  Right infrahilar streaky opacity may relate to prior surgery/chronic changes but more acute component not excluded.",No acute cardiopulmonary abnormality is identified. Pleural fluid is present. Lung parenchyma is stable.
"PA and lateral radiograph of the chest once again demonstrate a right upper lobe mass with a fiducial marker in place as well as a right perihilar mass.  This is consistent with the patient's known malignancy.  Once again seen are a small right and moderate left pleural effusion, with considerable left lower lobe atelectasis or consolidation, which is stable from both the prior radiographs and the cross-sectional imaging.  The remainder of the lung fields are clear.  The pacemaker/ICD device and its two leads are unchanged.  There is no pneumothorax.  Pulmonary vascularity is normal.",No evidence of pneumonia or decompensated congestive heart failure.  Stable findings associated with the patient's known lung malignancy.,"""""""
    import re
    from collections import Counter

    text = re.sub('[^a-zA-Z0-9]','', text.lower())
    words = [word for word in text.split(' ') if len(word) > 2]
    counts = Counter(words)
    most_common = counts.most_common(10)

    return''.join([word[0] +'' + str(word[1]) + '%s' % ('' if i == len(words) - 1 else ', ') for (i, word) in enumerate(words)])"
"A pacemaker/ICD device with two leads appears unchanged.  The cardiac, mediastinal and hilar contours appear unchanged.  The pacer device overlaps persistent opacification of the left costophrenic angle that is probably unchanged, however, likely reflecting a combination of atelectasis and a small loculated pleural effusion.  There is persistent thickening of the minor fissure with possible fluid and atelectasis with a small right-sided pleural effusion.  Nodular suprahilar opacification on the right is associated with treated malignancy with an associated fiducial seed and appears stable.  There is no pneumothorax.  Free air is no longer apparent on this study.","Findings suggesting mild fluid overload including pleural effusions, but no definite superimposed process.","No acute cardiopulmonary abnormality is identified. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    text = re.sub(r""[^a-zA-Z0-9]"", "" "", text).lower()
    sentences = [word_tokenize(sent) for sent in list(sent_tokenize(text))]

    for i, sentence in enumerate(sentences):
        if len(sentence) < 3:
            sentences.pop(i)

    return "" "".join([word.lower() for word in sentences[0]])"
"Single frontal view of the chest demonstrates interval placement of a right subclavian approach central venous catheter with tip in the lower SVC. There is no pneumothorax.  A left pectoral cardiac pacer is stable in location with the leads terminating in the right atrium and right ventricle.  The lung volumes are low, accentuating mild pulmonary edema. There is retrocardiac opacity and blunting in the left costophrenic angle which may reflect atelectasis and a small effusion.",Appropriate central line positioning without pneumothorax.  Other findings unchanged since preceding exam.,"""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [x.strip() for x in findings.split(""\n"") if len(x.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        sentences[i] = re.sub(r""([A-Z])\1{2,}"", lambda m: m.group(0)[0]+""."",sentences[i])

    return sentences[0]"
"PA and lateral views of the chest are compared to previous exam from ___.  Dual-lead pacing device is again seen with lead tips in stable position.  Right upper lobe/suprahilar opacity with fiducial marker is again seen, not significantly changed from exam from two weeks prior.  Left side pleural effusion which is seen with loculation posteriorly.  There is mild pulmonary vascular congestion without frank pulmonary edema.  Free air seen below the right hemidiaphragm is compatible with daily peritoneal dialysis.  Osseous and soft tissue structures are unremarkable.",Mild pulmonary vascular congestion without evidence of overt pulmonary edema.  At least partially loculated left-sided pleural effusion with possible adjacent atelectasis.  Free air below the diaphragm compatible with peritoneal dialysis.  Right suprahilar mass as above.,No acute cardiopulmonary abnormality is identified.
"PA and lateral chest views were obtained with the patient in upright position.  Analysis is performed in direct comparison with the next preceding PA and lateral chest examination of ___.  Previously described heart size, mediastinal structures, and permanent pacer with dual electrode system remain unchanged.  The same holds also with the previously described loculated pleural effusion that blunts the left-sided lateral pleural sinus.  Parenchymal densities in the posterior portion of the left lower lobe remain unchanged as they present on the lateral view.  The only significant difference is the appearance of substantial amount of subdiaphragmatic air which was not found on the preceding chest examination.  Telephone contact with referring physician, ___. ___, explained this finding as the patient is daily abdominal dialysis.",Stable chest findings.  Persistent loculated pleural density on the left base and parenchymal density occupying posterior portions of the left lower lobe.,"No acute cardiopulmonary abnormality is seen on this chest x-ray. However, there is a new finding of a large amount (several liters) of air under the diaphragm. This is most likely due to a perforated viscus. The patient should be urgently referred to the emergency department for further evaluation and treatment."
"Dual-lead left-sided pacemaker terminates with leads in the proper position.  Chain sutures along the right lung base are again noted and appear stable.  Again visualized is a loculated small left pleural effusion as well as a small right pleural effusion, appearing stable in comparison to prior study.  There is a new confluent patchy opacity in left lower lobe in comparison to the prior study, which may be representative of developing pneumonia.  Otherwise, the remainder of the lungs is clear.  The cardiomediastinal silhouette remains stable.  The visualized osseous structures are stable.",1.  Stable small loculated left and small right pleural effusions. 2.  Heterogeneous opacity in the left lower lobe may be representative of developing pneumonia in the appropriate clinical setting.,Pacemaker in place. Pleural fluid. Pneumonia.
"Single frontal view of the chest demonstrates a left pectoral cardiac pacer with leads terminating in the right atrium and right ventricle.  The heart is top normal in size.  The mediastinal and hilar contours are within normal limits.  There are increased perihilar streaky opacities, which suggests pulmonary edema.  Right suprahilar pulmonary mass is redemonstrated, better correlated on cross-sectional imaging.  There is dense retrocardiac probable atelectasis and small left pleural effusion.",Mild pulmonary edema.  Small left effusion.,"""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        sentences.append("" "".join([word_tokenize(f)[0] if f[0].isupper() and len(f)>1 else f.split("" "")[0:2] 
                                    for j, (f, s) in enumerate(zip(cleaned_sentences[i], sentences[i])) if j % 2 == 0]))

    return sentences[-1]"
"There has been an increase in the bilateral pulmonary edema status post extubation as evidenced by increased dense opacification, which is now nearly confluent consistent with severe pulmonary edema.  The cardiomediastinal silhouette is difficult to evaluate given intervening pulmonary edema opacity, however appears unchanged.  There is no pneumothorax. There has been complete obscuration of the costophrenic angles suggestive of bilateral pleural effusions.  Right IJ catheter is unchanged in position and ends in the upper SVC.  Sternotomy wires are unchanged in position, aligned along the midline with no evidence of sternal dehiscence.","Worsening, now severe, bilateral pulmonary edema. Supervening pneumonia can certainly not be excluded in the appropriate clinical setting. Interval removal of endotracheal tube.  Cardiomediastinal silhouette stable.",Acute respiratory failure secondary to acute exacerbation of chronic obstructive pulmonary disease (COPD) and congestive heart failure (CHF).
"Frontal and lateral chest radiographs demonstrate minimal blunting of the bilateral costophrenic angles.  There is no focal consolidation or pneumothorax.  The heart size is moderately enlarged, and there are post-surgical changes of median sternotomy and CABG.  There is an indistinct appearance of the pulmonary vasculature, consistent with mild-to-moderate pulmonary edema.","1. Mild-to-moderate pulmonary edema, without focal consolidation to suggest pneumonia.  There may be small bilateral pleural effusions, with a small degree of bilateral atelectasis.  2. The heart is moderately enlarged.","Mild to Moderate Pulmonary Edema, Post-Surgical Changes of Median Sternotomy and Coronary Artery Bypass Graft (CABG)."
"Right-sided pleural effusion is again seen largely unchanged.  There is left-sided ground glass opacity which has slightly improved consistent with improving pulmonary edema.  Endotracheal tube is seen in appropriate position, 6 cm from the carina.  NG tube is seen entering the stomach and out of field of view.  Incidental note of right lateral pleural calcification which is better seen on CT imaging.",Improving pulmonary edema with unchanged bilateral pleural effusions.,"Pleural Effusion, Ground Glass Opacity, Tracheostomy Tube, Nasogastric Tube
    """"""

    if ""pleural"" and ""effusion"" in findings.lower():
        impression = ""Pleural""
    else:
        pass

    return impression"
"The patient has a history of chronic interstitial lung disease with waxing and waning pulmonary edema and infection. Today it is largely unchanged with diffuse infiltrative and interstitial opacities stable since ___.  Bilateral pleural effusion is essentially the same.  Cardiomediastinal silhouette is stable and demonstrates mild cardiomegaly.  There is no pneumothorax.  Enteric tube is seen once again, entering the stomach and then out of field of view.  Right-sided PICC terminates within the mid SVC.  An endotracheal tube terminates no less than 6 cm from the carina.",Study is essentially unchanged from priors with unchanged diffuse infiltrative and interstitial opacities.,"""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]+"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        sentences.append("" "".join([word_tokenize(f)[0].capitalize() + "" "" + f[1:] if i == 0 else f for (f, i) in zip(cleaned_sentences[i].split("".""), range(1))]))

    return ""\n"".join(sentences)"
"There has been interval decrease in ground-glass opacity bilaterally compared to prior study of ___ at 4:22 p.m., which represents decrease in pulmonary edema.  There has been interval decrease in observed cardiomegaly.  There is bilateral small amount of pleural effusion.  There are no areas of focal consolidations and no pneumothorax.  The pleural surfaces are unremarkable.  The endotracheal tube is no less than 6.2 cm from the carina, could be advanced 2 cm for optimal placement.",Interval reduction in pulmonary edema and cardiomegaly. ET tube can be advanced 2 cm for optimal placement.,"Decreased ground glass opacity, decreased cardiac size, small bilateral effusions. 

    ### Hints
    * Use the `nltk` library to perform natural language processing (NLP) tasks such as tokenization, part-of-speech (POS) tagging, named entity recognition (NER), and dependency parsing. These tasks will help you identify the main entities and their relationships in the text, which can then be used to generate the impression.
* Use a combination of NLP and machine learning (ML) techniques to improve the accuracy and robustness of your model. For example, you could use an ML algorithm to train a model on a large corpus of radiology reports and then use the trained model to make predictions on new data. This approach would allow you to leverage the power of ML while still taking advantage of the domain expertise provided by the radiologist."
"No focal consolidation, pleural effusion, or pneumothorax is seen.  Linear retrocardiac densities were seen previously and may represent atelectasis.  Lung volumes are low, exaggerating pulmonary vasculature and hila.  Heart and mediastinal contours appear similar compared to prior.  There is no evidence for free intraperitoneal air below the diaphragms.",Low lung volumes without radiographic evidence for acute process. Bibasilar atelectasis.  No evidence of free air beneath the diaphragms.,No acute cardiopulmonary pathology is identified. Atelectasis is present.
"Lungs are clear.  There is no consolidation, effusion, or edema.  The cardiomediastinal silhouette is within normal limits.  No acute osseous abnormalities.",No acute cardiopulmonary process.,Unremarkable chest x-ray.
The lungs are clear.  There is no focal consolidation or pneumothorax.  There is no vascular congestion or pleural effusions.  Mediastinal and hilar contours are within normal limits.  Moderate enlargement of the cardiac silhouette is unchanged from prior.  A moderate hiatal hernia is unchanged from prior.,1.  No acute cardiopulmonary process.  2.  Stable moderate cardiomegaly.  3.  Unchanged moderate hiatal hernia,No acute cardiopulmonary abnormality. Moderate cardiomegaly.
"PA and lateral views of the chest.  A PICC line ends in the mid-to-low SVC.  Small bilateral pleural effusions seen only on the lateral view have decreased since ___. Aside from minimal atelectasis at the posterior left lung base, the lungs are clear.  The aorta is tortuous but not dilated.  Heart size is normal.","1.  Minimal left basal atelectasis. 2.  Small bilateral pleural effusions, decreased in size compared to ___. 3.  No evidence of aspiration.",No acute cardiopulmonary disease.
Small-to-moderate bilateral pleural effusions are most apparent on the lateral projections. Heart size is normal.  A right-sided PICC line tip terminates in the mid SVC.  Nasogastric tube extends below the field of view and mitral valve ring is in unchanged position.  Mediastinal clips and sternal wires are intact. Bibasilar atelectasis has improved since ___.,Bilateral small to moderate pleural effusions.,No acute cardiopulmonary process is identified.
"Frontal and lateral views of the chest demonstrate low lung volumes, which accentuate bronchovascular markings.  There is no focal consolidation, pleural effusion or pneumothorax.  The hilar and mediastinal silhouettes are unremarkable.  Heart size is top normal.  Partially imaged upper abdomen demonstrates prominent air-filled large bowel loops.",No evidence of acute cardiopulmonary process.,No acute cardiopulmonary abnormality is identified.
The lung volumes are low.  There is similar mild relative elevation of the right hemidiaphragm.  The heart is at the upper limits of normal size.  The lungs appear clear.  There are no pleural effusions or pneumothorax.  There has been little if any change.,No evidence of acute disease.,Mild emphysematous changes. No acute cardiopulmonary disease.
"New pigtail is in right lower hemithorax with significant improvement of subpulmonic effusion.  Left lower lung pneumonia with small pleural effusion is slightly worse than ___ but improved since ___.  Patient had right upper lobe lobectomy and radiation therapy for cancer, this was better assessed in recent CT scan.",There is no pneumothorax after pigtail placement.   Right subpulmonic pleural effusion has significantly improved.,"""""""

    new_pigtail_in_right_lower_hemi = True
    significant_improvement_of_sub_pulmonary_effusion = False

    left_lower_lung_pneumonia_with_small_pleuraleffusion_is_slightly_worse_than___but_improved_since___.patient_had_right_upper_lobe_lobectomy_and_radiation_therapy_for_cancer_this_was_better_assessed_in_recent_ct_scan"
"PA and lateral views of the chest are provided.  A focus of scarring in the right upper lobe is better assessed on the prior CT from ___.  Increase in interstitial markings, which could indicate mild interstitial edema or atypical infection.  Heart size remains stable.  No pneumothorax.","Mild interstitial opacity could represent an atypical pneumonia or edema.  Otherwise, no change.","""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if f!= """"]

    impression = """"

    return impression"
"Single AP view of the chest.  Postoperative changes again seen in the right thoracic cavity.  Compared to prior, there appears to be less aerated lung on the right which could be due to enlarging effusion with possible underlying parenchymal abnormality.  In addition, there is persistent left basilar opacity not significantly changed given differences in technique.  Superiorly, the left lung remains clear.  Right PICC and right pleural catheter are again noted.","1.  Persistent left basilar opacity, compared to ___.  This could represent atelectasis although infection is not excluded.    2.  Less aerated lung on the right when compared to prior, potentially due to collecting pleural fluid although developing parenchymal abnormalities are also possible.",No acute cardiopulmonary process identified.
"There is notable interval improvement in the right pleural effusion.  There is a dense opacification with a rounded contour below the aerated right residual lung.  Though the contour has the appearance of an elevated right hemidiaphragm, this appears to represent a large subpulmonic effusion when compared to ___ chest CT.  There is improved aeration of the right lung with residual opacifications likely representing combination of atelectasis and known malignancy; cannot exclude superimposed infectious process.  Atelectatic changes are noted within the left lower lung with a slightly greater degree of collapse in the posterior medial subsegment.  Small left pleural effusion identified.  Abnormal contour of the right upper mediastinum is consistent with known malignancy.  Left-sided cardiomediastinal borders are unremarkable.",Interval mild improvement in right pleural effusion with likely a large residual subpulmonic pleural effusion.  Dense opacifications in the now apparent right residual lung likely represents a combination of atelectasis and known malignancy.  Small left pleural effusion.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []

    for finding in findings:

        sentences.append(finding)

    return ""\n"".join(sentences)

if __name__ == ""__main__"":

    import doctest

    print(doctest.testmod()[1])"
"The cardiac silhouette size remains mildly enlarged.  Patient is status post right upper lobectomy and right upper chest wall resection with evidence of volume loss in the right lung and posttreatment changes in the right upper lung field, unchanged.  Left hilar enlargement is unchanged, with mild pulmonary vascular congestion present. Moderate to large right pleural effusion and small left pleural effusion are again demonstrated, not significantly changed in the interval. Right basilar opacification is similar. No pneumothorax is identified. The aorta remains tortuous and calcified.",Mild pulmonary vascular congestion with moderate to large right pleural effusion and small left pleural effusions. Right basilar opacification may reflect atelectasis and/or infection.,Mild cardiomegaly. Postoperative changes. Hilar enlargement. Pulmonary congestion. Pleural fluid. Aortic tortuosity.
Post-treatment asymmetric appearance of the right hemithorax is unchanged with upper right rib resection and volume loss with rightward mediastinal shift and right hemidiaphragm elevation.  Suture chains project over the right hemithorax.  The opacification at the right lung has decreased from ___.  The left lung is clear.  No pleural effusion or pneumothorax is present.  The cardiac silhouette is normal in size.  The thoracic aorta is slightly unfolded.  Degenerative changes are again seen in the thoracic spine.,1.  No acute cardiopulmonary process. 2.  Stable post-treatment appearance of the right hemithorax with slightly decreased opacification of the right lung from ___.,"____
    """"""

    post_treatment_asymmetric_appearance_of_the_right_hemi = ""post treatment""
    unchanged_with_upper_right_rib_resection_and_volume_loss_with_rightward_mediastinum_shift_and_right_hepatic_dome_elevation = (
        ""unchanged with ""
    )
    suture_chains_project_over_the_rheumatoid_arthritis = (""suture chain"")
    the_right_lung_is_clear_no_pleural_effusion_or_pneumothrax_is_present_the_cardiac_silhouette_is_normal_in_size_the_thoracic_aorta_is_slightly_unfolded_degenerative_changes_are_again_seen_in_the_cervical_spine = """"
    impression = """"

    return impression"
"Single frontal view of the chest was obtained.  New heterogeneous opacity of the left lower lung is consistent with left lower lobe pneumonia.  Right lung volume loss status post thoracotomy is similar to prior exam.  Chain sutures overlying the lateral right lung and right hilum, and scarring of the right lung base are unchanged.  Heart size and cardiomediastinal contours are stable.",1.  Left lower lobe pneumonia.   2.  Stable changes status post right thoracotomy with right upper lobe lobectomy and apical radiation fibrosis.,"Left Lower Lobe Pneumonia
    """"""

    impression = """"
    return impression


if __name__ == ""__main__"":
    print(extract_impression())"
"AP and lateral views of the chest are compared to previous exam from ___.  Postoperative changes of right upper lobectomy are again noted.  There are new small bilateral pleural effusions.  Parenchymal opacity in the right upper lung and perihilar region have not significantly changed and could be in part due to post radiation/treatment changes.  Superiorly, the left lung is clear.  Cardiomediastinal silhouette is unchanged.  Degenerative changes of the right shoulder and post-thoracotomy changes on the right again noted.","Interval development of small bilateral pleural effusions.  Otherwise, no significant change.",No acute cardiopulmonary abnormality.
"Frontal and lateral views of the chest were obtained. The patient is status post right upper chest wall resection, right upper lobectomy with right apical scarring and upward traction of the right hilum from radiation fibrosis, all unchanged. There is no pleural effusion or pneumothorax. The left lung is clear. Heart size is normal.",Interval resolution of right pleural effusion.,No acute cardiopulmonary abnormality.
"There is a new moderate-to-large right-sided pleural effusion with volume loss suggesting extensive coinciding parenchymal atelectasis, substantially increased since the prior studies.  There is a persistent patchy left basilar opacity, but with general improvement in aeration of the left lower lobe and resolution of a small left-sided pleural effusion.  There is no pneumothorax.  A mild interstitial abnormality in each lung suggests mild fluid overload.  Post-operative changes are noted along the right chest wall including rib deformities, as seen previously.",Substantial increase in right-sided pleural effusion with volume loss.,"Pleural Effusion, Right, Moderate-To-Large, With Volume Loss, Substantially Increased Since The Prior Studies, Persistent Patchy Left Basilar Opacity, General Improvement In Aeration Of The Left Lower Lobe, Mild Interstitial Abnormality In Each Lung Suggests Mild Fluid Overload, Post-Operative Changes Are Noted Along The Right Chest Wall Including Rib Deformities"
"Postsurgical changes of a right upper lobectomy and right upper rib resection are unchanged.  Radiation changes are stable.  There is associated volume loss with elevation and tenting of the right hemidiaphragm.  There is atelectasis of the right middle lobe, unchanged from prior exams.  The previously seen right lower lobe nodular opacities have improved since the prior studies in ___.  There is no new opacification.  There is no pleural effusion or pneumothorax.  The cardiomediastinal silhouette is shifted rightward due to volume loss, but otherwise normal in shape and contour.  The osseous structures are unremarkable.","1.  Stable post-surgical and post-radiation changes of the right lung. 2.  Interval improvement of previously seen right lower lobe opacification. 3.  No new opacity, effusion, or pneumothorax.",No acute cardiopulmonary abnormality is identified.
"Patient is status post right upper lobectomy. As compared to prior chest radiograph from ___, there has been interval improvement of right pleural effusion. There is volume loss in the right hemithorax with associated cardiomediastinal shift to the right and tenting of the right hemidiaphragm. Post-radiation changes are noted along the right perihilar region. Left pleural effusion is stable and there is atelectasis at the left lung base. There are no new focal consolidations. There is no pneumothorax.  Sclerosis of the first and fourth rib as well as resection of the second and third rib are again noted, related to prior surgery. Right PICC terminates in the lower SVC.","Interval decrease of right pleural effusion, stable left pleural effusion. No new focal consolidations.","""""""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(line) for line in findings.split(""\n"") if line.strip()!= """" and not line.startswith(""Impression"")]

    words = Counter([word for word in "" "".join(findings).split() if word.isalpha() and len(word) > 2])
    top_words = words.most_common(10)

    impression = """"
    for i in range(1, len(top_words)):
        impression += f"" {top_words[i][0]}""

    return impression"
"Frontal and lateral radiographs of the chest were acquired.  Chronic deformity of the upper right thorax relates to prior chest wall resection.  Suture chain along the right perihilar region is consistent with prior right upper lobectomy, as is right apical scarring and superior retraction of the right hilus.  There is also suture chain noted along the lateral aspect of the upper right lung.  There is no focal consolidation.  There is no definite right pleural effusion.  Scarring is seen at the right lung base, not significantly changed.  There is no left pleural effusion.  No pneumothorax is seen.  The heart size is normal.  The mediastinal contour is unchanged.  Multilevel degenerative changes of the thoracic spine are noted.","1.  No acute cardiac or pulmonary process.  2.  Chronic post-surgical changes of the right lung and chest wall, as described above.",No acute cardiopulmonary abnormality is identified.
Cardiomediastinal contours appear unchanged from ___.  Patient is status post right upper thoracoplasty with rib resections. Left lung shows no focal consolidation. Pulmonary edema is improved since the prior exam.,Improved pulmonary edema.,No acute cardiopulmonary abnormality.
"Both lungs are well expanded with mild flattening of the bilateral hemidiaphragm and increased AP diameter of the chest consistent with chronic pulmonary disease.  Bilateral prominent pulmonary arteries raise the concern for pulmonary artery hypertension.  An ill-defined opacity is seen in posterior lower lung in the retrocardiac region overlying the lower spine and is concerning for pneumonia.  This opacity is not very well defined on the frontal view except for a faint opacity in the right lower paracardiac region. A single pacemaker lead from left pectoral pacemaker device terminates into the right ventricle.  Top normal heart size, mediastinal and hilar contours are unchanged since ___.  Mild atherosclerotic calcification of the aortic arch is stable.","1.  Ill-defined opacity appreciated only on the lateral view in the posterior inferior lower lung overlying the spine shadow is concerning for pneumonia and since it is not clearly defined on the frontal view, it suggests lower lobe pneumonia either involving the right or left side.  2.  COPD.  3.  Pulmonary artery hypertension, unchanged since ___.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [x.strip() for x in findings.split(""\n"") if len(x.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        sentences[i] = re.sub(r""([a-z])([A-Z])"", r""\1 \2"", sentences)

    return sentences

if __name__ == ""__main__"":
    import argparse
    parser = argparse.ArgumentParser(description='Process some integers.')
    args = parser.parse_args()
    print(extract_findings(args.findings))"
The left lower lobe pneumonia has resolved.  Median sternotomy wires and pacer are noted.  Moderate cardiomegaly is unchanged.,Resolved left lower lobe pneumonia.,Unremarkable chest x-ray.
"Portable AP upright view of the chest was provided.  Midline sternotomy wires are again noted.  There is a left chest wall pacer with lead tip in the region of the right ventricle.  The heart is top normal in size.  The mediastinum is slightly prominent, stable, reflecting an unfolded thoracic aorta.  Aortic calcifications are present.  Increased perihilar opacity is noted as well as consolidation containing an air bronchogram within the right upper lobe.  Findings are concerning for pneumonia.  No effusion is seen.  There is no pneumothorax.  The bony structures appear intact.",Perihilar and right upper lobe consolidation concerning for pneumonia.,"Pneumonia
    """"""

    impression = """"

    return impression


if __name__ == ""__main__"":
    print(extract_clinical_information())"
PA and lateral views of the chest.  Left-sided pacemaker is unchanged in position.  Sternotomy wires and upper mediastinal clips are stable.  Right mid to upper lung opacity have decreased significantly.  No pleural effusion or pneumothorax.  No new consolidations.,"No evidence of pulmonary edema.  Resolving right upper lobe consolidation.  If concern for central obstructing mass, follow up films can be obtained for further assessment.",Significant improvement in right upper lobe pneumonia.
"The patient is status post median sternotomy and CABG.  Left-sided pacemaker device is noted with single lead terminating in the right ventricle, unchanged.  The aortic knob is calcified and aorta remains mildly tortuous.  There is new mild pulmonary vascular congestion.  Hyperinflation of the lungs is re- demonstrated.  New consolidative opacity within the right upper lobe is concerning for pneumonia.  And ill-defined nodular opacity within the right upper lung field measuring up to 10 mm is also new, and likely infectious in etiology.  No large pleural effusion or pneumothorax is present.  No acute osseous abnormality is seen.  There are multilevel degenerative changes in the thoracic spine.",New right upper lobe pneumonia.  Mild pulmonary vascular congestion.,"Pneumonia, Infectious, Right Upper Lobe; Mild Pulmonary Vascular Congestion; Degenerative Changes, Thoracic Spine; Status Post Median Sternotomy and Coronary Artery Bypass Grafting; Pacemaker Device, Left-Sided, Single Lead Terminating in Right Ventricle; Aortic Knob, Calcified; Tortuous Aorta, Mild; Pleural Effusion, Large, Absent; Pneumo Thorax, Acute, No; Nodular Opacity, Ill-Defined, Up to Ten Millimeters, New; Hyper Inflation, Lungs, Re-Demonstrated"
"PA and lateral chest views were obtained with patient in upright position.  Comparison is made with the next preceding similar study of ___.  Moderate elevation of right-sided hemidiaphragm as before.  Two chest tubes entered from the lower lateral chest wall terminate in unchanged position, draining the area of the previous empyema.  The lowermost of the two tubes is in unchanged position, whereas the higher ending tube has been withdrawn by a few centimeters, but still remains in place.  The size of the pleural density that forms a triangular thickening of the right lateral and posterior pleural space has decreased slightly in comparison with the next previous study.  There is no evidence of any new cavitation, loculated pneumothorax or other new parenchymal abnormalities.  The left-sided hemithorax remains completely unchanged and within normal limits.","Mild regression of pleural thickenings, no new abnormalities, no pneumothorax.","""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        sentences[i] = re.sub("" +"","" "",sentences[i])

    return ""\n"".join([s for s in sentences])"
"PA and lateral chest views were obtained with patient in upright position.  Comparison is made with the next preceding similar study of ___.  Mediastinal and cardiac structures are unchanged.  Thus, no evidence of cardiac enlargement.  The pulmonary vasculature is not congested.  Right-sided status post decortication procedure as before.  Unchanged moderate degree of diaphragmatic elevation.  The previously described two pleural drainage chest tubes remain in position.  Comparison shows that both tubes have been withdrawn by up to 2 cm, but basically, the position is unaltered.  No pneumothorax has developed.  No remaining pneumothorax is seen in the apical areas.",Satisfactory findings on followup examinations.  Minor change in chest tube positions as expected.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    sentences = []

    for finding in findings:

        sentences.append(finding)

    return "" "".join(sentences)"
"Chronic left-sided rib fractures are again noted.  The cardiomediastinal and hilar contours are unchanged from ___. Pleural thickening and blunting at the right costophrenic angle is again demonstrated, and is stable from the prior exam in ___ and likely represents pleural scarring and a small pleural effusion.  No focal consolidation or pneumothorax is identified.","Multiple chronic appearing left-sided rib fractures.  No pneumothorax. Blunting of the costophrenic angle on the right likely represents pleural scarring and a small effusion, not significantly changed from ___.","No acute cardiopulmonary abnormality is seen. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r'[^\w\s]', '', text)
        return''.join([word.lower() for word in text.split() if word.isalpha() and len(word) > 1])

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        sentence = ''
        for j, w in enumerate(word_tokenize(cleaned-findings[i])):
            if j == 0:
                sentence += w
            elif w[0].isupper():
                if sentence[-1] =='':
                    continue
                elif sentence!= '':
                    sentences.append(sentence.strip().capitalize() + '.')
                    sentence =''
            else:
               sentence+=w+' '
        if len(sentence) >= 2:
            sentences += [sentence.strip()]
    return sentences"
"There has been interval placement of a right pleural pigtail catheter projecting over the right lower chest and protruding no more than 2.5cm into the chest with associated interval decrease in size of a right pleural effusion.  A right pleural effusion remains, with right basilar opacity likely representing persistent atelectasis.  The cardiac silhouette is normal in size.  The mediastinal contours are normal.  The known prominent subcarinal node is not well appreciated.","Interval right pleural pigtail catheter placement, which projects of the lower right chest, and protrudes not more than 2.5 cm into the chest.  There has been interval decrease in size of a right pleural effusion, persistent right basilar atelectasis is seen.","No acute cardiopulmonary abnormality is identified. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        if i == 0:
            sentences.append(sentences[-1] + "" "" + cleanings[i])
        elif i > 1 and i < len(cleanings):
            if re.search(r""\s[a-z]\s"", sentences[i-1]):
                continue
            elif re.match(r"".*[a-z].*.*[A-Z].*"", sentences[-2]) and not re.findall(r""[\d]{1,2}\s[A-Za-z]{2,3}"", sentences[:-2][-1]): 
                sentences.insert(i, "" "")
            else:
                pass
                #sentences.append("" "")

    return "" "".join([s.strip() for s in sentences])"
"The left lung is well expanded and clear.  The right lung shows a persistent right lower lobe opacity with an associated effusion, mildly progressed from the preceding radiograph.  The cardiomediastinal silhouette, and hilar contours are normal.  No pneumothorax is present. Old bilateral rib fractures are noted.","Right lower lobe opacity, possibly atelectasis, with associated moderate sized effusion.","No acute cardiopulmonary abnormality is identified. 

    """"""

    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]+"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings.split(""\n"") if len(f.strip()) > 0]

    word_counts = Counter([w for w in "" "".join(findings).split() if w.isalpha()])

    most_common_words = list(word_counts.most_common(10))

    impression = """"

    for i in range(1, 4):

        if i == 1:
            impression += ""No acute ""

        elif i < 3:
            
            if impression[-1]!= "" "":
                impression+= "" ""

            else:

                if not any([word in impression for word in [""acute"",""abnormality""]]):
                    continue

                else:
                    impression+=""and""

        impression+="", ""

    return impression[:-2] + ""."""
"PA and lateral chest views were obtained with patient in upright position.  Comparison is performed with the next preceding similar study of ___.  Heart size and mediastinal structures unchanged.  On the right base, the previously described two pleural chest tubes remain in unaltered position.  The degree of pleural densities blunting the lateral and posterior pleural sinus has regressed mildly.  No new pulmonary abnormalities are present.  No pneumothorax has developed.  Left-sided hemithorax is unremarkable as before.","Mild regression of pleural densities right base in a patient with known empyema, still with chest two draining and tubes.  No pneumothorax.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [x.strip() for x in findings.split(""\n"") if len(x.strip())>0]

    sentences = []
    for i in range(len(sentences)):
        sentence = sentences[i].strip()
        if sentence == """":
            sentences.pop(i)
            i -= 1
        elif sentence[0].isupper() and sentence[-1]!= ""."":
            sentence += "".""
        sentences.insert(i, sentence)

    return ""\n"".join([s for s in sentences])"
"The three chest tubes remain stable in position compared to the prior study.  The appearance of the right hemithorax including the clips is unchanged as compared to the previous examination; however, it appears that the soft tissue collection of air has increased in size.  There is increased gas filling of colon interposed between the chest wall and the liver, and continued elevation of the right hemidiaphragm.  Unchanged normal appearance of the cardiac silhouette and the left lung.  No current evidence of pneumothorax.",Findings remain stable compared to the previous study with the exception of increased air with the soft tissues of the right lateral chest wall.,"Increased size of right-sided pleural effusion. 

    """"""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    impressions = []

    for i in range(len(impressions)):

        impression = impressions[i].strip()

        if impression == """":
            continue

        impressions.append(impression)

    return impressions"
"Cardiac silhouette size is top normal.  Mediastinal and hilar contours are unchanged.  There is no pulmonary vascular congestion.  There is a small right pleural effusion with chronic elevation of the right hemidiaphragm, unchanged compared to the previous exam.  Right basilar atelectasis is again demonstrated.  No left-sided pleural effusion or pneumothorax is present.  There are multiple old left-sided rib fractures.  Multilevel degenerative changes are visualized in the thoracic spine.  Chronic left AC joint dislocation is re- demonstrated.","Relatively unchanged exam with continued small right pleural effusion, chronic elevation of the right hemidiaphragm and right basilar atelectasis.","No acute cardiopulmonary pathology is identified. 

    """"""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
"PA and lateral chest views have been obtained with patient in upright position.  Comparison is made with the next preceding portable AP single chest view of ___.  Right-sided chest tube remains in place terminating somewhat lower than on the preceding study in the apical area.  The second lower right chest tube remains in unchanged position.  Small amount of right-sided pleural effusion persists blunting the lateral and posterior pleural sinus.  No new parenchymal infiltrates are seen, and no significant pneumothorax has developed in the apical area.  The left-sided hemithorax remains unchanged with no new infiltrates.  As before, there are local rib deformities apparently related to previous old trauma as already observed on previous chest CT.",Stable appearance of right-sided postoperative small apical pneumothorax and pleural effusion.,"""""""

    return (
        ""Normal chest x-ray""
    )"
AP and lateral views of the chest.  Right PICC is no longer visualized.  The lungs are clear of consolidation or effusion.  Cardiac silhouette is enlarged but stable.  All left posterior 7th rib fracture is identified.  Atherosclerotic calcifications noted at the aortic arch.,No acute cardiopulmonary process.,No acute cardiopulmonary abnormality. Rib fracture stable.
"Frontal and lateral views of the chest were obtained.  Previously seen left perihilar consolidation has resolved in the interval.  The bilateral pleural effusions have also resolved.  Paratracheal opacity in the upper thorax, likely secondary to goiter seen on chest CT from ___, in conjunction with mediastinal nodes also seen on that study.  No focal consolidation, pleural effusion, or evidence of pneumothorax is seen.  The cardiac silhouette is top normal to mildly enlarged, with left ventricular configuration.  Mediastinal contours are stable.  There is an old rib deformity/fracture of the posterior lateral left seventh rib, also seen on the prior chest CT.","1.  No acute cardiopulmonary process. 2.  Paratracheal opacity most likely relates to enlarged thyroid gland seen on chest CT from ___, and followup recommendations per that CT remains.",No acute cardiopulmonary abnormality is identified.
The heart is normal in size.  The mediastinal and hilar contours appear within normal limits and do not suggest substantial lymph node enlargement.  There is no pleural effusion or pneumothorax.  The lungs appear clear.  Mild degenerative changes are similar along the thoracic spine.,No evidence of acute disease.  No convincing evidence for sarcoidosis.,Unremarkable chest x-ray.
Frontal and lateral views of the chest and 2 additional views of the left-sided ribs were obtained.  A BB marker projects over the lateral ninth and ___ left ribs indicating patient's site of concern.  No displaced fracture is seen.  The lungs are clear without focal consolidation.  No pleural effusion or pneumothorax is seen.  The cardiac and mediastinal silhouettes are unremarkable.  There may be very minimal left basilar linear atelectasis/scarring.,No acute cardiopulmonary process.  No displaced rib fracture seen.,"""""""

    return ""Normal chest x-ray"""
"A known mass in the left upper lobe is not clearly identified. No new opacity pulmonary edema, pleural effusion or pneumothorax.  The cardiac and mediastinal contours are stable.",No new opacity concerning for infection.,No acute cardiopulmonary abnormality.
"Heart size remains mildly enlarged.  Aortic knob is calcified.  Mediastinal and hilar contours are unchanged.  Previously noted left upper lobe mass appears more vague with surrounding ill-defined opacity, possibly related to infection.  There is a lingular opacity which is new compared to the prior study, and could reflect an area of infection.  The right lung is grossly clear.  No pleural effusion or pneumothorax is seen.  There are no acute osseous abnormalities.",1. Lingular opacity is concerning for infection in the correct clinical setting.  2. Previously seen left upper lobe mass appears more vague with adjacent ill-defined opacity which could reflect post-treatment changes.,Mildly enlarged heart. Calcified aorta. Lingular pneumonia.
Single portable view of the chest.  Low lung volumes seen on the current exam.  There is secondary crowding of the bronchovascular markings.  Vague opacity again seen in the left mid to upper lung in the region of patient's known underlying mass.  Lingular opacity is most compatible with a prominent fat pad.  Cardiomediastinal silhouette is stable.  Atherosclerotic calcifications again seen at the aortic arch.,No definite acute cardiopulmonary process given portable technique and poor inspiratory effort.,No acute cardiopulmonary abnormality identified.
"The previously described left upper lobe mass is not seen on this radiograph.  Linear opacities in the left upper lobe can be and a sequelae of prior treatment lung carcinoma.  No pulmonary edema, pleural effusion or pneumothorax.  The cardiomediastinal contours are unchanged.",Left upper lobe linear opacities at site of prior treatment for lung carcinoma.,"No acute cardiopulmonary abnormality is seen. 

    """"""

    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    word_counts = Counter("" "".join(findings).split())

    most_common = sorted(word_counts.items(), key=lambda x: x[1], reverse=True)

    impression = """"

    for i, word in enumerate(most_common):

        if i > 5:
            break

        impression += word[0] + "" ""

    return impression"
New alveolar consolidation is seen around left upper lobe cavitary lesion compatible with important bleeding after biopsy.  Right lung is unremarkable.  There is no pneumothorax or pleural effusion.  Mediastinal and cardiac contour are within normal limits.,New consolidation is seen around left upper lobe cavitary lesion compatible with important hemorrhage post-biopsy.,"""""""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    pattern = re.compile(r'[^a-zA-Z0-9\s]')

    def clean_text(text):
        text = pattern.sub('', text)
        return''.join(word_tokenize(text.lower()))

    findings = [clean_text(f) for f in findings.split('\n')]

    sentences = []
    for i in range(len(findings)):
        if i % 2 == 0:
            sentences.append(''.join([findings[i], findings[i+1]]))

    impression = ''.join(sentences)

    return impression"
"Severe cardiomegaly persists.  A left subclavian vascular stent is re- demonstrated.  Mediastinal contours are unchanged.  There is pulmonary vascular congestion,slightly worse in the interval.  A small amount of fluid is noted within the minor fissure.  No focal consolidation, pleural effusion or pneumothorax is demonstrated.","Pulmonary vascular congestion, slightly worse in the interval.","""""""

    if len(findings) == 0:
        return None

    findings = [f.strip() for f in findings.split('\n') if f!= '']

    sentences = []

    for finding in filter(lambda x: len(x) > 1, findings):
        if finding[0].isupper():
            sentences.append(finding)

    return''.join(sentences)"
"There is similar moderate-to-severe cardiomegaly.  The cardiac, mediastinal and hilar contours appear stable.  The pulmonary vasculature is engorged and indistinct including upper zone redistribution.  Fissures are thickened.  A linear opacity in the left mid lung appears unchanged and suggests minor scarring or atelectasis.  A left subclavian venous stent is again demonstrated.  There has been no significant change.",Findings suggesting mild pulmonary edema.  Similar cardiomegaly.  Stable mediastinal contours.,Severe chronic obstructive pulmonary disease (COPD) with emphysematous changes.
Redemonstration of moderate-to-severe cardiomegaly is noted.  There is pulmonary vascular congestion consistent with edema.  There is vague increased opacity at the left costophrenic angle which may reflect atelectasis versus a small pleural effusion.  Redemonstration of a left subclavian venous stent is again noted.  There is no evidence of pneumoperitoneum.  Osseous structures are unchanged.,1.  Opacity at left costophrenic angle likely reflects atelectasis vs. pleural fluid.  2.  Pulmonary edema.,"Moderate-to-Severe Cardiomegalia, Pulmonary Vascular Congestion Consistent With Edema, Vague Increased Opacity At The Left Costophronic Angle Which May Reflect Atelectasis Versus A Small Pleural Effusion, Redemostration Of A Left Subclavien Venous Stent Is Again Noted, No Evidence Of Pneumoperitonium, Oseseous Structures Are Unchanged."
"A single AP radiograph of the chest was acquired.  There is redemonstration of a right tunneled internal jugular central venous catheter, ending in the mid-to-low SVC.  There is a small quantity of fluid within the minor fissure.  There is minimal linear left mid lung atelectasis.  There is also subsegmental bilateral lower lung atelectasis.  The heart is moderately enlarged, as seen on the prior radiograph from ___.  There are no definite pleural effusions.  No pneumothorax is seen.","1.  Minimal left mid and bibasilar atelectasis.  No focal consolidation.  2.  Moderate cardiomegaly, as seen on the prior chest radiograph from ___.",No acute cardiopulmonary abnormality is identified.
"The ET tube terminates 3.9 cm above the carina.  There is an enteric tube which extends well below the diaphragm.  Again seen is severe cardiomegaly, stable since at least ___.  The lung volumes continued to be low with evidence of elevated pulmonary venous pressure and moderate bilateral pleural effusions, left greater than right.  There appears to be slight interval worsening of the bibasilar atelectasis.  There is no evidence of a pneumothorax. Note is again made of stable elevation of the right hemidiaphragmatic contour.","Slight interval worsening of atelectasis at the left lung base.  Stable moderate bilateral pleural effusions, left greater than right.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [x.strip() for x in findings.split(""\n"") if len(x.strip())>0]

    sentences = []
    for i in range(len(sentences)):
        sentences[i] = re.sub(r""[^A-Za-z0-9(),!?\'\`]"", r"" "", findings[i]).lower().split()
        # Remove punctuation from each word and split them
    return sentences"
"Frontal and lateral views of the chest were slightly limited due to patient's body habitus.  Lung volumes are low, which accentuate bronchovascular markings.  Mild pulmonary edema is unchanged.  There is mild thickening of the minor fissure.  Bibasilar opacities are noted.  There is no pleural effusion.  Moderate cardiomegaly is stable.  Hilar and mediastinal silhouettes are unchanged.  A dual-chamber dialysis catheter tip projects over proximal right atrium.",Stable mild pulmonary edema and moderate cardiomegaly.  Bibasilar opacities may represent atelectasis or infection in the appropriate clinical setting.,Mild chronic obstructive pulmonary disease and mild congestive heart failure. No acute cardiopulmonary process is identified.
"Endotracheal tube tip terminates approximately 2.6 cm from the carina.  Orogastric tube is seen coursing below the diaphragm, with the tip not well visualized.  The heart remains severely enlarged.  There is mild pulmonary edema which has progressed compared to the previous study with a probable layering left pleural effusion.  Persistent bibasilar airspace opacities again may reflect atelectasis, aspiration or infection.  There is no large pneumothorax on this supine study.",Low lying endotracheal tube with tip terminating approximately 2.6 cm above the carina. Orogastric tube courses below the diaphragm.  Worsening mild pulmonary edema with layering left pleural effusion.,Severe cardiomegaly. Pulmonary congestion. Pleural fluid. Atelectasis. Aspiration. Pneumonia.
There is mild-to-moderate interstitial pulmonary edema.  The heart is moderately enlarged but not significantly changed in size compared to ___.  No definite pleural effusions are seen.  There is no pneumothorax.,"Mild-to-moderate pulmonary edema, likely cardiogenic.",Mild to Moderate Interstitial Pulmonary Edema with Moderate Enlargement of the Heart.
"Low lung volumes are again noted.  There are however persistently increased interstitial markings which appear slightly progressed compared to prior.  There is no pleural effusion. The cardiac silhouette is enlarged, as on prior. Left subclavian stent is again seen.",Pulmonary edema is slightly worse than on recent exam.,Interstitial lung disease. Cardiomegaly.
Two frontal images of the chest were obtained.  This exam is limited by underpenetration due to patient's body habitus and by rotation of the patient.  There is increased vascular congestion since previous imaging.  The right IJ catheter is seen with the tip in the mid to low SVC.  No pneumothorax or other complications are identified.  The relative radiolucency of the left lung compared to the right lung is likely an artifact secondary to patient rotation.  There is no clear evidence of pleural effusion on this exam.  Cardiomediastinal silhouette is unchanged.,Worsening pulmonary vascular congestion.  New right IJ line with tip in the mid to low SVC.,No acute cardiopulmonary abnormality is identified.
"Frontal and lateral views of the chest.  Severe cardiomegaly has increased since ___ with right and left atrial enlargement, consistent with right heart decompensation.  Lung volumes are low with a possibly small left pleural effusion.  No focal consolidation or pneumothorax.  A left subclavian vascular stent is new since the prior exam.",Increased cardiomegaly.  No focal consolidation.,"""""""

    impression = """"

    return impression"
"The inspiratory lung volumes are low.  The cardiac silhouette is moderately enlarged, but stable from the prior study.  The mediastinal and hilar contours are not significantly changed from the prior radiograph allowing for patient rotation on the current examination.  No significant pleural effusion or pneumothorax is detected.  A small amount of fluid is noted in the right minor fissure.  Mild pulmonary edema is present.  A right dual-chamber dialysis catheter is in position with the tip terminating at the cavoatrial junction or proximal right atrium.  The visualized upper abdomen is gasless.",Mild pulmonary edema.  Moderate cardiomegaly.,Moderate cardiomegaly with mild pulmonary congestion. No evidence of acute intrathoracic or intraabdominal pathology.
"Moderate cardiomegaly is all stable compared to the prior exams dated back to at least ___.  There has been an interval increase in bilateral moderate pulmonary edema with interstitial thickening and perihilar vascular congestion compared to the prior exam from ___.  There may be small bilateral pleural effusions.  There is no evidence of pneumothorax.  The visualized osseous structures are unremarkable.  Note is made of a left subclavian stent, overall unchanged in position compared to the prior exam.","Moderate pulmonary edema, overall increased compared to the prior exam from ___.","""""""

    assert len(findings) > 0, ""Findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for i, finding in enumerate(re.split(r'(?<=[.!?])\s+(?=[A-Z])', findings)):
        sentences.append(f""Finding {i+1}: {finding}"")

    return ""\n\n"".join(sentences)"
A dialysis catheter terminates in the right atrium.  There is a vascular stent projecting over the left chest apex which probably corresponds to a left subclavian venous stent.  The heart is again moderately enlarged.  The lung volumes are low.  There is no pleural effusion or pneumothorax.  The lungs appear clear.,No evidence of acute disease.,Moderate cardiomegaly. Vascular stents. No acute cardiopulmonary disease.
AP and lateral views the chest were viewed.  The cardiomediastinal and hilar contours are stable with severe cardiomegaly.  There is no pleural effusion or pneumothorax.  There is no focal consolidation concerning for pneumonia.  A possible small nodule is the right mid lung zone could be evaluated electively with chest CT if indicated.,No acute process. Possible nodule in the right mid lung zone. Nonurgent chest CT may be obtained for further evaluation.,"No acute cardiopulmonary abnormality is seen on this chest x-ray. 

    """"""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    sentences = []

    for finding in findings:

        if ""no"" in finding.lower():
            sentences.append(finding)
            continue

        words = finding.split("" "")

        for word in words:
            if word[0].isupper() and len(word)>1:
                sentence = "" "".join(words[:words.index(word)+1])

                if sentence[-1] not in [""."",""!"",""?""]:
                    sentence += "".""

                sentences += [sentence]
                break

    return sentences"
"AP single view of the chest has been obtained with patient in sitting semi-upright position.  Comparison is made with the next preceding similar study of ___.  Unchanged appearance of cardiac enlargement without typical configurational abnormality.  Mediastinal structures also unchanged.  The pulmonary vasculature is not congested anymore and there is no evidence of pleural effusion as the lateral pleural sinuses are free.  No new pulmonary parenchymal infiltrates can be identified.  No pneumothorax is seen in the apical area.  As before, a right internal jugular approach central venous line is seen and terminates in the mid portion of the SVC.",No evidence of new acute pulmonary infiltrates.  Observe that chest image quality is limited related to patient's morbid obesity.,"""""""

    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings.split(""\n"") if len(f.strip()) > 0]

    word_counts = Counter([w for w in "" "".join(findings).split("" "") if w.isalpha() and len(w) >= 3])
    most_common_words = list(word_counts.most_common(10))

    impression = """"

    for word, count in reversed(sorted(wordcounts.items(), key=lambda x: x[1], reverse=True)):
        impression += word + "" ""

    return impression"
A right subclavian approach dialysis catheter is again noted with tip terminating in the right atrium. A left subclavian vein stent is visualized projecting over the left lung apex. Moderate cardiomegaly is again visualized. The mediastinal and hilar contours are unremarkable. There is no pneumothorax or large pleural effusion. Lung volumes are slightly low without focal consolidation concerning for pneumonia. There is no overt pulmonary edema.,No acute cardiopulmonary process.,No acute cardiopulmonary abnormality is identified.
"Severe cardiomegaly is unchanged.  The mediastinal and hilar contours are similar.  There is mild pulmonary vascular engorgement, also unchanged.  Bibasilar airspace opacities could reflect atelectasis though infection or aspiration cannot be excluded.  No large pleural effusion or pneumothorax is seen.",Mild pulmonary vascular engorgement and bibasilar opacities possibly reflecting atelectasis but infection or aspiration cannot be excluded.,"""""""

    assert len(findings) == 1
    findings = findings[0]

    sentences = []
    for sentence in findings.split("".""):
        sentence = sentence.strip()
        if len(sentence) > 0:
            sentences.append(sentence)

    impression = "" "".join(sentences)
    return impression"
"The lateral radiograph is essentially nondiagnostic due to underpenetration likely due to patient body habitus.  On frontal radiograph, lung volumes are low with bibasilar atelectasis.  Evaluation is somewhat limited due to patient body habitus.  The cardiac silhouette is enlarged.  Double-lumen central venous catheter appears similarly positioned.  Mild interstitial edema persists. No pneumothorax is seen.","Limited study with persistent mild interstitial edema and cardiomegaly.  Bibasilar opacities, atelectasis, can not exclude infection.",Underpenetrated chest x-ray. Enlarged heart. Atelectasis bilaterally.
Single AP upright image of the chest was obtained.  There is a left basilar opacity.  No right sided pleural effusion. No pulmonary edema. Unchanged markedly dilated cardiac silhouette.  No pneumothorax.  No bony abnormality.  No free air below the hemidiaphragm.,"Left basilar opacity possibly due to pneumonia, effusion, atelectasis or a combination of the above.  Stable severe cardiomegaly.","""""""

    impression = """"

    return impression"
"The cardiomediastinal and hilar contours are stable, with stable severe cardiomegaly.  No pulmonary consolidation, edema or pneumothorax is seen.  A small left pleural effusion is present.",Severe cardiomegaly and a small left effusion.  No evidence of pneumonia.,"""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    assert len(findings) > 0, ""findings cannot be empty""

    findings = re.sub(r'\s+','', findings).strip()

    sentences = [s.strip() for s in re.split(r'(?<!\w\.\w.)(?<![A-Z][a-z]\.)\s', findings) if s.strip()]

    if len(sentences) == 1:
        return sentences[0]

    impressions = []

    for sentence in sentences:

        sentence = sentence.strip()

        if not sentence:
            continue

        impression = ''

        for word in sentence.split(' '):

            word = word.lower()

            if word.startswith('the') or word.endswith('s'):

                impression += word +''

        impressions.append(impression.strip())

    return max(impressions, key=len)"
There is stable marked enlargement of the heart with mild pulmonary vascular congestion without overt edema.  Retrocardiac opacity with subtle air bronchograms could reflect left lower lobe pneumonia.  Small left pleural effusion cannot be excluded.  There is no pneumothorax or right pleural effusion.,"Possible left lower lobe pneumonia. If clinical status permits, PA and lateral radiographs would allow for better evaluation.",Marked cardiomegaly with pulmonary congestion and possible pneumonia.
"Diffusely enlarged cardiomediastinal silhouette is stable and chronic dating back to ___.  Compared with most recent prior radiograph, bibasilar opacities have resolved.  No focal consolidation, pleural effusion or pneumothorax is present.  There is no evidence of pulmonary vascular congestion.",No acute intrathoracic process.  Stable chronic severely enlarged cardiac silhouette.,No acute cardiopulmonary abnormality.
Frontal and lateral views of the chest were obtained.  Severely enlarged cardiac silhouette is again seen.  Small left greater than right pleural effusions remain.  Mediastinal and hilar contours are similar.  No displaced fracture is seen.,"1.  No displaced fracture, however, if clinical concern for fracture persists of the ribs, suggest dedicated rib series, which is more sensitive. 2.  Persistent severe enlargement of the cardiac silhouette and small bilateral pleural effusions.",Severe cardiomegaly. Small bilateral effusion. No evidence of fracture.
"Mild cardiomegaly has been stable compared to exams dated back to at least ___.  There is increased mild pulmonary vascular congestion, otherwise the hilar and mediastinal contours are unremarkable.  There has been an interval increase in diffuse interstitial markings throughout the lungs bilaterally, as well as new small bilateral pleural effusions.  There is no evidence of pneumothorax.  The visualized osseous structures are unremarkable.","Diffuse bilateral interstitial opacities, very likely secondary to increased pulmonary edema from congestive heart failure, on a background of patient's known chronic interstitial lung disease.  Short term follow up radiographs after diuresis is recommended to ensure resolution and to exclude other process such as atypical pneumonia or acute exacerbation of interstitial lung disease.","Mild congestive heart failure, likely due to chronic obstructive pulmonary disease (COPD) and/or left ventricular systolic dysfunction (LVSD)."
"The cardiac and mediastinal silhouettes are stable. No lobar consolidation is seen. There is subtle increased interstitial markings in the left mid lung zone, with possible mild peribronchial thickening. No pleural effusion or pneumothorax is seen. There is persistent compression of a mid thoracic vertebral body.",Slight increase in interstitial markings in the left mid lung zone which may in part relate to peribronchial thickening although atypical infection not excluded.  The remainder of the study is unchanged.,No acute cardiopulmonary abnormality is identified. Mild degenerative changes of the spine are noted.
"Prominent bilateral interstitial lung markings are on changed. There is no focal consolidation, pleural effusion or pneumothorax. The heart and mediastinum are magnified by the projection, but stable dating back to ___. Regional bones and soft tissues are unremarkable.",Mildly prominent bilateral interstitial opacities which may be due do atypical infection reverses edema.,"___
    """"""

    impression = ""___""

    return impression


if __name__ == ""__main__"":
    print(extract_impression())"
"There has been no significant interval change. Re- demonstrated is diffuse increase and interstitial markings bilaterally consistent with chronic lung disease, grossly stable. No focal consolidation is seen. There is no pleural effusion or pneumothorax. The cardiac and mediastinal silhouettes are stable.",No significant interval change.,No acute cardiopulmonary process is identified. Chronic lung parenchymal disease is unchanged.
"The heart is at the upper limits of normal size.  The mediastinal and hilar contours appear unchanged.  There is mild interstitial abnormality suggestive of slight fluid overload, but no focal consolidation.  The lungs are hyperinflated.  There is no pleural effusion or pneumothorax.  A moderate anterior wedge compression deformity situated along the lower thoracic spine appears unchanged since the prior studies.",Similar mild interstitial abnormality which could be seen with slight fluid overload.,"No acute cardiopulmonary process is identified. 

    """"""

    return (
        ""No acute ""
        + "" "".join(
            [
                word.capitalize()
                for word in re.findall(
                    r""[A-Z]{2,}(?![a-z])|(?<=\s)[A-Za-z]+(?=\s|$)"",
                    findings,
                    flags=re.IGNORECASE,
                )
            ]
        )
    )"
"The lungs are mildly hyperinflated, as evidenced by flattening of the diaphragms on the lateral view. Diffuse interstitial markings, compatible with known chronic interstitial lung disease, are unchanged.  There is no pleural effusion or evidence of pulmonary edema. There is no focal airspace consolidation worrisome for pneumonia. Mild to moderate cardiomegaly is unchanged. The mediastinal and hilar contours are unremarkable. A coronary artery stent is noted.  There is a levoscoliosis of the thoracic spine.",Stable changes of chronic interstitial lung disease without evidence of a superimposed acute cardiopulmonary process.,"No acute cardiopulmonary process is identified. 

    """"""

    if ""pneumonia"" in findings.lower():
        return ""Acute pneumonitis""
    elif ""edema"" or ""effusion"" not in finding.lower() and ""consolidation""not in findigns.lower(): 
        raise ValueError(""No acute process identified"")
    else:
        pass"
PA and lateral views of the chest provided.   Coronary stent projects over the heart.  A stent projects over the right upper arm.  There is again noted to be coarsened prominent interstitial markings throughout both lungs which could reflect underlying fibrosis versus interstitial pulmonary edema.  No large effusion or pneumothorax.  No convincing evidence for pneumonia.  Cardiomediastinal silhouette is stable.  Bony structures are intact.  A chronic left clavicular midshaft deformity is noted.,Prominent bilateral interstitial opacities could reflect interstitial lung disease versus interstitial edema.  Please correlate clinically.,"""""""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(line) for line in findings.split(""\n"") if line.strip()!= """"]

    most_common_words = Counter([word for word in "" "".join(findings).split("" "") if word.isalpha() and len(word) > 1]).most_common(5)

    impression = f""{' '.join([f'{word} {count}' for (word, count) in most_comon_words])}""

    return impression"
"When compared to prior, there are persistent but potentially slightly less conspicuous bilateral increased interstitial markings throughout the lungs. There is no new consolidation or effusion. The cardiomediastinal silhouette is enlarged but stable. No acute osseous abnormalities identified, compression deformities in the thoracic spine were better seen on prior exam. Old mid left clavicular fracture is again noted.",Perhaps mild interval improvement in the appearance of the increased interstitial markings throughout the lungs which persist.  No new consolidation.,Stable pulmonary fibrosis. Enlarged cardiac silhouette. Fracture of left mid-clavicle.
"PA and lateral views of the chest were provided.  As seen on multiple prior exams, there is generalized chronic interstitial fibrosis manifested by coarsened interstitial markings which is compatible with provided clinical history of ILD.  There is no superimposed consolidation to suggest pneumonia.  No pleural effusion or pneumothorax.  The cardiomediastinal silhouette is stable.  No free air below the right hemidiaphragm.  An old left mid shaft clavicle deformity is again noted.  No acute bony abnormalities.",No superimposed pneumonia in this patient with known ILD.,"Stable findings of chronic fibrotic lung disease, no acute cardiopulmonary process."
"Cardiomegaly is stable.  There is no focal consolidation concerning for pneumonia.  There is no pleural effusion, pneumothorax or pulmonary edema. Scoliosis is again noted.  An old left clavicular deformity is noted.",No evidence of acute cardiopulmonary process.  No evidence of pneumothorax.,No acute cardiopulmonary abnormality. Mild scoliosis.
Generalized chronic interstitial fibrosis and coarse interstitial markings compatible with interstitial lung disease is unchanged.  There is no superimposed consolidation suggestive of pneumonia.  There is no pleural effusion or pneumothorax.  The cardiac and mediastinal silhouettes are stable. There is no free air beneath the right hemidiaphragm.,No superimposed pneumonia in a patient with known chronic interstitial lung disease.,No acute cardiopulmonary process is identified. The findings are consistent with the patient's history of chronic obstructive pulmonary disease.
Diffuse increase in interstitial markings as well as pulmonary vessel engorgement are suggestive of moderate to severe pulmonary edema.  Cardiac silhouette is moderately enlarged.  There is no pleural effusion or pneumothorax.,Moderate to severe pulmonary edema.,Moderate to Severe Pulmonary Edema with Cardiomegaly. No Pleural Effusion.
PA and lateral chest radiographs were obtained.  Diffuse interstitial opacities have progressed since ___.  The hila are indistinct.  There is a new small left pleural effusion.  Moderate cardiomegaly is similar.  Aortic arch calcifications are similar.  There is a stable convex left thoracic scoliosis.  Thoracic vertebral compression fractures and old left clavicle fracture are unchanged.,Moderate to severe interstitial pulmonary edema is worse compared with ___.,"____
    """"""

    return (
        ""Normal chest x-ray""
    )"
The lungs are well expanded and clear.  Coarsened interstitial markings are unchanged.  Cardiomediastinal silhouette is slightly enlarged but unchanged from prior exam.  There is no pneumothorax or pleural effusion.  An old fracture of the left clavicle is noted.,No acute cardiopulmonary process.  Unchanged cardiomediastinal silhouette.,No acute cardiopulmonary abnormality.
"A large-bore central catheter terminates in the expected location of the right atrium, unchanged from prior.  The lungs are clear.  There is no focal consolidation or pneumothorax.  There is no vascular congestion or pleural effusions.  Mediastinal and hilar contours are within normal limits.  The cardiac silhouette is mildly enlarged though unchanged.  Mild indentation of the left trachea at the level of the clavicles is unchanged compared to prior chest CT from ___ and likely reflects an underlying tracheal deformity as no compressive mass lesion is evident on the prior CT.",1.  No acute cardiopulmonary process.  2.  Stable mild cardiomegaly.  3.  Unchanged proximal tracheal deformity suggestive of underlying tracheomalacia.,No acute cardiopulmonary process is identified on this chest x-ray. The patient has a history of chronic obstructive pulmonary disease (COPD) with mild emphysema.
"Frontal and lateral views of the chest.  The lungs are clear of focal consolidation, effusion or pneumothorax.  The heart is enlarged, similar to prior.  Right upper extremity vascular stent is partially visualized.  Multiple thoracic compression deformities are again seen.",No definite acute cardiopulmonary process.,No acute cardiopulmonary abnormality. Enlarged heart.
PA and lateral views of the chest were provided.  The heart remains mildly enlarged.  There is mild interstitial pulmonary edema which is similar to prior exam.  No large effusion is seen.  Eventration of the right hemidiaphragm is noted.  Mediastinal contour is stable.  No focal consolidation suggestive of pneumonia.  The bony structures appear intact.  No free air below the right hemidiaphragm.  Aortic calcifications are again noted.,Mild cardiomegaly and mild interstitial edema.,Mildly enlarged heart with mild pulmonary congestion and right diaphragmatic eventration. No evidence of pneumothorax or pneumomediastinum.
Again noted is eventration of the right hemidiaphragm.  An old left clavicular shaft deformity is unchanged.  There is stable widening of the mediastinum likely secondary to fatty infiltration.  There has been an interval increase in pulmonary vascular engorgement and mild bilateral interstitial edema.  There also may be a subtle increase in bibasilar atelectasis.  There is no evidence of pneumothorax.  The cardiac silhouette is stable.,Interval increase in pulmonary vascular engorgement and mild bilateral interstitial edema.,"""""""
    impression = """"
    for i in range(len(findings)):
        impression += findings[i] + "" ""
    return impression"
"A right-sided large-bore central catheter is again seen, terminating in the right atrium, unchanged from the prior study.  Mild diffuse interstitial opacities are stable, thought to represent chronic hypersensitivity pneumonitis on chest CT from ___.  No focal consolidation, pleural effusion, or evidence of pneumothorax is seen.  The cardiac and mediastinal silhouettes are stable, with the cardiac silhouette mildly enlarged with the aorta calcified and tortuous.  Thoracic scoliosis is again seen.  There is stable compression of a mid-to-lower thoracic vertebral body.  Again seen is mild indentation of the left trachea at the level of the clavicles, unchanged compared to multiple priors since ___.",No significant interval change.,Mildly enlarged heart with aortic tortuosity and calcification. Mild compression fracture of mid-thoracic vertebra. Indentation of left mainstem bronchus. No acute cardiopulmonary abnormality.
"Interstitial prominence has increased compared to prior, suggestive of mild edema.  No focal consolidation or pneumothorax is detected.  Tiny right pleural effusion appears new compared to prior.  Heart and mediastinal contours appear stable with mild cardiomegaly.",New mild interstitial edema and tiny right pleural effusion.,"Mild interstitial lung disease, likely due to chronic obstructive pulmonary disease (COPD) or idiopathic pulmonary fibrosis (IPF). No evidence of acute exacerbation of COPD or acute respiratory distress syndrome (ARDS)."
"There are diffuse bilateral interstitial markings, overall unchanged since ___. This is consistent with chronic lung disease. No new areas of focal consolidation or pleural effusions. No pneumothorax.  Heart size is top normal, stable from prior.  Atherosclerotic calcifications are seen in the coronary arteries, better appreciated on the lateral view.","1. No acute intrathoracic process. Stable bilateral interstitial markings, likely chronic lung disease. 2. Coronary artery calcifications.","____
    """"""

    impression = """"

    return impression


if __name__ == ""__main__"":
    test_cases = [
        {
            ""input"": {
                ""findings"": (
                    ""The patient has a history of chronic obstructive pulmonary disease (COPD) and is currently being treated with inhaled corticosteroids and long-acting bronchodilators. On physical examination, the patient's lungs are clear to auscultation bilaterally, with no rales, rhonchi, or wheezing. The patient is afebrile and his oxygen saturation is 95% on room air.""
                )
            }
        }
    ]

    for test_case in tqdm.tqdm(test_cases):
        output = generate_impression(**test_case[""input""])"
"Again, there is diffuse increase in interstitial markings bilaterally consistent with chronic interstitial lung disease. No new areas of focal consolidation are seen. No pleural effusion or pneumothorax is seen. The cardiac and mediastinal silhouettes are stable.","No acute cardiopulmonary process.  Chronic interstitial lung disease, stable since the prior study.","Chronic Interstitial Lung Disease
    """"""


# In[2]:


import numpy as np
import pandas as pd
pd.set_option('display.max_colwidth', None)
import matplotlib.pyplot as plt
get_ipython().run_line_magic('matplotlib', 'inline')
plt.style.use('fivethirtyeight')
import seaborn as sns
sns.set_style(""darkgrid"")
import warnings
warnings.filterwarnings(""ignore"")
warnings.simplefilter(action='ignore', category=FutureWarning)
from IPython.core.display import display, HTML
display(HTML(""<style>.container { width:95%!important; }</style>""))

import nltk
nltk.download('stopwords')
from nltk.corpus import stopwords
stop_words = set(stopwords.words('english'))

import os
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '2'
import tensorflow as tf
tf.get_logger().warning = lambda *args, **kwargs: None
from tensorflow.keras.preprocessing.text import Tokenizer, text_to_word_sequence, one_hot, pad_sequences
print(tf.__version__)
print(""Num GPUs Available: "", len(tf.config.experimental.list_physical_devices('GPU')))

import gensim.downloader as api
model = api.load(""glove-wiki-gigaword-300"")

import spacy
spacy.cli.download(""en_core_web_sm"")
nlp = spacymodel = nlp(""The quick brown fox jumps over the lazy dog."")
print([token.lemma_ for token in model])

import re
def clean_text(text):
    text = "" "".join([word.lower() for word in text.split("" "") if word not in stop_words])
    sentences = re.split(r' *[\.\?!][\'""\)\]]* *', text)
    return sentences

def"
"The heart is mildly enlarged.  Again seen are widespread reticular opacities, denoting chronic interstitial disease, better seen on the CT examination from ___.  No superimposed consolidation, pneumothorax, or pleural effusion is seen.",No acute intrathoracic process.,Mild cardiomegaly. Widespread reticulonodular opaciities consistent with chronic parenchymal disease.
There still diffuse increase in interstitial markings bilaterally consistent with chronic interstitial lung disease. No new focal consolidation is seen.  No pleural effusion or pneumothorax is seen. The cardiac and mediastinal silhouettes are grossly stable.,No significant interval change. Stable diffuse increase in interstitial markings consistent with chronic lung disease.,"The chest X-ray is stable compared to the previous study. 

    """"""
    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r'[^a-zA-Z0-9\s]', '', text)
        return''.join(word_tokenize(text.lower()))

    findings = [clean_text(line) for line in findings.split('\n') if line!= '']

    sentences = []
    for i in range(len(findings)):
        if i == 0 or findings[i] == '':
            continue
        else:
            sentences.append(''.join([findings[i],'', findings[0]]))

    return sentences[-1]"
"A frontal upright view of the chest was obtained portably.  Since ___, miild interstitial edema persists, but has improved.  There is no focal consolidation, pleural effusion, or pneumothorax.  Heart size is stable. Aortic tortuosity is unchanged.  The left humeral head appears inferiorly subluxed with respect to the glenoid however is not visualized adequately on this film and may partially be positional.",No pneumonia. Improved but persistent mild interstitial edema. Possible subluxation/dislocation of left glenohumeral joint for which dedicated shoulder films can futher characterize.,"""""""
    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(line) for line in findings.split(""\n"") if len(line.strip()) > 0]

    most_common_words = Counter([word for word in "" "".join(findings).split("" "") if word.isalpha()]).most_common(5)

    impression = f""{' '.join([f'{word[0]}'* word[1]]).strip()}""
    return impression"
"The appearance of the lungs is stable. There is diffuse increase in interstitial markings bilaterally, similar to prior, consistent with chronic lung disease. No focal consolidation is seen. No pleural effusion or pneumothorax is seen. The cardiac and mediastinal silhouettes are stable.",No significant interval change.,Chest X-ray shows stable findings of chronic obstructive pulmonary disease (COPD).
"Moderate cardiomegaly is unchanged compared to exams dating back to ___, however appears slightly increased compared to exams from ___. There has been interval increase in moderate pulmonary vascular congestion and diffuse bilateral interstitial lung markings as well as peribronchiolar cuffing concerning for pulmonary edema.  Widening of the superior mediastinum is due to mediastinal lipomatosis and tortuous vessels as seen on the prior CT from ___.  Right-sided Morgagni hernia is unchanged. There is no large pleural effusion or pneumothorax. Compression deformities of the mid thoracic spine are unchanged compared to the prior exam.","Interval increase in moderate cardiomegaly with increased diffuse interstitial markings concerning for pulmonary edema, however an atypical infection is not excluded.","""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal chest x-ray""
    else:
        raise NotImplementedError()"
AP upright and lateral views of the chest provided.  There has been no significant change in the appearance of the chest.  There is persistent interstitial opacity noted diffusely throughout both lungs likely representing interstitial pulmonary edema.  No large effusion or pneumothorax. Cardiomediastinal silhouette appears stable.  No acute osseous abnormalities.  Chronic left mid/shaft clavicle deformity.,No significant change in diffuse interstitial opacity likely reflecting interstitial pulmonary edema.,"""""""
    import re
    from nltk.tokenize import sent_tokenize

    def extract_findings(findings):
        findings = re.sub(r'[^\w\s]', '', findings).lower()
        words = [word for word in findings.split() if len(word) > 2]
        return''.join(words)

    findings_text = ""AP UPRIGHT AND LATERAL VIEWS OF THE CHEST PRODUCED. THERE HAS BEEN NO SIGNIFICANT CHANGE IN THE APPEARANCE. INTERSTITIAL OPACITY NOTED DIFFUSELY THROUGHOUT BOTH LUNGS LIKELY REPRESENTING PULMONARY EDEMA. NO LARGE EFFUSION OR PNEUMOTHORAX. CARDIOMEDIASTINAL SILHOUETTE APPEARS STABLE. CHRONIC LEFT MID/SHAFT CLAVICLE DEFORMITY.""
    impression = """"
    for sentence in sent_tokenizer.findings_text:
        if ""pulmonary"" in sentence:
            impression += sentence + "".""
    return impression"
Cardiac and mediastinal silhouettes are stable. There is stable diffuse prominence of the interstitial markings. No pleural effusion or pneumothorax is seen.,Stable prominence of the interstitial markings bilaterally.  No new focal consolidation seen.,No acute cardiopulmonary abnormality.
"Prominent interstitial markings are again seen, not significantly changed.  There is no overt pulmonary edema.  There is no pleural effusion.  Cardiomediastinal silhouette is stable.  Coronary artery calcifications and/or stents are noted.  Chronic compression deformity in the lower thoracic spine.",Unchanged increased interstitial markings most likely due to chronic interstitial process although component of interstitial edema is possible.,No acute cardiopulmonary abnormality is seen.
"PA and lateral views of the chest are provided.  There is a diffuse reticular nodular pattern throughout both lungs which indicate mild pulmonary edema, though some component of underlying interstitial lung disease is not excluded.  No large effusion or pneumothorax.  A focal eventration of the right hemidiaphragm is noted medially.  The overall cardiomediastinal silhouette is stable.  Bony structures are intact.  Old left clavicular midshaft deformity noted.","Diffuse reticular nodular pattern of the lungs suggests interstitial edema, though underlying chronic lung disease not excluded.",Diffuse reticulonodular opacities bilaterally consistent with pulmonary fibrosis. No acute cardiopulmonary process identified. Focal right diaphragmatic elevation.
"The lungs well expanded.  Coarse reticular interstitial opacities are again noted bilaterally, consistent with chronic interstitial lung disease.  No evidence acute pulmonary edema.  There is no pleural effusion or pneumothorax. The cardiomediastinal silhouette is top-normal in size.  Unchanged tortuous aorta",Chronic interstitial lung disease.  No evidence of acute pulmonary edema.,"Chronic Interstitial Lung Disease, No Acute Pulmonary Edema, Cardiomegaly, Tortuous Aorta"
Frontal and lateral chest radiographs demonstrate stable cardiomegaly and tortuous aorta.  No focal opacification concerning for pneumonia identified.   No pleural effusion or pneumothorax identified.  Multiple thoracic compression deformities are unchanged since ___.  Dense calcifications are noted within the right coronary artery as well as the aorta.,No acute cardiopulmonary process.  Stable cardiomegaly. Stable thoracic compression fractures.,Chronic obstructive pulmonary disease (COPD) and atherosclerotic heart disease.
Single portable view of the chest is compared to previous exam from ___.  Dual-lumen right subclavian central line is again seen with tip at the RA-SVC junction.  Increased interstitial markings seen throughout the lungs are again noted and suggestive of chronic interstitial disease.  Right mid lung opacity has resolved.  The cardiomediastinal silhouette is stable as are the osseous and soft tissue structures.,No acute cardiopulmonary process.  Persistent increased interstitial markings in the lungs compatible with chronic interstitial disease.  Interval resolution of the right mid lung opacity since prior.,No acute cardiopulmonary abnormality is seen on this chest x-ray.
Mild cardiomegaly has been stable compared to exams dated back to at least ___.  Unchanged widening of the superior mediastinum is due to both mediastinal lipomatosis and tortuous vessels as seen on the prior CT from ___.  Re-demonstrated is a right-sided Morgagni hernia.  There is no pleural effusion or pneumothorax.  No new focal consolidations concerning for pneumonia are identified.  Loss of a height of T9 vertebral body is not significantly changed compared to the prior CT from ___. Visualized osseous structures are otherwise unremarkable.,1.  No acute intrathoracic abnormalities identified.  2.  Persistent mild cardiomegaly.,Mildly enlarged heart with stable appearance. Tortuous vasculature. Right-sided lung herniation. No evidence of pneumonia. Stable degenerative changes in the spine.
"Moderate cardiomegaly is stable. Note is made of aortic and coronary artery calcifications, notably in the LAD. Generalized chronic interstitial abnormalities remain unchanged.  No focal pulmonary abnormality is identified to suggest pneumonia. There is no large pleural effusion or pneumothorax.",Unchanged chronic interstitial abnormalities with no acute cardiopulmonary process.,No acute cardiopulmonary process identified.
"There is a chronic diffuse interstitial abnormality, as seen on the CT from ___.  Mild cardiomegaly is unchanged.  Unchanged widening of the superior mediastinum is due to both mediastinal lipomatosis and tortuous vessels, as seen on the CT from ___.  There is a small unchanged right-sided Morgagni hernia. There are no pleural effusions. No pneumothorax. The tracheal configuration is unchanged. Loss of height of a mid thoracic vertebral body is not significantly changed dating back through ___.",1. No acute cardiopulmonary findings. 2. Unchanged mild cardiomegaly.,"""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        if i == 0:
            sentences.append(sentences[-1] + "" "" + cleanings[i])
        elif i < len(cleanings) - 1 and i % 2 == (i+1)%2:  # i.e. when i is odd and the next one is even, or vice-versa
            sentence = "" "".join([cleanings[j] for j in list(range(i-1, i+2)) if j!= i])
            if len(sentence.split()) > 10:
                sentences.extend(sent_tokenize(sentence, language='english'))
                continue
        else: 
            continue
    
    impression = sentences[0]
    return impression"
"A right-sided hemodialysis catheter terminates at the right atrium.  Again seen are reticular interstitial opacities distributed evenly across both lungs, stable over multiple prior radiographs, previously attributed to chronic hypersensitivity pneumonitis on the chest CT from ___.  The cardiac and mediastinal silhouettes are unchanged. The central pulmonary vessels appear more prominent since the ___ study. Superimposed mild edema cannot be excluded. There is no focal consolidation, pleural effusion, or pneumothorax.","Again seen reticular interstitial opacities distributed evenly across both lungs, stable over multiple prior radiographs, previously attributed to chronic hypersensitivity pneumonitis.  Mild superimposed fluid overload cannot be excluded No focal consolidation.","No acute cardiopulmonary abnormality is seen on this chest x-ray. Chronic reticulonodular opaciities are again seen in both lung fields, consistent with prior diagnosis of hypersensitivty pneumoitis. Mild edematous changes are also seen, which may be related to the patient's chronic kidney disease."
"Bilateral interstitial opacities likely represent interstitial edema.  There is no new focal consolidation, pleural effusion, or pneumothorax.  Cardiomegaly persists.  The mediastinal and hilar contours are unchanged.  Leftward scoliosis of the thoracic size stable.","Cardiomegaly and interstitial opacities, likely due to interstitial edema.  If the diagnosis is in doubt clinically, followup radiographs after diuresis may be helpful to exclude the possibility of an atypical interstitial pneumonia.","""""""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    pattern = re.compile(r'\b(a|an|the)\b', re.IGNORECASE)
    def remove_articles(text):
        return pattern.sub('', text)

    words = [remove_articles(word) for word in word_tokenizer.tokenize(findings)]

    sentences = []
    sentence = """"
    for w in words:
        if len(sentence) == 0:
            sentence += w
        elif w[0].isupper():
            if sentence[-1] == ""."":
                sentences.append(sentence[:-1])
                sentence -= 1
            else: 
                if not sentence.endswith("".""):
                    sentence +="" "" +w
                else:
                    if w == ""Impression"" or w==""Impressions"":
                        sentence+=w+"".""
                        sentences+=[sentence]
                        break
                    elif len(w) > 2 and w[-2:].lower() in [""s"",""ed"",""ing"",""ly"",""er"",""est"",""ive"",""ion"",""ize"",""al"",""able"",""ant"",""ary"",""ate"",""ble"",""ent"",""ery"",""ess"",""ful"",""ian"",""ier"",""ies"",""ify"",""ile"",""ily"",""ine"",""ism"",""ist"",""ite"",""ity"",""less"",""ment"",""ness"",""ory"",""ous"",""red"",""ter"",""tial"",""tion"",""ture"",""ure"",""ward"",""wise"",""y"",""d"",""e"",""f"",""g"",""h"",""i"",""j"",""k"",""l"",""m"",""n"",""o"",""p"",""q"",""r"",""u"",""v"",""w"",""x"",""z"",""aa"",""bb"",""cc"",""dd"",""ee"",""ff"",""gg"",""hh"",""ii"",""jj"",""kk"",""ll"","""
"Frontal and lateral chest radiograph demonstrates mildly hypoinflated lungs with bilateral perihilar reticular interstitial opacities consistent with vascular crowding and prominence of interstitial markings bilaterally, similar to previous examination and characterized as interstitial lung disease on CT chest dated ___.  No pleural effusion or pneumothorax. No new focal opacity. Abnormal contour or of the right hemidiaphragm is stable since ___. The cardiomediastinal silhouette is stable.  Limited study of the upper abdomen is unremarkable and visualized osseous structures are notable for diffuse osteopenia and a chronic healed left mid clavicular fracture. Kyphosis is again noted with multiple thoracic compression fractures, unchanged from previous examination.","Stable prominence of interstitial markings bilaterally consistent with interstitial lung disease, best assessed on CT chest dated ___. No evidence of pneumonia.","""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [x.strip() for x in findings.split(""\n"") if len(x.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        sentences[i] = re.sub(r""([A-Z])"", r"" \1"", sentences)

    return sentences"
"There is no definite pleural effusion or pneumothorax.  The enlarged cardiomediastinal silhouette with diffuse interstitial markings is unchanged from prior.  As previously suggested, this may reflect chronic interstitial lung disease with superimposed pulmonary vascular congestion.  A right-side central line terminates in the right atrium.  Although the exam is limited by overlying trauma board, there is no displaced rib fracture.","Unchanged prominent interstitial markings reflecting chronic lung disease with possible superimposed mild pulmonary vascular congestion, although not striking.",Unremarkable chest x-ray.
"Lung volumes are slightly low, causing exaggeration of the heart size and accentuation of the pulmonary vasculature.  Diffuse bilateral interstitial opacities are consistent with mild pulmonary edema.  The heart is mildly enlarged, as before.  The descending thoracic aorta is slightly tortuous, unchanged.  There is a right tunneled IJ catheter ending in the right atrium.  No pleural effusions.  No pneumothorax.  Stable mid-thoracic compression fracture.",1.  Mild interstitial pulmonary edema.  2.  Unchanged mild cardiomegaly.,Mild pulmonary congestion. No acute cardiopulmonary process. Stable thoracolumbar fracture.
"Since the prior examination, interstitial pulmonary edema is resolved.  There are no focal opacities concerning for pneumonia.  There is a trace left pleural effusion.  There is no right effusion.  There is no evidence of pneumothorax.  The cardiomediastinal and hilar contours are stable demonstrating mild tortuosity of thoracic aorta and cardiomegaly.  Pulmonary vascularity is within normal limits.",1.  No evidence of focal pneumonia. 2.  Interval resolution of interstitial pulmonary edema.,No acute cardiopulmonary abnormality.
Frontal and lateral views of the chest were obtained.  There is prominence of the interstitial markings suggesting moderate interstitial edema.  No large pleural effusion is seen.  There is no evidence of pneumothorax.  The cardiac silhouette is enlarged.  The aorta is tortuous.,Enlarged cardiac silhouette and moderate interstitial edema.,"""""""

    impression = """"

    if ""prominence"" in findings:
        impression += ""Prominent interstial markings""

    return impression"
"Heart size remains mildly enlarged with a left ventricular predominance.  The aorta is unfolded and diffusely calcified, with the hilar contours appearing stable.  The lungs are clear without evidence of pulmonary vascular engorgement.  A trace left pleural effusion may be present, but no right pleural effusion is seen.  No pneumothorax is identified.  An inferior vena cava filter is noted within the abdomen.  There are no acute osseous abnormalities.",No radiographic evidence for pneumonia.,"Mild cardiomegaly, aortic atherosclerosis, stable pulmonary vasculature, mild left-sided pleuritis, abdominal IVC filter, unremarkable skeletal survey."
"Since the previous radiograph, there has been continued improvement in the previously described pulmonary edema.  There are moderate bilateral effusions, which are unchanged.  There are small bibasilar hazy opacities consistent with atelectasis.  The cardiomediastinal silhouette is normal.  Cervical hardware is again noted.",1.  Continued improvement in pulmonary edema. 2.  Moderate bilateral pleural effusions.,Moderate bilateral pleural effusion. Atelectasis of the left lower lobe. No acute cardiopulmonary disease.
"Minimally displaced right-sided rib fractures appear similar compared to prior trauma radiographs from ___ and are better characterized on followup CT torso from the same day.  Known left-sided rib fractures are also better characterized on prior CT.  There is no evidence of pneumothorax.  Linear opacities in the lung bases correspond with known subsegmental atelectasis including increased left basilar opacity since the prior radiographs.  The left upper lung appears better aerated, however.  New mild blunting of the bilateral costophrenic angles suggestive of developing small bilateral pleural effusions.  A known manubrium fracture is not well characterized on this single frontal view.  Mediastinal contours appear similar compared to recent prior suggesting probable stability of the known retrosternal hematoma. Hilar and cardiac contours are within normal limits.  Cervical spinal hardware is incompletely imaged.  There has been interval placement of probable epidural catheter in the mid thoracic spine.","1.  Unchanged multiple rib fractures, better characterized on prior CT.  No pneumothorax.  2.  Stable mediastinal contours, though incompletely evaluated manubrial fracture and retrosternal hematoma.  3.  New left basilar opacity suggesting atelectasis.  4.  Suspected very small developing pleural effusions.","No acute intracranial, intrathoracic, or intraabdominal abnormality is identified. 
    """"""


# In[2]:


import numpy as np
import pandas as pd
from sklearn.model_selection import train_test_split
get_ipython().run_line_magic('matplotlib', 'inline')
import matplotlib.pyplot as plt
plt.rcParams['figure.figsize'] = [5, 5]
plt.rc('font', size=14)
plt.style.use('fivethirtyeight')
pd.set_option('display.float_format', lambda x: '%.3f' % x)
import seaborn as sns
sns.set(style=""whitegrid"", font_scale=1.2, color_codes=True, rc={""grid.linestyle"": ""dashed"", ""grid.alpha"": 0.5})
import warnings
warnings.filterwarnings(""ignore"")
import nltk
nltk.download('stopwords')
from nltk.corpus import stopwords
stop_words = set(stopwords.words('english'))
import os
os.environ['KMP_DUPLICATE_CLOSEST=true"
"Again seen, is enlargement of the cardiac silhouette. The hilar and mediastinal contours are stable.  There has been interval improvement of the previously noted pulmonary edema.  No new focal consolidation concerning for infection is identified. There are chronic areas of scarring in the left lower lobe, as well as a stable nodular opacity at the left heart border.  Post-sternotomy wires are seen intact.  The pacemaker defibrillator leads are unchanged in position. There is no pleural effusion or pneumothorax.",Overall interval improvement of the previous noted pulmonary edema.  No pneumonia.,Enlarged cardiac silhoutte. No evidence of acute cardiopulmonary disease.
"AP and lateral views of the chest are compared to previous exam from ___.  The lungs are hyperinflated.  Linear opacity in the left lung base is suggestive of scarring.  There is no evidence of consolidation or effusion.  Cardiac silhouette is enlarged, but stable.  Median sternotomy wires are again noted.  Osseous and soft tissue structures are unremarkable.",Hyperinflation without evidence of acute cardiopulmonary process. No evidence of pulmonary vascular congestion.,Chronic obstructive pulmonary disease (COPD).  No acute cardiopulmonary process.
"The lungs remain hyperinflated, with multiple areas of hyperlucency and scarring in the left lung base.  No focal consolidation.  Chronic pleural thickening with blunting of the left costophrenic angle.  No pneumothorax.  Heart size is borderline enlarged.  Prosthetic aortic valve and median sternotomy wires.  The stomach is newly distended, with internal air-fluid level, and closely abuts the anterior left hemidiaphragm.  Mild acromioclavicular arthropathy.","1.  Chronic obstructive airways disease, without acute process. 2.  Distended stomach.","Chronic obstructive pulmonary disease, emphysematous changes, chronic pleuritis, prosthetic heart valve, recent gastroesophageal reflux disease."
AP portable view of the chest.   The lungs are relatively hyperinflated.  Linear opacities at the left lung base again suggestive of atelectasis versus scarring.  Indistinct pulmonary vascular markings are seen particularly in the left upper and right lower lung.  This could be due to asymmetric mild interstitial edema in the setting of the background of chronic lung disease noting that infection is also possible.  The cardiac silhouette appears slightly enlarged.  Median sternotomy wires again noted.,Asymmetric increased interstitial markings potentially due to edema superimposed on underlying chronic lung changes versus infection.,Chronic obstructive pulmonary disease. Atelectasis. Possible infection. Cardiac enlargement.
An AP upright radiograph of the chest is provided.  There is no significant change from the prior examination.  Moderate cardiomegaly is stable.  Chronic parenchymal opacities which are better demonstrated on the prior chest CT are also unchanged.  There is no evidence of superimposed airspace opacification or pulmonary edema.  There is no pneumothorax or pleural effusion.  Median sternotomy cerclage wires are intact.  The right pectoral AICD and its leads are unchanged.,1.  Stable moderate cardiomegaly 2.  Stable chronic parenchymal changes. 3.  No evidence of acute pulmonary edema.,"No acute cardiopulmonary abnormality is identified. 

    """"""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split(""\n"") if len(f.strip())>0]

    sentences = []
    for sentence in re.split(""[.!?]+"", findings[0]):
        sentence = sentence.strip()
        if not sentence:
            continue
        sentences.append(sentence)

    return "" "".join(sentences)"
"ICD with biventricular pacing lead remains in place.  Stable cardiomegaly accompanied by pulmonary vascular congestion and new interstitial edema, superimposed upon chronic areas of linear scar in the mid and lower lungs.  Lungs are overinflated, suggestive of COPD.  Small pleural effusions are present bilaterally.  Bones are diffusely demineralized.","1.  Congestive heart failure with interstitial edema and small pleural effusions.  2.  Hyperinflated lungs, in keeping with known emphysema on prior CT chest of ___.","Chronic obstructive pulmonary disease (COPD) and congestive heart failure (CHF).
    """"""


# In[2]:


import numpy as np
import pandas as pd
from transformers import AutoTokenizer, AutoModelForSeq2SeqLM, pipeline
model_name = ""t5-small""
tokenizer =AutoTokenizer.from_pretrained(model_name)
generator = pipeline(""text-generation"", model=model_name, tokenizer=tokenizer, device=0)
def generate_summary(findings):
    encoded_input = tokenizer([findings], return_tensors=""pt"", padding=True, truncation=True)
    summary_ids = generator(encoded_input, max_length=100, num_return_sequences=1, do_sample=False)[0][""generated_text""]
    return tokenizer.batch_decode(summary_ids, skip_special_tokens=True)


if __name__ == ""__main__"":
    print(generate_summary(Findings))"
"PA and lateral chest radiographs demonstrate mild hyperinflation, consistent with known emphysema.  Additionally, interstitial edema, small right pleural effusion, and mild cardiomegaly are new when compared to ___.  Left basilar scarring and pleural thickening are chronic.  Median sternotomy wires and aortic prosthesis are unchanged.  There is no focal consolidation or pneumothorax.",CHF with interstitial edema superimposed upon baseline emphysema.,"""""""

    assert len(findings) == 1
    findings = findings[0]

    if ""normal"" in findings.lower():
        return ""Normal Chest Radiograph""
    else:
        raise NotImplementedError()"
"The patient is status post median sternotomy and aortic valve replacement.  Right-sided pacemaker/AICD device is again noted with leads terminating in the right atrium, right ventricle, and the region of the coronary sinus, unchanged.  Enlargement of the cardiac silhouette is moderate, and similar compared to the previous study.  The mediastinal and hilar contours are normal.  There continues to be upper zone vascular redistribution, similar when compared to the previous study compatible with mild pulmonary vascular engorgement.  Lungs remain hyperinflated compatible with COPD.  Linear opacities in the lung bases are compatible with scarring.  Small bilateral pleural effusions are relatively unchanged.  There is no pneumothorax.","Mild pulmonary vascular congestion, similar compared to the previous study with small bilateral pleural effusions.  Scarring within the lung bases.",Moderate cardiomegaly. Mild pulmonary vasculopathy. Chronic obstructive pulmonary disease. No acute cardiopulmonary process.
Chest PA and lateral radiograph demonstrates mild linear atelectasis and associated volume loss in the left lower lung base.   No focal opacifications concerning for pneumonia identified.Stable blunting noted of the left costophrenic angle is likely due to pleural thickening and scarring.  No definite pleural effusions evident.  Interval development of a fracture of the most inferior sternotomy suture.,No acute process.  Interval development sternotomy suture fracture without evidence of dehiscence.,"Stable post-surgical changes. No acute cardiopulmonary process identified.
    
    """"""
    return "" "".join([word for word in text.split() if word not in stopwords])"
Linear opacities within the left lung base appear unchanged compared to recent prior examination and are consistent with plate-like atelectasis or scarring.  Flattened hemidiaphragms and hyperexpansion of the lungs suggest underlying obstructive pulmonary disease.  No confluent consolidation is identified. There is no vascular congestion or pulmonary edema.  A trace left pleural effusion is newly identified.   Cardiomediastinal and hilar contours are within normal limits.  A prosthetic cardiac valve is again noted.  There is no pneumothorax.  Median sternotomy wires appear grossly intact.,1.  Unchanged left lower lobe scarring/plate-like atelectasis. 2.  New trace left pleural effusion.,"No acute cardiopulmonary abnormality is seen. 

    """"""

    import re
    from nltk.tokenize import sent_tokenize, word_tokenize

    def clean_text(text):
        text = re.sub(r""[^a-zA-Z0-9]"", "" "", text)
        return text.lower().strip()

    cleaned_findings = [clean_text(f) for f in findings]

    sentences = []
    for i in range(len(findings)):
        if i == 0:
            sentences.append(sentences[-1] + "" "" + cleanings[i])
        elif i > 1 and i < len(cleanings) - 2:
            
            if ""no acute"" in sentences[-2]:
                sentences.pop()
                continue
            else:
                pass
            
            new_sentence = """"
            for j in reversed(range(1, i+1)):
                if j == i:
                    new_word = "" "".join([cleanings[j], ""is"", ""seen.""])
                    break
                elif j < i and j > i-1:
                    
                    if any([word in clean_words[j] for word in [""acute"", 'abnormality']]):
                        
                        if len(new_sentence.split("" "")) < 3:
                            continue
                        
                        else:  
                            break
                        
                    elif any([""acute"" or ""abnormaity"" not in word.lower() and word.isalpha() 
                            and len(word) >="
"There has been previous median sternotomy and aortic valve replacement.  ICD pacing device remains in place, with unchanged position of leads in the right atrium, right ventricle and an additional lead for biventricular pacing.  Moderate cardiomegaly is stable in appearance, is accompanied by upper zone vascular redistribution and mild interstitial edema. The latter superimposed upon chronic pleural and parenchymal scarring within the mid and lower lungs bilaterally.  Lung volumes are increased, in keeping with history of COPD.  There are questionable small bilateral pleural effusions present.",Congestive heart failure with interstitial edema superimposed upon chronic changes of emphysema and pleural-parenchymal scarring.,"""""""

    assert len(findings) > 0, ""findings cannot be empty""

    findings = [f.strip() for f in findings.split("";"") if len(f.strip())>0]

    sentences = []

    for i in range(len(sentences)):
        sentences[i] = re.sub(r""[^A-Za-z0-9(),!?\'\`]"", r"" "", findings[i]).lower().split()
        # Remove punctuation from each word and split them
    return sentences"
"PA and lateral views of the chest are compared to previous exams from ___ and ___.  Linear opacities at the left greater than right base are suggestive of subsegmental atelectasis.  Mildly indistinct pulmonary vascular markings are seen suggestive of mild failure; however, there is no definite confluent consolidation. Small left pleural effusion is seen.  Cardiac silhouette is enlarged but stable.  Again seen is a prosthetic valve.  Median sternotomy wires are again seen with fracture at the inferior most wire.  Osseous and soft tissue structures are otherwise unremarkable.",Mildly indistinct pulmonary vascular markings suggestive of mild failure without frank pulmonary edema.,Mild congestive heart failure. Fractured sternal wires. Prosthetic aortic valve.
"Frontal and lateral views of the chest.  On the current exam, there is no evidence of confluent consolidation.  Linear opacities at the left lung base most suggestive of scarring.  Icreased interstitial markings are seen compatible chronic underlying lung disease, not significantly changed since ___.  Trace bilateral effusions.  Cardiac silhouette is enlarged and also notable for a prosthetic aortic valve.  No acute osseous abnormality detected.",Chronic lung disease without definite superimposed acute process.,"""""""

    impression = ""Normal chest x-ray""

    return impression"
"Increasing left hemithorax opacity with linear areas of lucency which may represent air bronchograms.  This finding is consistent with edema or developing consolidation.  There are persistent low lung volumes.  Aorta is diffusely tortuous and calcified.  Pacer device with leads terminating within the right atrium, right ventricle of an enlarged heart is unchanged in position.  Endotracheal tube is seen terminating 1.3 cm from the carina.  NG tube is seen entering the stomach and out of view of the radiograph.  Internal jugular catheter is seen in appropriate position within the low SVC.",1) Increasing left-sided opacity which may represent increase in edema or developing consolidation.   2) Endotracheal tube is seen 1.3 cm from carina; it is recommended that tube be withdrawn so that it terminates between 3 and 7 cm from the carina.,"""""""

    import re
    from collections import Counter

    def clean_text(text):
        text = re.sub(r""[^A-Za-z0-9(),!?\'\`]"", "" "", text)
        return text.strip().lower()

    cleaned_findings = [clean_text(f) for f in findings.split('\n') if len(f.strip()) > 0]

    word_counts = Counter([w.lower() for w in''.join(findings).split() if w.isalpha() and len(w) >= 3])

    most_common_words = sorted(word_counts.items(), key=lambda x: x[1], reverse=True)[0:10]
    common_words_set = set([x[0] for x in most_common_words])
    words_to_remove = ['findings', 'impression', ',', '.', '(', ')', ':', ';', '?', '!']
    all_words_to_keep = list(set([word for word in cleaned.findings.split()]).union(common_words))
    final_cleaned_text = []
    for sentence in [s for s in re.split(r'(?<!\w\.\w.)(?<![A-Z][a-z]\.){1}[\.!\?""]+(?!\S)', cleaned.text) if s.strip()!= '']:
        sentence = sentence.strip()
        if sentence[-1] in ['!', '?']:
            sentence"
There is no evidence of focal consolidation.  There is left lower lobe atelectasis.  There is no pleural effusion or pneumothorax.  The cardiac and mediastinal contours are normal.,No acute cardiopulmonary process.,"Atelectasis, Left Lower Lobe
    """"""
    impression = """"
    return impression"
